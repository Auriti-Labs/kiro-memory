---
title: Database Schema
description: SQLite database tables, columns, indexes, FTS5 virtual tables, and migration history.
---

Kiro Memory uses a single SQLite database file at `~/.contextkit/contextkit.db` (configurable via `KIRO_MEMORY_DATA_DIR`). The database uses WAL journal mode for concurrent access between hooks and the worker.

## Configuration

```sql
PRAGMA journal_mode = WAL;
PRAGMA busy_timeout = 5000;    -- wait up to 5s on write lock
PRAGMA synchronous = NORMAL;
PRAGMA foreign_keys = ON;
PRAGMA temp_store = memory;
PRAGMA mmap_size = 268435456;  -- 256MB memory-mapped I/O
PRAGMA cache_size = 10000;     -- 10,000 pages cache
```

## Core Tables

### `observations`

The main data table. Stores everything captured by hooks and the SDK.

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PK | Auto-increment primary key |
| `memory_session_id` | TEXT | Session identifier (from Kiro or generated) |
| `project` | TEXT | Project name (from git repository basename) |
| `type` | TEXT | Observation type (`file-read`, `file-write`, `command`, `research`, `delegation`, `constraint`, `decision`, `heuristic`, `rejected`) |
| `title` | TEXT | Short human-readable title (max 500 chars) |
| `subtitle` | TEXT | Brief contextual descriptor (relative path, program name) |
| `text` | TEXT | Technical content (tool input/output, max 100KB) |
| `narrative` | TEXT | Human-readable description of what happened |
| `facts` | TEXT | Raw data: file path, shell command, URL, or JSON metadata for knowledge types |
| `concepts` | TEXT | Comma-separated concept tags |
| `files_read` | TEXT | Comma-separated file paths that were read |
| `files_modified` | TEXT | Comma-separated file paths that were written/modified |
| `prompt_number` | INTEGER | Position in session prompt sequence |
| `content_hash` | TEXT | SHA256 of `project\|type\|title\|narrative` for deduplication |
| `discovery_tokens` | INTEGER | Estimated token cost of the observation content |
| `last_accessed_epoch` | INTEGER | Unix timestamp of last search access |
| `is_stale` | INTEGER | `0` = fresh, `1` = file modified after observation |
| `auto_category` | TEXT | Keyword-based auto-classification |
| `created_at` | TEXT | ISO 8601 timestamp |
| `created_at_epoch` | INTEGER | Unix millisecond timestamp |

**Indexes:**

```sql
idx_observations_project          (project)
idx_observations_session          (memory_session_id)
idx_observations_type             (type)
idx_observations_epoch            (created_at_epoch)
idx_observations_project_epoch    (project, created_at_epoch DESC)
idx_observations_project_type     (project, type)
idx_observations_hash             (content_hash)
idx_observations_last_accessed    (last_accessed_epoch)
idx_observations_stale            (is_stale)
idx_observations_category         (auto_category)
```

### `sessions`

Tracks agent sessions.

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PK | Auto-increment primary key |
| `content_session_id` | TEXT UNIQUE | Session ID from the editor (e.g., Kiro session ID) |
| `project` | TEXT | Project name |
| `user_prompt` | TEXT | First user prompt of the session |
| `memory_session_id` | TEXT | Internal memory session ID |
| `status` | TEXT | `active` or `completed` |
| `started_at` | TEXT | ISO 8601 start timestamp |
| `started_at_epoch` | INTEGER | Unix ms start timestamp |
| `completed_at` | TEXT | ISO 8601 completion timestamp (null if active) |
| `completed_at_epoch` | INTEGER | Unix ms completion timestamp (null if active) |

**Indexes:** `idx_sessions_project (project)`

### `summaries`

Session summaries generated by the `stop` hook.

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PK | Auto-increment primary key |
| `session_id` | TEXT | Session identifier |
| `project` | TEXT | Project name |
| `request` | TEXT | What was being worked on |
| `investigated` | TEXT | Files read and research performed |
| `learned` | TEXT | Insights from research |
| `completed` | TEXT | Changes made and commands run |
| `next_steps` | TEXT | Suggested continuation |
| `notes` | TEXT | Free-form notes |
| `discovery_tokens` | INTEGER | Estimated token cost |
| `created_at` | TEXT | ISO 8601 timestamp |
| `created_at_epoch` | INTEGER | Unix ms timestamp |

**Indexes:** `idx_summaries_session`, `idx_summaries_project`, `idx_summaries_epoch`, `idx_summaries_project_epoch`

### `prompts`

User prompts recorded by the `userPromptSubmit` hook.

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PK | Auto-increment primary key |
| `content_session_id` | TEXT | Session identifier |
| `project` | TEXT | Project name |
| `prompt_number` | INTEGER | Sequential position in session |
| `prompt_text` | TEXT | Prompt text (secrets redacted) |
| `created_at` | TEXT | ISO 8601 timestamp |
| `created_at_epoch` | INTEGER | Unix ms timestamp |

**Indexes:** `idx_prompts_session`, `idx_prompts_project`, `idx_prompts_project_epoch`

### `checkpoints`

Structured session checkpoints for resume capability.

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PK | Auto-increment primary key |
| `session_id` | INTEGER FK | References `sessions(id)` |
| `project` | TEXT | Project name |
| `task` | TEXT | Main task being worked on |
| `progress` | TEXT | Progress summary |
| `next_steps` | TEXT | Planned next actions |
| `open_questions` | TEXT | Unresolved questions |
| `relevant_files` | TEXT | Comma-separated file paths |
| `context_snapshot` | TEXT | JSON array of last 10 observations |
| `created_at` | TEXT | ISO 8601 timestamp |
| `created_at_epoch` | INTEGER | Unix ms timestamp |

**Indexes:** `idx_checkpoints_session`, `idx_checkpoints_project`, `idx_checkpoints_epoch`

### `project_aliases`

Display name overrides for projects.

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PK | Auto-increment primary key |
| `project_name` | TEXT UNIQUE | Original project name (from git) |
| `display_name` | TEXT | Human-friendly display name |
| `created_at` | TEXT | ISO 8601 creation timestamp |
| `updated_at` | TEXT | ISO 8601 last update timestamp |

### `job_queue`

Async job queue for background processing (embeddings, consolidation, backups).

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PK | Auto-increment primary key |
| `type` | TEXT | Job type identifier |
| `status` | TEXT | `pending`, `running`, `completed`, `failed` |
| `payload` | TEXT | JSON input parameters |
| `result` | TEXT | JSON output on success |
| `error` | TEXT | Error message on failure |
| `retry_count` | INTEGER | Number of retry attempts |
| `max_retries` | INTEGER | Maximum retries (default: 3) |
| `priority` | INTEGER | Higher number = higher priority (default: 0) |
| `created_at` | TEXT | ISO 8601 timestamp |
| `created_at_epoch` | INTEGER | Unix ms timestamp |
| `started_at_epoch` | INTEGER | When job started executing |
| `completed_at_epoch` | INTEGER | When job finished |

**Indexes:** `idx_jobs_status`, `idx_jobs_type`, `idx_jobs_priority (status, priority DESC, created_at_epoch ASC)`

### `schema_versions`

Migration tracking table.

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PK | Auto-increment primary key |
| `version` | INTEGER UNIQUE | Migration version number |
| `applied_at` | TEXT | ISO 8601 timestamp of application |

## Virtual Tables

### `observations_fts`

FTS5 full-text search index over observations. Automatically synchronized via triggers.

```sql
CREATE VIRTUAL TABLE observations_fts USING fts5(
  title, text, narrative, concepts,
  content='observations',
  content_rowid='id'
);
```

Triggers: `observations_ai` (after insert), `observations_ad` (after delete), `observations_au` (after update)

### `observation_embeddings`

Stores vector embeddings for semantic search.

| Column | Type | Description |
|--------|------|-------------|
| `observation_id` | INTEGER PK FK | References `observations(id) ON DELETE CASCADE` |
| `embedding` | BLOB | Raw float32 binary (384 floats = 1536 bytes for MiniLM) |
| `model` | TEXT | Model identifier used to generate the embedding |
| `dimensions` | INTEGER | Number of dimensions in the embedding vector |
| `created_at` | TEXT | ISO 8601 timestamp |

**Index:** `idx_embeddings_model (model)`

## Migration History

Migrations are applied automatically on startup by `MigrationRunner`. The current schema version is **11**.

| Version | Description |
|---------|-------------|
| 1 | Initial schema: sessions, observations, summaries, prompts, pending_messages, base indexes |
| 2 | FTS5 virtual table `observations_fts` + sync triggers + search indexes |
| 3 | `project_aliases` table for display name overrides |
| 4 | `observation_embeddings` table for vector search |
| 5 | `last_accessed_epoch` and `is_stale` columns + indexes |
| 6 | `checkpoints` table for session resume |
| 7 | `content_hash` column for SHA256 deduplication |
| 8 | `discovery_tokens` column on observations and summaries |
| 9 | Composite indexes for pagination: `(project, created_at_epoch DESC)` |
| 10 | `job_queue` table for async background processing |
| 11 | `auto_category` column for keyword-based classification |
