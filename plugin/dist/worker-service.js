import { createRequire } from 'module';const require = createRequire(import.meta.url);
var bs=Object.create;var Ke=Object.defineProperty;var Ss=Object.getOwnPropertyDescriptor;var _s=Object.getOwnPropertyNames;var vs=Object.getPrototypeOf,Ts=Object.prototype.hasOwnProperty;var me=(t,e)=>()=>(t&&(e=t(t=0)),e);var B=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),Xt=(t,e)=>{for(var r in e)Ke(t,r,{get:e[r],enumerable:!0})},Rs=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of _s(e))!Ts.call(t,n)&&n!==r&&Ke(t,n,{get:()=>e[n],enumerable:!(s=Ss(e,n))||s.enumerable});return t};var Os=(t,e,r)=>(r=t!=null?bs(vs(t)):{},Rs(e||!t||!t.__esModule?Ke(r,"default",{value:t,enumerable:!0}):r,t));var ve=B(X=>{"use strict";Object.defineProperty(X,"__esModule",{value:!0});X.isInSubnet=Ks;X.isCorrect=Gs;X.numberToPaddedHex=Zt;X.stringToPaddedHex=Xs;X.testBit=zs;function Ks(t){return this.subnetMask<t.subnetMask?!1:this.mask(t.subnetMask)===t.mask()}function Gs(t){return function(){return this.addressMinusSuffix!==this.correctForm()?!1:this.subnetMask===t&&!this.parsedSubnet?!0:this.parsedSubnet===String(this.subnetMask)}}function Zt(t){return t.toString(16).padStart(2,"0")}function Xs(t){return Zt(parseInt(t,10))}function zs(t,e){let{length:r}=t;if(e>r)return!1;let s=r-e;return t.substring(s,s+1)==="1"}});var Qe=B(M=>{"use strict";Object.defineProperty(M,"__esModule",{value:!0});M.RE_SUBNET_STRING=M.RE_ADDRESS=M.GROUPS=M.BITS=void 0;M.BITS=32;M.GROUPS=4;M.RE_ADDRESS=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/g;M.RE_SUBNET_STRING=/\/\d{1,2}$/});var Re=B(Te=>{"use strict";Object.defineProperty(Te,"__esModule",{value:!0});Te.AddressError=void 0;var Je=class extends Error{constructor(e,r){super(e),this.name="AddressError",this.parseMessage=r}};Te.AddressError=Je});var et=B(P=>{"use strict";var Ys=P&&P.__createBinding||(Object.create?(function(t,e,r,s){s===void 0&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}):(function(t,e,r,s){s===void 0&&(s=r),t[s]=e[r]})),Vs=P&&P.__setModuleDefault||(Object.create?(function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}):function(t,e){t.default=e}),tr=P&&P.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&Ys(e,t,r);return Vs(e,t),e};Object.defineProperty(P,"__esModule",{value:!0});P.Address4=void 0;var J=tr(ve()),k=tr(Qe()),er=Re(),Ze=class t{constructor(e){this.groups=k.GROUPS,this.parsedAddress=[],this.parsedSubnet="",this.subnet="/32",this.subnetMask=32,this.v4=!0,this.isCorrect=J.isCorrect(k.BITS),this.isInSubnet=J.isInSubnet,this.address=e;let r=k.RE_SUBNET_STRING.exec(e);if(r){if(this.parsedSubnet=r[0].replace("/",""),this.subnetMask=parseInt(this.parsedSubnet,10),this.subnet=`/${this.subnetMask}`,this.subnetMask<0||this.subnetMask>k.BITS)throw new er.AddressError("Invalid subnet mask.");e=e.replace(k.RE_SUBNET_STRING,"")}this.addressMinusSuffix=e,this.parsedAddress=this.parse(e)}static isValid(e){try{return new t(e),!0}catch{return!1}}parse(e){let r=e.split(".");if(!e.match(k.RE_ADDRESS))throw new er.AddressError("Invalid IPv4 address.");return r}correctForm(){return this.parsedAddress.map(e=>parseInt(e,10)).join(".")}static fromHex(e){let r=e.replace(/:/g,"").padStart(8,"0"),s=[],n;for(n=0;n<8;n+=2){let o=r.slice(n,n+2);s.push(parseInt(o,16))}return new t(s.join("."))}static fromInteger(e){return t.fromHex(e.toString(16))}static fromArpa(e){let s=e.replace(/(\.in-addr\.arpa)?\.$/,"").split(".").reverse().join(".");return new t(s)}toHex(){return this.parsedAddress.map(e=>J.stringToPaddedHex(e)).join(":")}toArray(){return this.parsedAddress.map(e=>parseInt(e,10))}toGroup6(){let e=[],r;for(r=0;r<k.GROUPS;r+=2)e.push(`${J.stringToPaddedHex(this.parsedAddress[r])}${J.stringToPaddedHex(this.parsedAddress[r+1])}`);return e.join(":")}bigInt(){return BigInt(`0x${this.parsedAddress.map(e=>J.stringToPaddedHex(e)).join("")}`)}_startAddress(){return BigInt(`0b${this.mask()+"0".repeat(k.BITS-this.subnetMask)}`)}startAddress(){return t.fromBigInt(this._startAddress())}startAddressExclusive(){let e=BigInt("1");return t.fromBigInt(this._startAddress()+e)}_endAddress(){return BigInt(`0b${this.mask()+"1".repeat(k.BITS-this.subnetMask)}`)}endAddress(){return t.fromBigInt(this._endAddress())}endAddressExclusive(){let e=BigInt("1");return t.fromBigInt(this._endAddress()-e)}static fromBigInt(e){return t.fromHex(e.toString(16))}mask(e){return e===void 0&&(e=this.subnetMask),this.getBitsBase2(0,e)}getBitsBase2(e,r){return this.binaryZeroPad().slice(e,r)}reverseForm(e){e||(e={});let r=this.correctForm().split(".").reverse().join(".");return e.omitSuffix?r:`${r}.in-addr.arpa.`}isMulticast(){return this.isInSubnet(new t("224.0.0.0/4"))}binaryZeroPad(){return this.bigInt().toString(2).padStart(k.BITS,"0")}groupForV6(){let e=this.parsedAddress;return this.address.replace(k.RE_ADDRESS,`<span class="hover-group group-v4 group-6">${e.slice(0,2).join(".")}</span>.<span class="hover-group group-v4 group-7">${e.slice(2,4).join(".")}</span>`)}};P.Address4=Ze});var tt=B(v=>{"use strict";Object.defineProperty(v,"__esModule",{value:!0});v.RE_URL_WITH_PORT=v.RE_URL=v.RE_ZONE_STRING=v.RE_SUBNET_STRING=v.RE_BAD_ADDRESS=v.RE_BAD_CHARACTERS=v.TYPES=v.SCOPES=v.GROUPS=v.BITS=void 0;v.BITS=128;v.GROUPS=8;v.SCOPES={0:"Reserved",1:"Interface local",2:"Link local",4:"Admin local",5:"Site local",8:"Organization local",14:"Global",15:"Reserved"};v.TYPES={"ff01::1/128":"Multicast (All nodes on this interface)","ff01::2/128":"Multicast (All routers on this interface)","ff02::1/128":"Multicast (All nodes on this link)","ff02::2/128":"Multicast (All routers on this link)","ff05::2/128":"Multicast (All routers in this site)","ff02::5/128":"Multicast (OSPFv3 AllSPF routers)","ff02::6/128":"Multicast (OSPFv3 AllDR routers)","ff02::9/128":"Multicast (RIP routers)","ff02::a/128":"Multicast (EIGRP routers)","ff02::d/128":"Multicast (PIM routers)","ff02::16/128":"Multicast (MLDv2 reports)","ff01::fb/128":"Multicast (mDNSv6)","ff02::fb/128":"Multicast (mDNSv6)","ff05::fb/128":"Multicast (mDNSv6)","ff02::1:2/128":"Multicast (All DHCP servers and relay agents on this link)","ff05::1:2/128":"Multicast (All DHCP servers and relay agents in this site)","ff02::1:3/128":"Multicast (All DHCP servers on this link)","ff05::1:3/128":"Multicast (All DHCP servers in this site)","::/128":"Unspecified","::1/128":"Loopback","ff00::/8":"Multicast","fe80::/10":"Link-local unicast"};v.RE_BAD_CHARACTERS=/([^0-9a-f:/%])/gi;v.RE_BAD_ADDRESS=/([0-9a-f]{5,}|:{3,}|[^:]:$|^:[^:]|\/$)/gi;v.RE_SUBNET_STRING=/\/\d{1,3}(?=%|$)/;v.RE_ZONE_STRING=/%.*$/;v.RE_URL=/^\[{0,1}([0-9a-f:]+)\]{0,1}/;v.RE_URL_WITH_PORT=/\[([0-9a-f:]+)\]:([0-9]{1,5})/});var rt=B(Z=>{"use strict";Object.defineProperty(Z,"__esModule",{value:!0});Z.spanAllZeroes=rr;Z.spanAll=Qs;Z.spanLeadingZeroes=Js;Z.simpleGroup=Zs;function rr(t){return t.replace(/(0+)/g,'<span class="zero">$1</span>')}function Qs(t,e=0){return t.split("").map((s,n)=>`<span class="digit value-${s} position-${n+e}">${rr(s)}</span>`).join("")}function sr(t){return t.replace(/^(0+)/,'<span class="zero">$1</span>')}function Js(t){return t.split(":").map(r=>sr(r)).join(":")}function Zs(t,e=0){return t.split(":").map((s,n)=>/group-v4/.test(s)?s:`<span class="hover-group group-${n+e}">${sr(s)}</span>`)}});var nr=B(x=>{"use strict";var en=x&&x.__createBinding||(Object.create?(function(t,e,r,s){s===void 0&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}):(function(t,e,r,s){s===void 0&&(s=r),t[s]=e[r]})),tn=x&&x.__setModuleDefault||(Object.create?(function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}):function(t,e){t.default=e}),rn=x&&x.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&en(e,t,r);return tn(e,t),e};Object.defineProperty(x,"__esModule",{value:!0});x.ADDRESS_BOUNDARY=void 0;x.groupPossibilities=we;x.padGroup=Oe;x.simpleRegularExpression=nn;x.possibleElisions=on;var sn=rn(tt());function we(t){return`(${t.join("|")})`}function Oe(t){return t.length<4?`0{0,${4-t.length}}${t}`:t}x.ADDRESS_BOUNDARY="[^A-Fa-f0-9:]";function nn(t){let e=[];t.forEach((s,n)=>{parseInt(s,16)===0&&e.push(n)});let r=e.map(s=>t.map((n,o)=>{if(o===s){let i=o===0||o===sn.GROUPS-1?":":"";return we([Oe(n),i])}return Oe(n)}).join(":"));return r.push(t.map(Oe).join(":")),we(r)}function on(t,e,r){let s=e?"":":",n=r?"":":",o=[];!e&&!r&&o.push("::"),e&&r&&o.push(""),(r&&!e||!r&&e)&&o.push(":"),o.push(`${s}(:0{1,4}){1,${t-1}}`),o.push(`(0{1,4}:){1,${t-1}}${n}`),o.push(`(0{1,4}:){${t-1}}0{1,4}`);for(let i=1;i<t-1;i++)for(let a=1;a<t-i;a++)o.push(`(0{1,4}:){${a}}:(0{1,4}:){${t-a-i-1}}0{1,4}`);return we(o)}});var cr=B($=>{"use strict";var an=$&&$.__createBinding||(Object.create?(function(t,e,r,s){s===void 0&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}):(function(t,e,r,s){s===void 0&&(s=r),t[s]=e[r]})),cn=$&&$.__setModuleDefault||(Object.create?(function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}):function(t,e){t.default=e}),Ae=$&&$.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&an(e,t,r);return cn(e,t),e};Object.defineProperty($,"__esModule",{value:!0});$.Address6=void 0;var or=Ae(ve()),st=Ae(Qe()),b=Ae(tt()),nt=Ae(rt()),z=et(),Y=nr(),q=Re(),De=ve();function Ie(t){if(!t)throw new Error("Assertion failed.")}function pn(t){let e=/(\d+)(\d{3})/;for(;e.test(t);)t=t.replace(e,"$1,$2");return t}function un(t){return t=t.replace(/^(0{1,})([1-9]+)$/,'<span class="parse-error">$1</span>$2'),t=t.replace(/^(0{1,})(0)$/,'<span class="parse-error">$1</span>$2'),t}function ln(t,e){let r=[],s=[],n;for(n=0;n<t.length;n++)n<e[0]?r.push(t[n]):n>e[1]&&s.push(t[n]);return r.concat(["compact"]).concat(s)}function ir(t){return parseInt(t,16).toString(16).padStart(4,"0")}function ar(t){return t&255}var ot=class t{constructor(e,r){this.addressMinusSuffix="",this.parsedSubnet="",this.subnet="/128",this.subnetMask=128,this.v4=!1,this.zone="",this.isInSubnet=or.isInSubnet,this.isCorrect=or.isCorrect(b.BITS),r===void 0?this.groups=b.GROUPS:this.groups=r,this.address=e;let s=b.RE_SUBNET_STRING.exec(e);if(s){if(this.parsedSubnet=s[0].replace("/",""),this.subnetMask=parseInt(this.parsedSubnet,10),this.subnet=`/${this.subnetMask}`,Number.isNaN(this.subnetMask)||this.subnetMask<0||this.subnetMask>b.BITS)throw new q.AddressError("Invalid subnet mask.");e=e.replace(b.RE_SUBNET_STRING,"")}else if(/\//.test(e))throw new q.AddressError("Invalid subnet mask.");let n=b.RE_ZONE_STRING.exec(e);n&&(this.zone=n[0],e=e.replace(b.RE_ZONE_STRING,"")),this.addressMinusSuffix=e,this.parsedAddress=this.parse(this.addressMinusSuffix)}static isValid(e){try{return new t(e),!0}catch{return!1}}static fromBigInt(e){let r=e.toString(16).padStart(32,"0"),s=[],n;for(n=0;n<b.GROUPS;n++)s.push(r.slice(n*4,(n+1)*4));return new t(s.join(":"))}static fromURL(e){let r,s=null,n;if(e.indexOf("[")!==-1&&e.indexOf("]:")!==-1){if(n=b.RE_URL_WITH_PORT.exec(e),n===null)return{error:"failed to parse address with port",address:null,port:null};r=n[1],s=n[2]}else if(e.indexOf("/")!==-1){if(e=e.replace(/^[a-z0-9]+:\/\//,""),n=b.RE_URL.exec(e),n===null)return{error:"failed to parse address from URL",address:null,port:null};r=n[1]}else r=e;return s?(s=parseInt(s,10),(s<0||s>65536)&&(s=null)):s=null,{address:new t(r),port:s}}static fromAddress4(e){let r=new z.Address4(e),s=b.BITS-(st.BITS-r.subnetMask);return new t(`::ffff:${r.correctForm()}/${s}`)}static fromArpa(e){let r=e.replace(/(\.ip6\.arpa)?\.$/,""),s=7;if(r.length!==63)throw new q.AddressError("Invalid 'ip6.arpa' form.");let n=r.split(".").reverse();for(let o=s;o>0;o--){let i=o*4;n.splice(i,0,":")}return r=n.join(""),new t(r)}microsoftTranscription(){return`${this.correctForm().replace(/:/g,"-")}.ipv6-literal.net`}mask(e=this.subnetMask){return this.getBitsBase2(0,e)}possibleSubnets(e=128){let r=b.BITS-this.subnetMask,s=Math.abs(e-b.BITS),n=r-s;return n<0?"0":pn((BigInt("2")**BigInt(n)).toString(10))}_startAddress(){return BigInt(`0b${this.mask()+"0".repeat(b.BITS-this.subnetMask)}`)}startAddress(){return t.fromBigInt(this._startAddress())}startAddressExclusive(){let e=BigInt("1");return t.fromBigInt(this._startAddress()+e)}_endAddress(){return BigInt(`0b${this.mask()+"1".repeat(b.BITS-this.subnetMask)}`)}endAddress(){return t.fromBigInt(this._endAddress())}endAddressExclusive(){let e=BigInt("1");return t.fromBigInt(this._endAddress()-e)}getScope(){let e=b.SCOPES[parseInt(this.getBits(12,16).toString(10),10)];return this.getType()==="Global unicast"&&e!=="Link local"&&(e="Global"),e||"Unknown"}getType(){for(let e of Object.keys(b.TYPES))if(this.isInSubnet(new t(e)))return b.TYPES[e];return"Global unicast"}getBits(e,r){return BigInt(`0b${this.getBitsBase2(e,r)}`)}getBitsBase2(e,r){return this.binaryZeroPad().slice(e,r)}getBitsBase16(e,r){let s=r-e;if(s%4!==0)throw new Error("Length of bits to retrieve must be divisible by four");return this.getBits(e,r).toString(16).padStart(s/4,"0")}getBitsPastSubnet(){return this.getBitsBase2(this.subnetMask,b.BITS)}reverseForm(e){e||(e={});let r=Math.floor(this.subnetMask/4),s=this.canonicalForm().replace(/:/g,"").split("").slice(0,r).reverse().join(".");return r>0?e.omitSuffix?s:`${s}.ip6.arpa.`:e.omitSuffix?"":"ip6.arpa."}correctForm(){let e,r=[],s=0,n=[];for(e=0;e<this.parsedAddress.length;e++){let a=parseInt(this.parsedAddress[e],16);a===0&&s++,a!==0&&s>0&&(s>1&&n.push([e-s,e-1]),s=0)}s>1&&n.push([this.parsedAddress.length-s,this.parsedAddress.length-1]);let o=n.map(a=>a[1]-a[0]+1);if(n.length>0){let a=o.indexOf(Math.max(...o));r=ln(this.parsedAddress,n[a])}else r=this.parsedAddress;for(e=0;e<r.length;e++)r[e]!=="compact"&&(r[e]=parseInt(r[e],16).toString(16));let i=r.join(":");return i=i.replace(/^compact$/,"::"),i=i.replace(/(^compact)|(compact$)/,":"),i=i.replace(/compact/,""),i}binaryZeroPad(){return this.bigInt().toString(2).padStart(b.BITS,"0")}parse4in6(e){let r=e.split(":"),n=r.slice(-1)[0].match(st.RE_ADDRESS);if(n){this.parsedAddress4=n[0],this.address4=new z.Address4(this.parsedAddress4);for(let o=0;o<this.address4.groups;o++)if(/^0[0-9]+/.test(this.address4.parsedAddress[o]))throw new q.AddressError("IPv4 addresses can't have leading zeroes.",e.replace(st.RE_ADDRESS,this.address4.parsedAddress.map(un).join(".")));this.v4=!0,r[r.length-1]=this.address4.toGroup6(),e=r.join(":")}return e}parse(e){e=this.parse4in6(e);let r=e.match(b.RE_BAD_CHARACTERS);if(r)throw new q.AddressError(`Bad character${r.length>1?"s":""} detected in address: ${r.join("")}`,e.replace(b.RE_BAD_CHARACTERS,'<span class="parse-error">$1</span>'));let s=e.match(b.RE_BAD_ADDRESS);if(s)throw new q.AddressError(`Address failed regex: ${s.join("")}`,e.replace(b.RE_BAD_ADDRESS,'<span class="parse-error">$1</span>'));let n=[],o=e.split("::");if(o.length===2){let i=o[0].split(":"),a=o[1].split(":");i.length===1&&i[0]===""&&(i=[]),a.length===1&&a[0]===""&&(a=[]);let c=this.groups-(i.length+a.length);if(!c)throw new q.AddressError("Error parsing groups");this.elidedGroups=c,this.elisionBegin=i.length,this.elisionEnd=i.length+this.elidedGroups,n=n.concat(i);for(let p=0;p<c;p++)n.push("0");n=n.concat(a)}else if(o.length===1)n=e.split(":"),this.elidedGroups=0;else throw new q.AddressError("Too many :: groups found");if(n=n.map(i=>parseInt(i,16).toString(16)),n.length!==this.groups)throw new q.AddressError("Incorrect number of groups found");return n}canonicalForm(){return this.parsedAddress.map(ir).join(":")}decimal(){return this.parsedAddress.map(e=>parseInt(e,16).toString(10).padStart(5,"0")).join(":")}bigInt(){return BigInt(`0x${this.parsedAddress.map(ir).join("")}`)}to4(){let e=this.binaryZeroPad().split("");return z.Address4.fromHex(BigInt(`0b${e.slice(96,128).join("")}`).toString(16))}to4in6(){let e=this.to4(),s=new t(this.parsedAddress.slice(0,6).join(":"),6).correctForm(),n="";return/:$/.test(s)||(n=":"),s+n+e.address}inspectTeredo(){let e=this.getBitsBase16(0,32),s=(this.getBits(80,96)^BigInt("0xffff")).toString(),n=z.Address4.fromHex(this.getBitsBase16(32,64)),o=this.getBits(96,128),i=z.Address4.fromHex((o^BigInt("0xffffffff")).toString(16)),a=this.getBitsBase2(64,80),c=(0,De.testBit)(a,15),p=(0,De.testBit)(a,14),l=(0,De.testBit)(a,8),u=(0,De.testBit)(a,9),m=BigInt(`0b${a.slice(2,6)+a.slice(8,16)}`).toString(10);return{prefix:`${e.slice(0,4)}:${e.slice(4,8)}`,server4:n.address,client4:i.address,flags:a,coneNat:c,microsoft:{reserved:p,universalLocal:u,groupIndividual:l,nonce:m},udpPort:s}}inspect6to4(){let e=this.getBitsBase16(0,16),r=z.Address4.fromHex(this.getBitsBase16(16,48));return{prefix:e.slice(0,4),gateway:r.address}}to6to4(){if(!this.is4())return null;let e=["2002",this.getBitsBase16(96,112),this.getBitsBase16(112,128),"","/16"].join(":");return new t(e)}toByteArray(){let e=this.bigInt().toString(16),s=`${"0".repeat(e.length%2)}${e}`,n=[];for(let o=0,i=s.length;o<i;o+=2)n.push(parseInt(s.substring(o,o+2),16));return n}toUnsignedByteArray(){return this.toByteArray().map(ar)}static fromByteArray(e){return this.fromUnsignedByteArray(e.map(ar))}static fromUnsignedByteArray(e){let r=BigInt("256"),s=BigInt("0"),n=BigInt("1");for(let o=e.length-1;o>=0;o--)s+=n*BigInt(e[o].toString(10)),n*=r;return t.fromBigInt(s)}isCanonical(){return this.addressMinusSuffix===this.canonicalForm()}isLinkLocal(){return this.getBitsBase2(0,64)==="1111111010000000000000000000000000000000000000000000000000000000"}isMulticast(){return this.getType()==="Multicast"}is4(){return this.v4}isTeredo(){return this.isInSubnet(new t("2001::/32"))}is6to4(){return this.isInSubnet(new t("2002::/16"))}isLoopback(){return this.getType()==="Loopback"}href(e){return e===void 0?e="":e=`:${e}`,`http://[${this.correctForm()}]${e}/`}link(e){e||(e={}),e.className===void 0&&(e.className=""),e.prefix===void 0&&(e.prefix="/#address="),e.v4===void 0&&(e.v4=!1);let r=this.correctForm;e.v4&&(r=this.to4in6);let s=r.call(this);return e.className?`<a href="${e.prefix}${s}" class="${e.className}">${s}</a>`:`<a href="${e.prefix}${s}">${s}</a>`}group(){if(this.elidedGroups===0)return nt.simpleGroup(this.address).join(":");Ie(typeof this.elidedGroups=="number"),Ie(typeof this.elisionBegin=="number");let e=[],[r,s]=this.address.split("::");r.length?e.push(...nt.simpleGroup(r)):e.push("");let n=["hover-group"];for(let o=this.elisionBegin;o<this.elisionBegin+this.elidedGroups;o++)n.push(`group-${o}`);return e.push(`<span class="${n.join(" ")}"></span>`),s.length?e.push(...nt.simpleGroup(s,this.elisionEnd)):e.push(""),this.is4()&&(Ie(this.address4 instanceof z.Address4),e.pop(),e.push(this.address4.groupForV6())),e.join(":")}regularExpressionString(e=!1){let r=[],s=new t(this.correctForm());if(s.elidedGroups===0)r.push((0,Y.simpleRegularExpression)(s.parsedAddress));else if(s.elidedGroups===b.GROUPS)r.push((0,Y.possibleElisions)(b.GROUPS));else{let n=s.address.split("::");n[0].length&&r.push((0,Y.simpleRegularExpression)(n[0].split(":"))),Ie(typeof s.elidedGroups=="number"),r.push((0,Y.possibleElisions)(s.elidedGroups,n[0].length!==0,n[1].length!==0)),n[1].length&&r.push((0,Y.simpleRegularExpression)(n[1].split(":"))),r=[r.join(":")]}return e||(r=["(?=^|",Y.ADDRESS_BOUNDARY,"|[^\\w\\:])(",...r,")(?=[^\\w\\:]|",Y.ADDRESS_BOUNDARY,"|$)"]),r.join("")}regularExpression(e=!1){return new RegExp(this.regularExpressionString(e),"i")}};$.Address6=ot});var pr=B(A=>{"use strict";var dn=A&&A.__createBinding||(Object.create?(function(t,e,r,s){s===void 0&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}):(function(t,e,r,s){s===void 0&&(s=r),t[s]=e[r]})),mn=A&&A.__setModuleDefault||(Object.create?(function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}):function(t,e){t.default=e}),gn=A&&A.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&dn(e,t,r);return mn(e,t),e};Object.defineProperty(A,"__esModule",{value:!0});A.v6=A.AddressError=A.Address6=A.Address4=void 0;var fn=et();Object.defineProperty(A,"Address4",{enumerable:!0,get:function(){return fn.Address4}});var hn=cr();Object.defineProperty(A,"Address6",{enumerable:!0,get:function(){return hn.Address6}});var yn=Re();Object.defineProperty(A,"AddressError",{enumerable:!0,get:function(){return yn.AddressError}});var En=gn(rt());A.v6={helpers:En}});var Dr={};Xt(Dr,{getObservationsByIds:()=>ne,getProjectStats:()=>Pe,getStaleObservations:()=>Or,getTimeline:()=>oe,markObservationsStale:()=>wr,searchObservationsFTS:()=>re,searchObservationsFTSWithRank:()=>ao,searchObservationsLIKE:()=>Me,searchSummariesFiltered:()=>se});import{existsSync as oo,statSync as io}from"fs";function Tr(t){return t.replace(/[%_\\]/g,"\\$&")}function Rr(t){return(t.length>1e4?t.substring(0,1e4):t).replace(/[""\u0022]/g,"").split(/\s+/).filter(s=>s.length>0).slice(0,100).map(s=>`"${s}"`).join(" ")}function re(t,e,r={}){let s=r.limit||50;try{let n=Rr(e);if(!n)return Me(t,e,r);let o=`
      SELECT o.* FROM observations o
      JOIN observations_fts fts ON o.id = fts.rowid
      WHERE observations_fts MATCH ?
    `,i=[n];return r.project&&(o+=" AND o.project = ?",i.push(r.project)),r.type&&(o+=" AND o.type = ?",i.push(r.type)),r.dateStart&&(o+=" AND o.created_at_epoch >= ?",i.push(r.dateStart)),r.dateEnd&&(o+=" AND o.created_at_epoch <= ?",i.push(r.dateEnd)),o+=` ORDER BY bm25(observations_fts, ${St}) LIMIT ?`,i.push(s),t.query(o).all(...i)}catch{return Me(t,e,r)}}function ao(t,e,r={}){let s=r.limit||50;try{let n=Rr(e);if(!n)return[];let o=`
      SELECT o.*, bm25(observations_fts, ${St}) as fts5_rank FROM observations o
      JOIN observations_fts fts ON o.id = fts.rowid
      WHERE observations_fts MATCH ?
    `,i=[n];return r.project&&(o+=" AND o.project = ?",i.push(r.project)),r.type&&(o+=" AND o.type = ?",i.push(r.type)),r.dateStart&&(o+=" AND o.created_at_epoch >= ?",i.push(r.dateStart)),r.dateEnd&&(o+=" AND o.created_at_epoch <= ?",i.push(r.dateEnd)),o+=` ORDER BY bm25(observations_fts, ${St}) LIMIT ?`,i.push(s),t.query(o).all(...i)}catch{return[]}}function Me(t,e,r={}){let s=r.limit||50,n=`%${Tr(e)}%`,o=`
    SELECT * FROM observations
    WHERE (title LIKE ? ESCAPE '\\' OR text LIKE ? ESCAPE '\\' OR narrative LIKE ? ESCAPE '\\' OR concepts LIKE ? ESCAPE '\\')
  `,i=[n,n,n,n];return r.project&&(o+=" AND project = ?",i.push(r.project)),r.type&&(o+=" AND type = ?",i.push(r.type)),r.dateStart&&(o+=" AND created_at_epoch >= ?",i.push(r.dateStart)),r.dateEnd&&(o+=" AND created_at_epoch <= ?",i.push(r.dateEnd)),o+=" ORDER BY created_at_epoch DESC, id DESC LIMIT ?",i.push(s),t.query(o).all(...i)}function se(t,e,r={}){let s=r.limit||20,n=`%${Tr(e)}%`,o=`
    SELECT * FROM summaries
    WHERE (request LIKE ? ESCAPE '\\' OR learned LIKE ? ESCAPE '\\' OR completed LIKE ? ESCAPE '\\' OR notes LIKE ? ESCAPE '\\' OR next_steps LIKE ? ESCAPE '\\')
  `,i=[n,n,n,n,n];return r.project&&(o+=" AND project = ?",i.push(r.project)),r.dateStart&&(o+=" AND created_at_epoch >= ?",i.push(r.dateStart)),r.dateEnd&&(o+=" AND created_at_epoch <= ?",i.push(r.dateEnd)),o+=" ORDER BY created_at_epoch DESC, id DESC LIMIT ?",i.push(s),t.query(o).all(...i)}function ne(t,e){if(!Array.isArray(e)||e.length===0)return[];let r=e.filter(i=>typeof i=="number"&&Number.isInteger(i)&&i>0).slice(0,500);if(r.length===0)return[];let n=`SELECT * FROM observations WHERE id IN (${r.map(()=>"?").join(",")}) ORDER BY created_at_epoch DESC, id DESC`;return t.query(n).all(...r)}function oe(t,e,r=5,s=5){let o=t.query("SELECT created_at_epoch FROM observations WHERE id = ?").get(e);if(!o)return[];let i=o.created_at_epoch,c=t.query(`
    SELECT id, 'observation' as type, title, text as content, project, created_at, created_at_epoch
    FROM observations
    WHERE (created_at_epoch < ? OR (created_at_epoch = ? AND id < ?))
    ORDER BY created_at_epoch DESC, id DESC
    LIMIT ?
  `).all(i,i,e,r).reverse(),l=t.query(`
    SELECT id, 'observation' as type, title, text as content, project, created_at, created_at_epoch
    FROM observations WHERE id = ?
  `).all(e),m=t.query(`
    SELECT id, 'observation' as type, title, text as content, project, created_at, created_at_epoch
    FROM observations
    WHERE (created_at_epoch > ? OR (created_at_epoch = ? AND id > ?))
    ORDER BY created_at_epoch ASC, id ASC
    LIMIT ?
  `).all(i,i,e,s);return[...c,...l,...m]}function Pe(t,e){let s=t.query(`
    WITH
      obs_stats AS (
        SELECT
          COUNT(*) as count,
          COALESCE(SUM(discovery_tokens), 0) as discovery_tokens,
          COALESCE(SUM(
            CAST((LENGTH(COALESCE(title, '')) + LENGTH(COALESCE(narrative, ''))) / 4 AS INTEGER)
          ), 0) as read_tokens
        FROM observations WHERE project = ?
      ),
      sum_count AS (SELECT COUNT(*) as count FROM summaries WHERE project = ?),
      ses_count AS (SELECT COUNT(*) as count FROM sessions WHERE project = ?),
      prm_count AS (SELECT COUNT(*) as count FROM prompts WHERE project = ?)
    SELECT
      obs_stats.count as observations,
      obs_stats.discovery_tokens,
      obs_stats.read_tokens,
      sum_count.count as summaries,
      ses_count.count as sessions,
      prm_count.count as prompts
    FROM obs_stats, sum_count, ses_count, prm_count
  `).get(e,e,e,e),n=s?.discovery_tokens||0,o=s?.read_tokens||0,i=Math.max(0,n-o);return{observations:s?.observations||0,summaries:s?.summaries||0,sessions:s?.sessions||0,prompts:s?.prompts||0,tokenEconomics:{discoveryTokens:n,readTokens:o,savings:i}}}function Or(t,e){let r=t.query(`
    SELECT * FROM observations
    WHERE project = ? AND files_modified IS NOT NULL AND files_modified != ''
    ORDER BY created_at_epoch DESC, id DESC
    LIMIT 500
  `).all(e),s=[];for(let n of r){if(!n.files_modified)continue;let o=n.files_modified.split(",").map(a=>a.trim()).filter(Boolean),i=!1;for(let a of o)try{if(!oo(a))continue;if(io(a).mtimeMs>n.created_at_epoch){i=!0;break}}catch{}i&&s.push(n)}return s}function wr(t,e,r){if(!Array.isArray(e)||e.length===0)return;let s=e.filter(o=>typeof o=="number"&&Number.isInteger(o)&&o>0).slice(0,500);if(s.length===0)return;let n=s.map(()=>"?").join(",");t.run(`UPDATE observations SET is_stale = ? WHERE id IN (${n})`,[r?1:0,...s])}var St,U=me(()=>{"use strict";St="10.0, 1.0, 5.0, 3.0"});function $e(t){if(!t)return t;let e=t;for(let{pattern:r}of co)r.lastIndex=0,e=e.replace(r,s=>`${s.substring(0,Math.min(4,s.length))}***REDACTED***`);return e}var co,Ir=me(()=>{"use strict";co=[{name:"aws-key",pattern:/(?:AKIA|ABIA|ACCA|ASIA)[A-Z0-9]{16}/g},{name:"jwt",pattern:/eyJ[a-zA-Z0-9_-]{10,}\.eyJ[a-zA-Z0-9_-]{10,}\.[a-zA-Z0-9_-]{10,}/g},{name:"api-key",pattern:/(?:api[_-]?key|apikey|api[_-]?secret)\s*[:=]\s*['"]?([a-zA-Z0-9_\-]{20,})['"]?/gi},{name:"credential",pattern:/(?:password|passwd|pwd|secret|token|auth[_-]?token|access[_-]?token|bearer)\s*[:=]\s*['"]?([^\s'"]{8,})['"]?/gi},{name:"url-credential",pattern:/(?:https?:\/\/)([^:]+):([^@]+)@/g},{name:"private-key",pattern:/-----BEGIN (?:RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----/g},{name:"github-token",pattern:/gh[pousr]_[a-zA-Z0-9]{36,}/g},{name:"slack-token",pattern:/xox[bpoas]-[a-zA-Z0-9-]{10,}/g},{name:"bearer-header",pattern:/\bBearer\s+([a-zA-Z0-9_\-\.]{20,})/g},{name:"hex-secret",pattern:/(?:key|secret|token|password)\s*[:=]\s*['"]?([0-9a-f]{32,})['"]?/gi}]});function Ar(t){let e=new Map,r=[t.title,t.text||"",t.narrative||"",t.concepts||""].join(" ").toLowerCase(),s=[t.filesModified||"",t.filesRead||""].join(",");for(let i of po){let a=0;for(let c of i.keywords)r.includes(c.toLowerCase())&&(a+=i.weight);if(i.types&&i.types.includes(t.type)&&(a+=i.weight*2),i.filePatterns&&s)for(let c of i.filePatterns)c.test(s)&&(a+=i.weight);a>0&&e.set(i.category,(e.get(i.category)||0)+a)}let n="general",o=0;for(let[i,a]of e)a>o&&(o=a,n=i);return n}var po,jr=me(()=>{"use strict";po=[{category:"security",keywords:["security","vulnerability","cve","xss","csrf","injection","sanitize","escape","auth","authentication","authorization","permission","helmet","cors","rate-limit","token","encrypt","decrypt","secret","redact","owasp"],filePatterns:[/security/i,/auth/i,/secrets?\.ts/i],weight:10},{category:"testing",keywords:["test","spec","expect","assert","mock","stub","fixture","coverage","jest","vitest","bun test","unit test","integration test","e2e"],types:["test"],filePatterns:[/\.test\./i,/\.spec\./i,/tests?\//i,/__tests__/i],weight:8},{category:"debugging",keywords:["debug","fix","bug","error","crash","stacktrace","stack trace","exception","breakpoint","investigate","root cause","troubleshoot","diagnose","bisect","regression"],types:["bugfix"],weight:8},{category:"architecture",keywords:["architect","design","pattern","modular","migration","schema","database","api design","abstract","dependency injection","singleton","factory","observer","middleware","pipeline","microservice","monolith"],types:["decision","constraint"],weight:7},{category:"refactoring",keywords:["refactor","rename","extract","inline","move","split","merge","simplify","cleanup","clean up","dead code","consolidate","reorganize","restructure","decouple"],weight:6},{category:"config",keywords:["config","configuration","env","environment","dotenv",".env","settings","tsconfig","eslint","prettier","webpack","vite","esbuild","docker","ci/cd","github actions","deploy","build","bundle","package.json"],filePatterns:[/\.config\./i,/\.env/i,/tsconfig/i,/\.ya?ml/i,/Dockerfile/i,/docker-compose/i],weight:5},{category:"docs",keywords:["document","readme","changelog","jsdoc","comment","explain","guide","tutorial","api doc","openapi","swagger"],types:["docs"],filePatterns:[/\.md$/i,/docs?\//i,/readme/i,/changelog/i],weight:5},{category:"feature-dev",keywords:["feature","implement","add","create","new","endpoint","component","module","service","handler","route","hook","plugin","integration"],types:["feature","file-write"],weight:3}]});var Lr={};Xt(Lr,{consolidateObservations:()=>xr,createObservation:()=>ee,deleteObservation:()=>mo,getObservationsByProject:()=>Fe,getObservationsBySession:()=>lo,isDuplicateObservation:()=>Cr,searchObservations:()=>Nr,updateLastAccessed:()=>go});function uo(t){return t.replace(/[%_\\]/g,"\\$&")}function Cr(t,e,r=3e4){if(!e)return!1;let s=Date.now()-r;return!!t.query("SELECT id FROM observations WHERE content_hash = ? AND created_at_epoch > ? LIMIT 1").get(e,s)}function ee(t,e,r,s,n,o,i,a,c,p,l,u,m,g=null,h=0){let y=new Date,E=$e(n),O=i&&$e(i),S=a&&$e(a),_=Ar({type:s,title:E,text:O,narrative:S,concepts:p,filesModified:u,filesRead:l}),G=t.run(`INSERT INTO observations
     (memory_session_id, project, type, title, subtitle, text, narrative, facts, concepts, files_read, files_modified, prompt_number, created_at, created_at_epoch, content_hash, discovery_tokens, auto_category)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,[e,r,s,E,o,O,S,c,p,l,u,m,y.toISOString(),y.getTime(),g,h,_]);return Number(G.lastInsertRowid)}function lo(t,e){return t.query("SELECT * FROM observations WHERE memory_session_id = ? ORDER BY prompt_number ASC").all(e)}function Fe(t,e,r=100){return t.query("SELECT * FROM observations WHERE project = ? ORDER BY created_at_epoch DESC, id DESC LIMIT ?").all(e,r)}function Nr(t,e,r){let s=r?`SELECT * FROM observations
       WHERE project = ? AND (title LIKE ? ESCAPE '\\' OR text LIKE ? ESCAPE '\\' OR narrative LIKE ? ESCAPE '\\')
       ORDER BY created_at_epoch DESC, id DESC`:`SELECT * FROM observations
       WHERE title LIKE ? ESCAPE '\\' OR text LIKE ? ESCAPE '\\' OR narrative LIKE ? ESCAPE '\\'
       ORDER BY created_at_epoch DESC, id DESC`,n=`%${uo(e)}%`,o=t.query(s);return r?o.all(r,n,n,n):o.all(n,n,n)}function mo(t,e){t.run("DELETE FROM observations WHERE id = ?",[e])}function go(t,e){if(!Array.isArray(e)||e.length===0)return;let r=e.filter(o=>typeof o=="number"&&Number.isInteger(o)&&o>0).slice(0,500);if(r.length===0)return;let s=Date.now(),n=r.map(()=>"?").join(",");t.run(`UPDATE observations SET last_accessed_epoch = ? WHERE id IN (${n})`,[s,...r])}function xr(t,e,r={}){let s=r.minGroupSize||3,n=t.query(`
    SELECT type, files_modified, COUNT(*) as cnt, GROUP_CONCAT(id) as ids
    FROM observations
    WHERE project = ? AND files_modified IS NOT NULL AND files_modified != ''
    GROUP BY type, files_modified
    HAVING cnt >= ?
    ORDER BY cnt DESC
  `).all(e,s);if(n.length===0)return{merged:0,removed:0};if(r.dryRun){let i=0,a=0;for(let c of n){let p=c.ids.split(",").map(Number),l=p.map(()=>"?").join(","),u=t.query(`SELECT COUNT(*) as cnt FROM observations WHERE id IN (${l})`).get(...p)?.cnt||0;u>=s&&(i+=1,a+=u-1)}return{merged:i,removed:a}}return t.transaction(()=>{let i=0,a=0;for(let c of n){let p=c.ids.split(",").map(Number),l=p.map(()=>"?").join(","),u=t.query(`SELECT * FROM observations WHERE id IN (${l}) ORDER BY created_at_epoch DESC, id DESC`).all(...p);if(u.length<s)continue;let m=u[0],g=u.slice(1),h=new Set;m.text&&h.add(m.text);for(let S of g)S.text&&!h.has(S.text)&&h.add(S.text);let y=Array.from(h).join(`
---
`).substring(0,1e5);t.run("UPDATE observations SET text = ?, title = ? WHERE id = ?",[y,`[consolidated x${u.length}] ${m.title}`,m.id]);let E=g.map(S=>S.id),O=E.map(()=>"?").join(",");t.run(`DELETE FROM observations WHERE id IN (${O})`,E),t.run(`DELETE FROM observation_embeddings WHERE observation_id IN (${O})`,E),i+=1,a+=E.length}return{merged:i,removed:a}})()}var ie=me(()=>{"use strict";Ir();jr()});import xt from"express";import No from"cors";var zt=Symbol("dangerouslyDisableDefaultSrc"),ws=new Set(["none","self","strict-dynamic","report-sample","inline-speculation-rules","unsafe-inline","unsafe-eval","unsafe-hashes","wasm-unsafe-eval"]),Yt=()=>({"default-src":["'self'"],"base-uri":["'self'"],"font-src":["'self'","https:","data:"],"form-action":["'self'"],"frame-ancestors":["'self'"],"img-src":["'self'","data:"],"object-src":["'none'"],"script-src":["'self'"],"script-src-attr":["'none'"],"style-src":["'self'","https:","'unsafe-inline'"],"upgrade-insecure-requests":[]}),Ds=t=>t.replace(/[A-Z]/g,e=>"-"+e.toLowerCase()),Vt=(t,e)=>{if(/;|,/.test(e))throw new Error(`Content-Security-Policy received an invalid directive value for ${JSON.stringify(t)}`)},Qt=(t,e)=>{if(ws.has(e)||e.startsWith("nonce-")||e.startsWith("sha256-")||e.startsWith("sha384-")||e.startsWith("sha512-"))throw new Error(`Content-Security-Policy received an invalid directive value for ${JSON.stringify(t)}. ${JSON.stringify(e)} should be quoted`)};function Is(t){let e=Yt(),{useDefaults:r=!0,directives:s=e}=t,n=new Map,o=new Set,i=new Set;for(let a in s){if(!Object.hasOwn(s,a))continue;if(a.length===0||/[^a-zA-Z0-9-]/.test(a))throw new Error(`Content-Security-Policy received an invalid directive name ${JSON.stringify(a)}`);let c=Ds(a);if(o.has(c))throw new Error(`Content-Security-Policy received a duplicate directive ${JSON.stringify(c)}`);o.add(c);let p=s[a],l;if(p===null){if(c==="default-src")throw new Error("Content-Security-Policy needs a default-src but it was set to `null`. If you really want to disable it, set it to `contentSecurityPolicy.dangerouslyDisableDefaultSrc`.");i.add(c);continue}else if(typeof p=="string")l=[p];else if(p)if(p===zt)if(c==="default-src"){i.add("default-src");continue}else throw new Error(`Content-Security-Policy: tried to disable ${JSON.stringify(c)} as if it were default-src; simply omit the key`);else l=p;else throw new Error(`Content-Security-Policy received an invalid directive value for ${JSON.stringify(c)}`);for(let u of l)typeof u=="string"&&(Vt(c,u),Qt(c,u));n.set(c,l)}if(r&&Object.entries(e).forEach(([a,c])=>{!n.has(a)&&!i.has(a)&&n.set(a,c)}),!n.size)throw new Error("Content-Security-Policy has no directives. Either set some or disable the header");if(!n.has("default-src")&&!i.has("default-src"))throw new Error("Content-Security-Policy needs a default-src but none was provided. If you really want to disable it, set it to `contentSecurityPolicy.dangerouslyDisableDefaultSrc`.");return n}function As(t,e,r){let s=[];for(let[n,o]of r){let i="";for(let a of o)if(typeof a=="function"){let c=a(t,e);Qt(n,c),i+=" "+c}else i+=" "+a;i?(Vt(n,i),s.push(`${n}${i}`)):s.push(n)}return s.join(";")}var te=function(e={}){let r=e.reportOnly?"Content-Security-Policy-Report-Only":"Content-Security-Policy",s=Is(e);return function(o,i,a){let c=As(o,i,s);c instanceof Error?a(c):(i.setHeader(r,c),a())}};te.getDefaultDirectives=Yt;te.dangerouslyDisableDefaultSrc=zt;var js=new Set(["require-corp","credentialless","unsafe-none"]);function Cs({policy:t="require-corp"}){if(js.has(t))return t;throw new Error(`Cross-Origin-Embedder-Policy does not support the ${JSON.stringify(t)} policy`)}function Ge(t={}){let e=Cs(t);return function(s,n,o){n.setHeader("Cross-Origin-Embedder-Policy",e),o()}}var Ns=new Set(["same-origin","same-origin-allow-popups","unsafe-none"]);function xs({policy:t="same-origin"}){if(Ns.has(t))return t;throw new Error(`Cross-Origin-Opener-Policy does not support the ${JSON.stringify(t)} policy`)}function Xe(t={}){let e=xs(t);return function(s,n,o){n.setHeader("Cross-Origin-Opener-Policy",e),o()}}var Ls=new Set(["same-origin","same-site","cross-origin"]);function ks({policy:t="same-origin"}){if(Ls.has(t))return t;throw new Error(`Cross-Origin-Resource-Policy does not support the ${JSON.stringify(t)} policy`)}function ze(t={}){let e=ks(t);return function(s,n,o){n.setHeader("Cross-Origin-Resource-Policy",e),o()}}function Ye(){return function(e,r,s){r.setHeader("Origin-Agent-Cluster","?1"),s()}}var Ms=new Set(["no-referrer","no-referrer-when-downgrade","same-origin","origin","strict-origin","origin-when-cross-origin","strict-origin-when-cross-origin","unsafe-url",""]);function Ps({policy:t=["no-referrer"]}){let e=typeof t=="string"?[t]:t;if(e.length===0)throw new Error("Referrer-Policy received no policy tokens");let r=new Set;return e.forEach(s=>{if(Ms.has(s)){if(r.has(s))throw new Error(`Referrer-Policy received a duplicate policy token ${JSON.stringify(s)}`)}else throw new Error(`Referrer-Policy received an unexpected policy token ${JSON.stringify(s)}`);r.add(s)}),e.join(",")}function Ve(t={}){let e=Ps(t);return function(s,n,o){n.setHeader("Referrer-Policy",e),o()}}var $s=365*24*60*60;function Fs(t=$s){if(t>=0&&Number.isFinite(t))return Math.floor(t);throw new Error(`Strict-Transport-Security: ${JSON.stringify(t)} is not a valid value for maxAge. Please choose a positive integer.`)}function Bs(t){if("maxage"in t)throw new Error("Strict-Transport-Security received an unsupported property, `maxage`. Did you mean to pass `maxAge`?");if("includeSubdomains"in t)throw new Error('Strict-Transport-Security middleware should use `includeSubDomains` instead of `includeSubdomains`. (The correct one has an uppercase "D".)');let e=[`max-age=${Fs(t.maxAge)}`];return(t.includeSubDomains===void 0||t.includeSubDomains)&&e.push("includeSubDomains"),t.preload&&e.push("preload"),e.join("; ")}function ge(t={}){let e=Bs(t);return function(s,n,o){n.setHeader("Strict-Transport-Security",e),o()}}function fe(){return function(e,r,s){r.setHeader("X-Content-Type-Options","nosniff"),s()}}function he(t={}){let e=t.allow?"on":"off";return function(s,n,o){n.setHeader("X-DNS-Prefetch-Control",e),o()}}function ye(){return function(e,r,s){r.setHeader("X-Download-Options","noopen"),s()}}function qs({action:t="sameorigin"}){let e=typeof t=="string"?t.toUpperCase():t;switch(e){case"SAME-ORIGIN":return"SAMEORIGIN";case"DENY":case"SAMEORIGIN":return e;default:throw new Error(`X-Frame-Options received an invalid action ${JSON.stringify(t)}`)}}function Ee(t={}){let e=qs(t);return function(s,n,o){n.setHeader("X-Frame-Options",e),o()}}var Hs=new Set(["none","master-only","by-content-type","all"]);function Us({permittedPolicies:t="none"}){if(Hs.has(t))return t;throw new Error(`X-Permitted-Cross-Domain-Policies does not support ${JSON.stringify(t)}`)}function be(t={}){let e=Us(t);return function(s,n,o){n.setHeader("X-Permitted-Cross-Domain-Policies",e),o()}}function Se(){return function(e,r,s){r.removeHeader("X-Powered-By"),s()}}function _e(){return function(e,r,s){r.setHeader("X-XSS-Protection","0"),s()}}function Ws(t){let e=[];switch(t.contentSecurityPolicy){case void 0:case!0:e.push(te());break;case!1:break;default:e.push(te(t.contentSecurityPolicy));break}switch(t.crossOriginEmbedderPolicy){case void 0:case!1:break;case!0:e.push(Ge());break;default:e.push(Ge(t.crossOriginEmbedderPolicy));break}switch(t.crossOriginOpenerPolicy){case void 0:case!0:e.push(Xe());break;case!1:break;default:e.push(Xe(t.crossOriginOpenerPolicy));break}switch(t.crossOriginResourcePolicy){case void 0:case!0:e.push(ze());break;case!1:break;default:e.push(ze(t.crossOriginResourcePolicy));break}switch(t.originAgentCluster){case void 0:case!0:e.push(Ye());break;case!1:break;default:console.warn("Origin-Agent-Cluster does not take options. Remove the property to silence this warning."),e.push(Ye());break}switch(t.referrerPolicy){case void 0:case!0:e.push(Ve());break;case!1:break;default:e.push(Ve(t.referrerPolicy));break}if("strictTransportSecurity"in t&&"hsts"in t)throw new Error("Strict-Transport-Security option was specified twice. Remove `hsts` to silence this warning.");let r=t.strictTransportSecurity??t.hsts;switch(r){case void 0:case!0:e.push(ge());break;case!1:break;default:e.push(ge(r));break}if("xContentTypeOptions"in t&&"noSniff"in t)throw new Error("X-Content-Type-Options option was specified twice. Remove `noSniff` to silence this warning.");switch(t.xContentTypeOptions??t.noSniff){case void 0:case!0:e.push(fe());break;case!1:break;default:console.warn("X-Content-Type-Options does not take options. Remove the property to silence this warning."),e.push(fe());break}if("xDnsPrefetchControl"in t&&"dnsPrefetchControl"in t)throw new Error("X-DNS-Prefetch-Control option was specified twice. Remove `dnsPrefetchControl` to silence this warning.");let n=t.xDnsPrefetchControl??t.dnsPrefetchControl;switch(n){case void 0:case!0:e.push(he());break;case!1:break;default:e.push(he(n));break}if("xDownloadOptions"in t&&"ieNoOpen"in t)throw new Error("X-Download-Options option was specified twice. Remove `ieNoOpen` to silence this warning.");switch(t.xDownloadOptions??t.ieNoOpen){case void 0:case!0:e.push(ye());break;case!1:break;default:console.warn("X-Download-Options does not take options. Remove the property to silence this warning."),e.push(ye());break}if("xFrameOptions"in t&&"frameguard"in t)throw new Error("X-Frame-Options option was specified twice. Remove `frameguard` to silence this warning.");let i=t.xFrameOptions??t.frameguard;switch(i){case void 0:case!0:e.push(Ee());break;case!1:break;default:e.push(Ee(i));break}if("xPermittedCrossDomainPolicies"in t&&"permittedCrossDomainPolicies"in t)throw new Error("X-Permitted-Cross-Domain-Policies option was specified twice. Remove `permittedCrossDomainPolicies` to silence this warning.");let a=t.xPermittedCrossDomainPolicies??t.permittedCrossDomainPolicies;switch(a){case void 0:case!0:e.push(be());break;case!1:break;default:e.push(be(a));break}if("xPoweredBy"in t&&"hidePoweredBy"in t)throw new Error("X-Powered-By option was specified twice. Remove `hidePoweredBy` to silence this warning.");switch(t.xPoweredBy??t.hidePoweredBy){case void 0:case!0:e.push(Se());break;case!1:break;default:console.warn("X-Powered-By does not take options. Remove the property to silence this warning."),e.push(Se());break}if("xXssProtection"in t&&"xssFilter"in t)throw new Error("X-XSS-Protection option was specified twice. Remove `xssFilter` to silence this warning.");switch(t.xXssProtection??t.xssFilter){case void 0:case!0:e.push(_e());break;case!1:break;default:console.warn("X-XSS-Protection does not take options. Remove the property to silence this warning."),e.push(_e());break}return e}var Jt=Object.assign(function(e={}){if(e.constructor?.name==="IncomingMessage")throw new Error("It appears you have done something like `app.use(helmet)`, but it should be `app.use(helmet())`.");let r=Ws(e);return function(n,o,i){let a=0;(function c(p){if(p){i(p);return}let l=r[a];l?(a++,l(n,o,c)):i()})()}},{contentSecurityPolicy:te,crossOriginEmbedderPolicy:Ge,crossOriginOpenerPolicy:Xe,crossOriginResourcePolicy:ze,originAgentCluster:Ye,referrerPolicy:Ve,strictTransportSecurity:ge,xContentTypeOptions:fe,xDnsPrefetchControl:he,xDownloadOptions:ye,xFrameOptions:Ee,xPermittedCrossDomainPolicies:be,xPoweredBy:Se,xXssProtection:_e,dnsPrefetchControl:he,xssFilter:_e,permittedCrossDomainPolicies:be,ieNoOpen:ye,noSniff:fe,frameguard:Ee,hidePoweredBy:Se,hsts:ge});var mr=Os(pr(),1);import{isIPv6 as bn}from"node:net";import{isIPv6 as vn}from"node:net";import{Buffer as Tn}from"node:buffer";import{createHash as Rn}from"node:crypto";import{isIP as Nn}from"node:net";function Sn(t,e=56){return e&&bn(t)?`${new mr.Address6(`${t}/${e}`).startAddress().correctForm()}/${e}`:t}var _n=class{constructor(t){this.validations=t,this.previous=new Map,this.current=new Map,this.localKeys=!0}init(t){this.windowMs=t.windowMs,this.validations?.windowMs(this.windowMs),this.interval&&clearInterval(this.interval),this.interval=setInterval(()=>{this.clearExpired()},this.windowMs),this.interval.unref?.()}async get(t){return this.current.get(t)??this.previous.get(t)}async increment(t){let e=this.getClient(t),r=Date.now();return e.resetTime.getTime()<=r&&this.resetClient(e,r),e.totalHits++,e}async decrement(t){let e=this.getClient(t);e.totalHits>0&&e.totalHits--}async resetKey(t){this.current.delete(t),this.previous.delete(t)}async resetAll(){this.current.clear(),this.previous.clear()}shutdown(){clearInterval(this.interval),this.resetAll()}resetClient(t,e=Date.now()){return t.totalHits=0,t.resetTime.setTime(e+this.windowMs),t}getClient(t){if(this.current.has(t))return this.current.get(t);let e;return this.previous.has(t)?(e=this.previous.get(t),this.previous.delete(t)):(e={totalHits:0,resetTime:new Date},this.resetClient(e)),this.current.set(t,e),e}clearExpired(){this.previous=this.current,this.current=new Map}},ur=["draft-6","draft-7","draft-8"],Ce=(t,e)=>{let r;if(e){let s=Math.ceil((e.getTime()-Date.now())/1e3);r=Math.max(0,s)}else r=Math.ceil(t/1e3);return r},On=t=>{let e=Rn("sha256");e.update(t);let r=e.digest("hex").slice(0,12);return Tn.from(r).toString("base64")},wn=(t,e)=>{t.headersSent||(t.setHeader("X-RateLimit-Limit",e.limit.toString()),t.setHeader("X-RateLimit-Remaining",e.remaining.toString()),e.resetTime instanceof Date&&(t.setHeader("Date",new Date().toUTCString()),t.setHeader("X-RateLimit-Reset",Math.ceil(e.resetTime.getTime()/1e3).toString())))},Dn=(t,e,r)=>{if(t.headersSent)return;let s=Math.ceil(r/1e3),n=Ce(r,e.resetTime);t.setHeader("RateLimit-Policy",`${e.limit};w=${s}`),t.setHeader("RateLimit-Limit",e.limit.toString()),t.setHeader("RateLimit-Remaining",e.remaining.toString()),typeof n=="number"&&t.setHeader("RateLimit-Reset",n.toString())},In=(t,e,r)=>{if(t.headersSent)return;let s=Math.ceil(r/1e3),n=Ce(r,e.resetTime);t.setHeader("RateLimit-Policy",`${e.limit};w=${s}`),t.setHeader("RateLimit",`limit=${e.limit}, remaining=${e.remaining}, reset=${n}`)},An=(t,e,r,s,n)=>{if(t.headersSent)return;let o=Math.ceil(r/1e3),i=Ce(r,e.resetTime),a=On(n),c=`r=${e.remaining}; t=${i}`,p=`q=${e.limit}; w=${o}; pk=:${a}:`;t.append("RateLimit",`"${s}"; ${c}`),t.append("RateLimit-Policy",`"${s}"; ${p}`)},jn=(t,e,r)=>{if(t.headersSent)return;let s=Ce(r,e.resetTime);t.setHeader("Retry-After",s.toString())},Cn=t=>{let e={};for(let r of Object.keys(t)){let s=r;t[s]!==void 0&&(e[s]=t[s])}return e},w=class extends Error{constructor(t,e){let r=`https://express-rate-limit.github.io/${t}/`;super(`${e} See ${r} for more information.`),this.name=this.constructor.name,this.code=t,this.help=r}},je=class extends w{},lr=new Set,dr=new WeakMap,xn={enabled:{default:!0},disable(){for(let t of Object.keys(this.enabled))this.enabled[t]=!1},ip(t){if(t===void 0)throw new w("ERR_ERL_UNDEFINED_IP_ADDRESS","An undefined 'request.ip' was detected. This might indicate a misconfiguration or the connection being destroyed prematurely.");if(!Nn(t))throw new w("ERR_ERL_INVALID_IP_ADDRESS",`An invalid 'request.ip' (${t}) was detected. Consider passing a custom 'keyGenerator' function to the rate limiter.`)},trustProxy(t){if(t.app.get("trust proxy")===!0)throw new w("ERR_ERL_PERMISSIVE_TRUST_PROXY","The Express 'trust proxy' setting is true, which allows anyone to trivially bypass IP-based rate limiting.")},xForwardedForHeader(t){if(t.headers["x-forwarded-for"]&&t.app.get("trust proxy")===!1)throw new w("ERR_ERL_UNEXPECTED_X_FORWARDED_FOR","The 'X-Forwarded-For' header is set but the Express 'trust proxy' setting is false (default). This could indicate a misconfiguration which would prevent express-rate-limit from accurately identifying users.")},forwardedHeader(t){if(t.headers.forwarded&&t.ip===t.socket?.remoteAddress)throw new w("ERR_ERL_FORWARDED_HEADER","The 'Forwarded' header (standardized X-Forwarded-For) is set but currently being ignored. Add a custom keyGenerator to use a value from this header.")},positiveHits(t){if(typeof t!="number"||t<1||t!==Math.round(t))throw new w("ERR_ERL_INVALID_HITS",`The totalHits value returned from the store must be a positive integer, got ${t}`)},unsharedStore(t){if(lr.has(t)){let e=t?.localKeys?"":" (with a unique prefix)";throw new w("ERR_ERL_STORE_REUSE",`A Store instance must not be shared across multiple rate limiters. Create a new instance of ${t.constructor.name}${e} for each limiter instead.`)}lr.add(t)},singleCount(t,e,r){let s=dr.get(t);s||(s=new Map,dr.set(t,s));let n=e.localKeys?e:e.constructor.name,o=s.get(n);o||(o=[],s.set(n,o));let i=`${e.prefix??""}${r}`;if(o.includes(i))throw new w("ERR_ERL_DOUBLE_COUNT",`The hit count for ${r} was incremented more than once for a single request.`);o.push(i)},limit(t){if(t===0)throw new je("WRN_ERL_MAX_ZERO","Setting limit or max to 0 disables rate limiting in express-rate-limit v6 and older, but will cause all requests to be blocked in v7")},draftPolliHeaders(t){if(t)throw new je("WRN_ERL_DEPRECATED_DRAFT_POLLI_HEADERS","The draft_polli_ratelimit_headers configuration option is deprecated and has been removed in express-rate-limit v7, please set standardHeaders: 'draft-6' instead.")},onLimitReached(t){if(t)throw new je("WRN_ERL_DEPRECATED_ON_LIMIT_REACHED","The onLimitReached configuration option is deprecated and has been removed in express-rate-limit v7.")},headersDraftVersion(t){if(typeof t!="string"||!ur.includes(t)){let e=ur.join(", ");throw new w("ERR_ERL_HEADERS_UNSUPPORTED_DRAFT_VERSION",`standardHeaders: only the following versions of the IETF draft specification are supported: ${e}.`)}},headersResetTime(t){if(!t)throw new w("ERR_ERL_HEADERS_NO_RESET","standardHeaders:  'draft-7' requires a 'resetTime', but the store did not provide one. The 'windowMs' value will be used instead, which may cause clients to wait longer than necessary.")},knownOptions(t){if(!t)return;let r=Object.keys({windowMs:!0,limit:!0,message:!0,statusCode:!0,legacyHeaders:!0,standardHeaders:!0,identifier:!0,requestPropertyName:!0,skipFailedRequests:!0,skipSuccessfulRequests:!0,keyGenerator:!0,ipv6Subnet:!0,handler:!0,skip:!0,requestWasSuccessful:!0,store:!0,validate:!0,headers:!0,max:!0,passOnStoreError:!0}).concat("draft_polli_ratelimit_headers","delayAfter","delayMs","maxDelayMs");for(let s of Object.keys(t))if(!r.includes(s))throw new w("ERR_ERL_UNKNOWN_OPTION",`Unexpected configuration option: ${s}`)},validationsConfig(){let t=Object.keys(this).filter(e=>!["enabled","disable"].includes(e));t.push("default");for(let e of Object.keys(this.enabled))if(!t.includes(e))throw new w("ERR_ERL_UNKNOWN_VALIDATION",`options.validate.${e} is not recognized. Supported validate options are: ${t.join(", ")}.`)},creationStack(t){let{stack:e}=new Error("express-rate-limit validation check (set options.validate.creationStack=false to disable)");if(e?.includes("Layer.handle [as handle_request]")||e?.includes("Layer.handleRequest"))throw t.localKeys?new w("ERR_ERL_CREATED_IN_REQUEST_HANDLER","express-rate-limit instance should be created at app initialization, not when responding to a request."):new w("ERR_ERL_CREATED_IN_REQUEST_HANDLER","express-rate-limit instance should *usually* be created at app initialization, not when responding to a request.")},ipv6Subnet(t){if(t!==!1&&(!Number.isInteger(t)||t<32||t>64))throw new w("ERR_ERL_IPV6_SUBNET",`Unexpected ipv6Subnet value: ${t}. Expected an integer between 32 and 64 (usually 48-64).`)},ipv6SubnetOrKeyGenerator(t){if(t.ipv6Subnet!==void 0&&t.keyGenerator)throw new w("ERR_ERL_IPV6SUBNET_OR_KEYGENERATOR","Incompatible options: the 'ipv6Subnet' option is ignored when a custom 'keyGenerator' function is also set.")},keyGeneratorIpFallback(t){if(!t)return;let e=t.toString();if((e.includes("req.ip")||e.includes("request.ip"))&&!e.includes("ipKeyGenerator"))throw new w("ERR_ERL_KEY_GEN_IPV6","Custom keyGenerator appears to use request IP without calling the ipKeyGenerator helper function for IPv6 addresses. This could allow IPv6 users to bypass limits.")},windowMs(t){if(typeof t!="number"||Number.isNaN(t)||t<1||t>2147483647)throw new w("ERR_ERL_WINDOW_MS",`Invalid windowMs value: ${t}${typeof t!="number"?` (${typeof t})`:""}, must be a number between 1 and 2147483647 when using the default MemoryStore`)}},Ln=t=>{let e;typeof t=="boolean"?e={default:t}:e={default:!0,...t};let r={enabled:e};for(let[s,n]of Object.entries(xn))typeof n=="function"&&(r[s]=(...o)=>{if(e[s]??e.default)try{n.apply(r,o)}catch(i){i instanceof je?console.warn(i):console.error(i)}});return r},kn=t=>typeof t.incr=="function"&&typeof t.increment!="function",Mn=t=>{if(!kn(t))return t;let e=t;class r{async increment(n){return new Promise((o,i)=>{e.incr(n,(a,c,p)=>{a&&i(a),o({totalHits:c,resetTime:p})})})}async decrement(n){return e.decrement(n)}async resetKey(n){return e.resetKey(n)}async resetAll(){if(typeof e.resetAll=="function")return e.resetAll()}}return new r},Pn=t=>{let{validations:e,...r}=t;return{...r,validate:e.enabled}},$n=t=>{let e=Cn(t),r=Ln(e?.validate??!0);r.validationsConfig(),r.knownOptions(t),r.draftPolliHeaders(e.draft_polli_ratelimit_headers),r.onLimitReached(e.onLimitReached),e.ipv6Subnet!==void 0&&typeof e.ipv6Subnet!="function"&&r.ipv6Subnet(e.ipv6Subnet),r.keyGeneratorIpFallback(e.keyGenerator),r.ipv6SubnetOrKeyGenerator(e);let s=e.standardHeaders??!1;s===!0&&(s="draft-6");let n={windowMs:60*1e3,limit:t.max??5,message:"Too many requests, please try again later.",statusCode:429,legacyHeaders:t.headers??!0,identifier(o,i){let a="",c=n.requestPropertyName,{limit:p}=o[c],l=n.windowMs/1e3,u=n.windowMs/(1e3*60),m=n.windowMs/(1e3*60*60),g=n.windowMs/(1e3*60*60*24);return l<60?a=`${l}sec`:u<60?a=`${u}min`:m<24?a=`${m}hr${m>1?"s":""}`:a=`${g}day${g>1?"s":""}`,`${p}-in-${a}`},requestPropertyName:"rateLimit",skipFailedRequests:!1,skipSuccessfulRequests:!1,requestWasSuccessful:(o,i)=>i.statusCode<400,skip:(o,i)=>!1,async keyGenerator(o,i){r.ip(o.ip),r.trustProxy(o),r.xForwardedForHeader(o),r.forwardedHeader(o);let a=o.ip,c=56;return vn(a)&&(c=typeof n.ipv6Subnet=="function"?await n.ipv6Subnet(o,i):n.ipv6Subnet,typeof n.ipv6Subnet=="function"&&r.ipv6Subnet(c)),Sn(a,c)},ipv6Subnet:56,async handler(o,i,a,c){i.status(n.statusCode);let p=typeof n.message=="function"?await n.message(o,i):n.message;i.writableEnded||i.send(p)},passOnStoreError:!1,...e,standardHeaders:s,store:Mn(e.store??new _n(r)),validations:r};if(typeof n.store.increment!="function"||typeof n.store.decrement!="function"||typeof n.store.resetKey!="function"||n.store.resetAll!==void 0&&typeof n.store.resetAll!="function"||n.store.init!==void 0&&typeof n.store.init!="function")throw new TypeError("An invalid store was passed. Please ensure that the store is a class that implements the `Store` interface.");return n},Fn=t=>async(e,r,s)=>{try{await Promise.resolve(t(e,r,s)).catch(s)}catch(n){s(n)}},Bn=t=>{let e=$n(t??{}),r=Pn(e);e.validations.creationStack(e.store),e.validations.unsharedStore(e.store),typeof e.store.init=="function"&&e.store.init(r);let s=Fn(async(o,i,a)=>{if(await e.skip(o,i)){a();return}let p=o,l=await e.keyGenerator(o,i),u=0,m;try{let E=await e.store.increment(l);u=E.totalHits,m=E.resetTime}catch(E){if(e.passOnStoreError){console.error("express-rate-limit: error from store, allowing request without rate-limiting.",E),a();return}throw E}e.validations.positiveHits(u),e.validations.singleCount(o,e.store,l);let h=await(typeof e.limit=="function"?e.limit(o,i):e.limit);e.validations.limit(h);let y={limit:h,used:u,remaining:Math.max(h-u,0),resetTime:m,key:l};if(Object.defineProperty(y,"current",{configurable:!1,enumerable:!1,value:u}),p[e.requestPropertyName]=y,e.legacyHeaders&&!i.headersSent&&wn(i,y),e.standardHeaders&&!i.headersSent)switch(e.standardHeaders){case"draft-6":{Dn(i,y,e.windowMs);break}case"draft-7":{e.validations.headersResetTime(y.resetTime),In(i,y,e.windowMs);break}case"draft-8":{let O=await(typeof e.identifier=="function"?e.identifier(o,i):e.identifier);e.validations.headersResetTime(y.resetTime),An(i,y,e.windowMs,O,l);break}default:{e.validations.headersDraftVersion(e.standardHeaders);break}}if(e.skipFailedRequests||e.skipSuccessfulRequests){let E=!1,O=async()=>{E||(await e.store.decrement(l),E=!0)};e.skipFailedRequests&&(i.on("finish",async()=>{await e.requestWasSuccessful(o,i)||await O()}),i.on("close",async()=>{i.writableEnded||await O()}),i.on("error",async()=>{await O()})),e.skipSuccessfulRequests&&i.on("finish",async()=>{await e.requestWasSuccessful(o,i)&&await O()})}if(e.validations.disable(),u>h){(e.legacyHeaders||e.standardHeaders)&&jn(i,y,e.windowMs),e.handler(o,i,a,r);return}a()}),n=()=>{throw new Error("The current store does not support the get/getKey method")};return s.resetKey=e.store.resetKey.bind(e.store),s.getKey=typeof e.store.get=="function"?e.store.get.bind(e.store):n,s},Ne=Bn;import xo from"crypto";import{join as Lt,dirname as Lo}from"path";import{existsSync as Ue,mkdirSync as ko,writeFileSync as ps,unlinkSync as cs,chmodSync as Mo}from"fs";import{fileURLToPath as Po}from"url";import qn from"better-sqlite3";var xe=class{_db;_stmtCache=new Map;constructor(e,r){this._db=new qn(e,{readonly:r?.readwrite===!1})}run(e,r){let s=this._db.prepare(e);return r?s.run(...r):s.run()}query(e){let r=this._stmtCache.get(e);return r||(r=new it(this._db,e),this._stmtCache.set(e,r)),r}transaction(e){return this._db.transaction(e)}close(){this._stmtCache.clear(),this._db.close()}},it=class{_stmt;constructor(e,r){this._stmt=e.prepare(r)}all(...e){return e.length>0?this._stmt.all(...e):this._stmt.all()}get(...e){return e.length>0?this._stmt.get(...e):this._stmt.get()}run(...e){return e.length>0?this._stmt.run(...e):this._stmt.run()}};import{join as j,dirname as Gn,basename as mi}from"path";import{homedir as ct}from"os";import{existsSync as Er,mkdirSync as Xn}from"fs";import{fileURLToPath as zn}from"url";import{appendFileSync as Hn,existsSync as gr,mkdirSync as Un,readFileSync as Wn}from"fs";import{join as Le}from"path";import{homedir as Kn}from"os";var ke=(o=>(o[o.DEBUG=0]="DEBUG",o[o.INFO=1]="INFO",o[o.WARN=2]="WARN",o[o.ERROR=3]="ERROR",o[o.SILENT=4]="SILENT",o))(ke||{}),fr=Le(Kn(),".contextkit"),at=class{level=null;useColor;logFilePath=null;logFileInitialized=!1;constructor(){this.useColor=process.stdout.isTTY??!1}ensureLogFileInitialized(){if(!this.logFileInitialized){this.logFileInitialized=!0;try{let e=Le(fr,"logs");gr(e)||Un(e,{recursive:!0});let r=new Date().toISOString().split("T")[0];this.logFilePath=Le(e,`kiro-memory-${r}.log`)}catch(e){console.error("[LOGGER] Failed to initialize log file:",e),this.logFilePath=null}}}getLevel(){if(this.level===null)try{let e=Le(fr,"settings.json");if(gr(e)){let r=Wn(e,"utf-8"),s=JSON.parse(r),n=(s.KIRO_MEMORY_LOG_LEVEL||s.CONTEXTKIT_LOG_LEVEL||"INFO").toUpperCase();this.level=ke[n]??1}else this.level=1}catch{this.level=1}return this.level}correlationId(e,r){return`obs-${e}-${r}`}sessionId(e){return`session-${e}`}formatData(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="object"){if(e instanceof Error)return this.getLevel()===0?`${e.message}
${e.stack}`:e.message;if(Array.isArray(e))return`[${e.length} items]`;let r=Object.keys(e);return r.length===0?"{}":r.length<=3?JSON.stringify(e):`{${r.length} keys: ${r.slice(0,3).join(", ")}...}`}return String(e)}formatTimestamp(e){let r=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),o=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0"),c=String(e.getMilliseconds()).padStart(3,"0");return`${r}-${s}-${n} ${o}:${i}:${a}.${c}`}log(e,r,s,n,o){if(e<this.getLevel())return;this.ensureLogFileInitialized();let i=this.formatTimestamp(new Date),a=ke[e].padEnd(5),c=r.padEnd(6),p="";n?.correlationId?p=`[${n.correlationId}] `:n?.sessionId&&(p=`[session-${n.sessionId}] `);let l="";o!=null&&(o instanceof Error?l=this.getLevel()===0?`
${o.message}
${o.stack}`:` ${o.message}`:this.getLevel()===0&&typeof o=="object"?l=`
`+JSON.stringify(o,null,2):l=" "+this.formatData(o));let u="";if(n){let{sessionId:g,memorySessionId:h,correlationId:y,...E}=n;Object.keys(E).length>0&&(u=` {${Object.entries(E).map(([S,_])=>`${S}=${_}`).join(", ")}}`)}let m=`[${i}] [${a}] [${c}] ${p}${s}${u}${l}`;if(this.logFilePath)try{Hn(this.logFilePath,m+`
`,"utf8")}catch(g){process.stderr.write(`[LOGGER] Failed to write to log file: ${g}
`)}else process.stderr.write(m+`
`)}debug(e,r,s,n){this.log(0,e,r,s,n)}info(e,r,s,n){this.log(1,e,r,s,n)}warn(e,r,s,n){this.log(2,e,r,s,n)}error(e,r,s,n){this.log(3,e,r,s,n)}dataIn(e,r,s,n){this.info(e,`\u2192 ${r}`,s,n)}dataOut(e,r,s,n){this.info(e,`\u2190 ${r}`,s,n)}success(e,r,s,n){this.info(e,`\u2713 ${r}`,s,n)}failure(e,r,s,n){this.error(e,`\u2717 ${r}`,s,n)}timing(e,r,s,n){this.info(e,`\u23F1 ${r}`,n,{duration:`${s}ms`})}happyPathError(e,r,s,n,o=""){let p=((new Error().stack||"").split(`
`)[2]||"").match(/at\s+(?:.*\s+)?\(?([^:]+):(\d+):(\d+)\)?/),l=p?`${p[1].split("/").pop()}:${p[2]}`:"unknown",u={...s,location:l};return this.warn(e,`[HAPPY-PATH] ${r}`,u,n),o}},d=new at;function Yn(){return typeof __dirname<"u"?__dirname:Gn(zn(import.meta.url))}var Ei=Yn(),hr=j(ct(),".contextkit"),Vn=Er(hr)?hr:j(ct(),".kiro-memory"),D=process.env.KIRO_MEMORY_DATA_DIR||process.env.CONTEXTKIT_DATA_DIR||Vn,pt=process.env.KIRO_CONFIG_DIR||j(ct(),".kiro"),bi=j(pt,"plugins","kiro-memory"),Si=j(D,"archives"),_i=j(D,"logs"),vi=j(D,"trash"),Ti=j(D,"backups"),Ri=j(D,"modes"),Oi=j(D,"settings.json"),yr=j(D,"contextkit.db"),br=Er(yr)?yr:j(D,"kiro-memory.db"),wi=j(D,"vector-db"),Di=j(D,"observer-sessions"),Ii=j(pt,"settings.json"),Ai=j(pt,"context.md");function Sr(t){Xn(t,{recursive:!0})}var Qn=256*1024*1024,Jn=1e4,V=class{_db;get db(){return this._db}constructor(e=br,r=!1){e!==":memory:"&&Sr(D),this._db=new xe(e,{create:!0,readwrite:!0}),this._db.run("PRAGMA journal_mode = WAL"),this._db.run("PRAGMA busy_timeout = 5000"),this._db.run("PRAGMA synchronous = NORMAL"),this._db.run("PRAGMA foreign_keys = ON"),this._db.run("PRAGMA temp_store = memory"),this._db.run(`PRAGMA mmap_size = ${Qn}`),this._db.run(`PRAGMA cache_size = ${Jn}`),r||new ut(this._db).runAllMigrations()}query(e){return this._db.query(e)}run(e,r){return this._db.run(e,r)}withTransaction(e){return this._db.transaction(e)(this._db)}close(){this._db.close()}},ut=class{db;constructor(e){this.db=e}runAllMigrations(){this.db.run(`
      CREATE TABLE IF NOT EXISTS schema_versions (
        id INTEGER PRIMARY KEY,
        version INTEGER UNIQUE NOT NULL,
        applied_at TEXT NOT NULL
      )
    `);let s=this.db.query("SELECT MAX(version) as version FROM schema_versions").get()?.version||0,n=this.getMigrations();for(let o of n)o.version>s&&(d.info("DB",`Applying migration ${o.version}`),this.db.transaction(()=>{o.up(this.db),this.db.query("INSERT INTO schema_versions (version, applied_at) VALUES (?, ?)").run(o.version,new Date().toISOString())})(),d.info("DB",`Migration ${o.version} applied successfully`))}getMigrations(){return[{version:1,up:e=>{e.run(`
            CREATE TABLE IF NOT EXISTS sessions (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              content_session_id TEXT NOT NULL UNIQUE,
              project TEXT NOT NULL,
              user_prompt TEXT NOT NULL,
              memory_session_id TEXT,
              status TEXT DEFAULT 'active',
              started_at TEXT NOT NULL,
              started_at_epoch INTEGER NOT NULL,
              completed_at TEXT,
              completed_at_epoch INTEGER
            )
          `),e.run(`
            CREATE TABLE IF NOT EXISTS observations (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              memory_session_id TEXT NOT NULL,
              project TEXT NOT NULL,
              type TEXT NOT NULL,
              title TEXT NOT NULL,
              subtitle TEXT,
              text TEXT,
              narrative TEXT,
              facts TEXT,
              concepts TEXT,
              files_read TEXT,
              files_modified TEXT,
              prompt_number INTEGER NOT NULL,
              created_at TEXT NOT NULL,
              created_at_epoch INTEGER NOT NULL
            )
          `),e.run(`
            CREATE TABLE IF NOT EXISTS summaries (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              session_id TEXT NOT NULL,
              project TEXT NOT NULL,
              request TEXT,
              investigated TEXT,
              learned TEXT,
              completed TEXT,
              next_steps TEXT,
              notes TEXT,
              created_at TEXT NOT NULL,
              created_at_epoch INTEGER NOT NULL
            )
          `),e.run(`
            CREATE TABLE IF NOT EXISTS prompts (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              content_session_id TEXT NOT NULL,
              project TEXT NOT NULL,
              prompt_number INTEGER NOT NULL,
              prompt_text TEXT NOT NULL,
              created_at TEXT NOT NULL,
              created_at_epoch INTEGER NOT NULL
            )
          `),e.run(`
            CREATE TABLE IF NOT EXISTS pending_messages (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              content_session_id TEXT NOT NULL,
              type TEXT NOT NULL,
              data TEXT NOT NULL,
              created_at TEXT NOT NULL,
              created_at_epoch INTEGER NOT NULL
            )
          `),e.run("CREATE INDEX IF NOT EXISTS idx_sessions_project ON sessions(project)"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_project ON observations(project)"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_session ON observations(memory_session_id)"),e.run("CREATE INDEX IF NOT EXISTS idx_summaries_session ON summaries(session_id)"),e.run("CREATE INDEX IF NOT EXISTS idx_prompts_session ON prompts(content_session_id)")}},{version:2,up:e=>{e.run(`
            CREATE VIRTUAL TABLE IF NOT EXISTS observations_fts USING fts5(
              title, text, narrative, concepts,
              content='observations',
              content_rowid='id'
            )
          `),e.run(`
            CREATE TRIGGER IF NOT EXISTS observations_ai AFTER INSERT ON observations BEGIN
              INSERT INTO observations_fts(rowid, title, text, narrative, concepts)
              VALUES (new.id, new.title, new.text, new.narrative, new.concepts);
            END
          `),e.run(`
            CREATE TRIGGER IF NOT EXISTS observations_ad AFTER DELETE ON observations BEGIN
              INSERT INTO observations_fts(observations_fts, rowid, title, text, narrative, concepts)
              VALUES ('delete', old.id, old.title, old.text, old.narrative, old.concepts);
            END
          `),e.run(`
            CREATE TRIGGER IF NOT EXISTS observations_au AFTER UPDATE ON observations BEGIN
              INSERT INTO observations_fts(observations_fts, rowid, title, text, narrative, concepts)
              VALUES ('delete', old.id, old.title, old.text, old.narrative, old.concepts);
              INSERT INTO observations_fts(rowid, title, text, narrative, concepts)
              VALUES (new.id, new.title, new.text, new.narrative, new.concepts);
            END
          `),e.run(`
            INSERT INTO observations_fts(rowid, title, text, narrative, concepts)
            SELECT id, title, text, narrative, concepts FROM observations
          `),e.run("CREATE INDEX IF NOT EXISTS idx_observations_type ON observations(type)"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_epoch ON observations(created_at_epoch)"),e.run("CREATE INDEX IF NOT EXISTS idx_summaries_project ON summaries(project)"),e.run("CREATE INDEX IF NOT EXISTS idx_summaries_epoch ON summaries(created_at_epoch)"),e.run("CREATE INDEX IF NOT EXISTS idx_prompts_project ON prompts(project)")}},{version:3,up:e=>{e.run(`
            CREATE TABLE IF NOT EXISTS project_aliases (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              project_name TEXT NOT NULL UNIQUE,
              display_name TEXT NOT NULL,
              created_at TEXT NOT NULL,
              updated_at TEXT NOT NULL
            )
          `),e.run("CREATE UNIQUE INDEX IF NOT EXISTS idx_project_aliases_name ON project_aliases(project_name)")}},{version:4,up:e=>{e.run(`
            CREATE TABLE IF NOT EXISTS observation_embeddings (
              observation_id INTEGER PRIMARY KEY,
              embedding BLOB NOT NULL,
              model TEXT NOT NULL,
              dimensions INTEGER NOT NULL,
              created_at TEXT NOT NULL,
              FOREIGN KEY (observation_id) REFERENCES observations(id) ON DELETE CASCADE
            )
          `),e.run("CREATE INDEX IF NOT EXISTS idx_embeddings_model ON observation_embeddings(model)")}},{version:5,up:e=>{e.run("ALTER TABLE observations ADD COLUMN last_accessed_epoch INTEGER"),e.run("ALTER TABLE observations ADD COLUMN is_stale INTEGER DEFAULT 0"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_last_accessed ON observations(last_accessed_epoch)"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_stale ON observations(is_stale)")}},{version:6,up:e=>{e.run(`
            CREATE TABLE IF NOT EXISTS checkpoints (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              session_id INTEGER NOT NULL,
              project TEXT NOT NULL,
              task TEXT NOT NULL,
              progress TEXT,
              next_steps TEXT,
              open_questions TEXT,
              relevant_files TEXT,
              context_snapshot TEXT,
              created_at TEXT NOT NULL,
              created_at_epoch INTEGER NOT NULL,
              FOREIGN KEY (session_id) REFERENCES sessions(id)
            )
          `),e.run("CREATE INDEX IF NOT EXISTS idx_checkpoints_session ON checkpoints(session_id)"),e.run("CREATE INDEX IF NOT EXISTS idx_checkpoints_project ON checkpoints(project)"),e.run("CREATE INDEX IF NOT EXISTS idx_checkpoints_epoch ON checkpoints(created_at_epoch)")}},{version:7,up:e=>{e.run("ALTER TABLE observations ADD COLUMN content_hash TEXT"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_hash ON observations(content_hash)")}},{version:8,up:e=>{e.run("ALTER TABLE observations ADD COLUMN discovery_tokens INTEGER DEFAULT 0"),e.run("ALTER TABLE summaries ADD COLUMN discovery_tokens INTEGER DEFAULT 0")}},{version:9,up:e=>{e.run("CREATE INDEX IF NOT EXISTS idx_observations_project_epoch ON observations(project, created_at_epoch DESC)"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_project_type ON observations(project, type)"),e.run("CREATE INDEX IF NOT EXISTS idx_summaries_project_epoch ON summaries(project, created_at_epoch DESC)"),e.run("CREATE INDEX IF NOT EXISTS idx_prompts_project_epoch ON prompts(project, created_at_epoch DESC)")}},{version:10,up:e=>{e.run(`
            CREATE TABLE IF NOT EXISTS job_queue (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              type TEXT NOT NULL,
              status TEXT NOT NULL DEFAULT 'pending',
              payload TEXT,
              result TEXT,
              error TEXT,
              retry_count INTEGER DEFAULT 0,
              max_retries INTEGER DEFAULT 3,
              priority INTEGER DEFAULT 0,
              created_at TEXT NOT NULL,
              created_at_epoch INTEGER NOT NULL,
              started_at_epoch INTEGER,
              completed_at_epoch INTEGER
            )
          `),e.run("CREATE INDEX IF NOT EXISTS idx_jobs_status ON job_queue(status)"),e.run("CREATE INDEX IF NOT EXISTS idx_jobs_type ON job_queue(type)"),e.run("CREATE INDEX IF NOT EXISTS idx_jobs_priority ON job_queue(status, priority DESC, created_at_epoch ASC)")}},{version:11,up:e=>{e.run("ALTER TABLE observations ADD COLUMN auto_category TEXT"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_category ON observations(auto_category)")}}]}};var lt={"all-MiniLM-L6-v2":{modelId:"Xenova/all-MiniLM-L6-v2",dimensions:384},"jina-code-v2":{modelId:"jinaai/jina-embeddings-v2-base-code",dimensions:768},"bge-small-en":{modelId:"BAAI/bge-small-en-v1.5",dimensions:384}},Zn=new Set(["all-MiniLM-L6-v2","bge-small-en"]),mt=class{provider=null;model=null;initialized=!1;initializing=null;config;configName;constructor(){let e=process.env.KIRO_MEMORY_EMBEDDING_MODEL||"all-MiniLM-L6-v2";if(this.configName=e,lt[e])this.config=lt[e];else if(e.includes("/")){let r=parseInt(process.env.KIRO_MEMORY_EMBEDDING_DIMENSIONS||"384",10);this.config={modelId:e,dimensions:isNaN(r)?384:r}}else d.warn("EMBEDDING",`Unknown model name '${e}', falling back to 'all-MiniLM-L6-v2'`),this.configName="all-MiniLM-L6-v2",this.config=lt["all-MiniLM-L6-v2"]}async initialize(){if(this.initialized)return this.provider!==null;if(this.initializing)return this.initializing;this.initializing=this._doInitialize();let e=await this.initializing;return this.initializing=null,e}async _doInitialize(){if(Zn.has(this.configName))try{let r=await import("fastembed"),s=r.EmbeddingModel||r.default?.EmbeddingModel,n=r.FlagEmbedding||r.default?.FlagEmbedding;if(n&&s)return this.model=await n.init({model:s.BGESmallENV15}),this.provider="fastembed",this.initialized=!0,d.info("EMBEDDING",`Initialized with fastembed (BGE-small-en-v1.5) for model '${this.configName}'`),!0}catch(r){d.debug("EMBEDDING",`fastembed not available: ${r}`)}try{let r=await import("@huggingface/transformers"),s=r.pipeline||r.default?.pipeline;if(s)return this.model=await s("feature-extraction",this.config.modelId,{quantized:!0}),this.provider="transformers",this.initialized=!0,d.info("EMBEDDING",`Initialized with @huggingface/transformers (${this.config.modelId})`),!0}catch(r){d.debug("EMBEDDING",`@huggingface/transformers not available: ${r}`)}return this.provider=null,this.initialized=!0,d.warn("EMBEDDING","No embedding provider available, semantic search disabled"),!1}async embed(e){if(this.initialized||await this.initialize(),!this.provider||!this.model)return null;try{let r=e.substring(0,2e3);if(this.provider==="fastembed")return await this._embedFastembed(r);if(this.provider==="transformers")return await this._embedTransformers(r)}catch(r){d.error("EMBEDDING",`Error generating embedding: ${r}`)}return null}async embedBatch(e){if(this.initialized||await this.initialize(),!this.provider||!this.model)return e.map(()=>null);if(e.length===0)return[];let r=e.map(s=>s.substring(0,2e3));try{if(this.provider==="fastembed")return await this._embedBatchFastembed(r);if(this.provider==="transformers")return await this._embedBatchTransformers(r)}catch(s){d.warn("EMBEDDING",`Batch embedding failed, falling back to serial: ${s}`)}return this._embedBatchSerial(r)}isAvailable(){return this.initialized&&this.provider!==null}getProvider(){return this.provider}getDimensions(){return this.config.dimensions}getModelName(){return this.configName}async _embedBatchFastembed(e){let r=[],s=this.model.embed(e,e.length);for await(let n of s)if(n)for(let o of n)r.push(o instanceof Float32Array?o:new Float32Array(o));for(;r.length<e.length;)r.push(null);return r}async _embedBatchTransformers(e){let r=await this.model(e,{pooling:"mean",normalize:!0});if(!r?.data)return e.map(()=>null);let s=this.getDimensions(),n=r.data instanceof Float32Array?r.data:new Float32Array(r.data),o=[];for(let i=0;i<e.length;i++){let a=i*s;a+s<=n.length?o.push(n.slice(a,a+s)):o.push(null)}return o}async _embedBatchSerial(e){let r=[];for(let s of e)try{let n=await this.embed(s);r.push(n)}catch{r.push(null)}return r}async _embedFastembed(e){let r=this.model.embed([e],1);for await(let s of r)if(s&&s.length>0){let n=s[0];return n instanceof Float32Array?n:new Float32Array(n)}return null}async _embedTransformers(e){let r=await this.model(e,{pooling:"mean",normalize:!0});return r?.data?r.data instanceof Float32Array?r.data:new Float32Array(r.data):null}},dt=null;function F(){return dt||(dt=new mt),dt}var eo=2e3;function to(t,e){let r=t.length;if(r!==e.length)return 0;let s=0,n=0,o=0;for(let a=0;a<r;a++){let c=t[a],p=e[a];s+=c*p,n+=c*c,o+=p*p}let i=Math.sqrt(n*o);return i===0?0:s/i}function ro(t){return Buffer.from(t.buffer,t.byteOffset,t.byteLength)}function so(t){let e=t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);return new Float32Array(e)}var ft=class{async search(e,r,s={}){let n=s.limit||10,o=s.threshold||.3,i=s.maxCandidates||eo;try{let a=[],c=[];s.project&&(a.push("o.project = ?"),c.push(s.project));let l=`
        SELECT e.observation_id, e.embedding,
               o.title, o.text, o.type, o.project, o.created_at, o.created_at_epoch
        FROM observation_embeddings e
        JOIN observations o ON o.id = e.observation_id
        ${a.length>0?`WHERE ${a.join(" AND ")}`:""}
        ORDER BY o.created_at_epoch DESC
        LIMIT ?
      `;c.push(i);let u=e.query(l).all(...c),m=[];for(let g of u){let h=so(g.embedding),y=to(r,h);y>=o&&m.push({id:g.observation_id,observationId:g.observation_id,similarity:y,title:g.title,text:g.text,type:g.type,project:g.project,created_at:g.created_at,created_at_epoch:g.created_at_epoch})}return m.sort((g,h)=>h.similarity-g.similarity),d.debug("VECTOR",`Search: ${u.length} candidates \u2192 ${m.length} above threshold \u2192 ${Math.min(m.length,n)} results`),m.slice(0,n)}catch(a){return d.error("VECTOR",`Vector search error: ${a}`),[]}}async storeEmbedding(e,r,s,n){try{let o=ro(s);e.query(`
        INSERT OR REPLACE INTO observation_embeddings
          (observation_id, embedding, model, dimensions, created_at)
        VALUES (?, ?, ?, ?, ?)
      `).run(r,o,n,s.length,new Date().toISOString()),d.debug("VECTOR",`Embedding saved for observation ${r}`)}catch(o){d.error("VECTOR",`Error saving embedding: ${o}`)}}async backfillEmbeddings(e,r=50){let s=F();if(!await s.initialize())return d.warn("VECTOR","Embedding service not available, backfill skipped"),0;let n=e.query(`
      SELECT o.id, o.title, o.text, o.narrative, o.concepts
      FROM observations o
      LEFT JOIN observation_embeddings e ON e.observation_id = o.id
      WHERE e.observation_id IS NULL
      ORDER BY o.created_at_epoch DESC
      LIMIT ?
    `).all(r);if(n.length===0)return 0;let o=0,i=s.getModelName();for(let a of n){let c=[a.title];a.text&&c.push(a.text),a.narrative&&c.push(a.narrative),a.concepts&&c.push(a.concepts);let p=c.join(" ").substring(0,2e3),l=await s.embed(p);l&&(await this.storeEmbedding(e,a.id,l,i),o++)}return d.info("VECTOR",`Backfill completed: ${o}/${n.length} embeddings generated`),o}getStats(e){try{let r=e.query("SELECT COUNT(*) as count FROM observations").get(),s=e.query("SELECT COUNT(*) as count FROM observation_embeddings").get(),n=r?.count||0,o=s?.count||0,i=n>0?Math.round(o/n*100):0;return{total:n,embedded:o,percentage:i}}catch{return{total:0,embedded:0,percentage:0}}}},gt=null;function H(){return gt||(gt=new ft),gt}var _r={semantic:.4,fts5:.3,recency:.2,projectMatch:.1};function ht(t,e=168){if(!t||t<=0)return 0;let s=Date.now()-t;if(s<=0)return 1;let n=s/(1e3*60*60);return Math.exp(-n*Math.LN2/e)}function vr(t,e){if(e.length===0)return 0;if(e.length===1)return 1;let r=Math.min(...e),s=Math.max(...e);return r===s?1:(s-t)/(s-r)}function yt(t,e){return!t||!e?0:t.toLowerCase()===e.toLowerCase()?1:0}function Et(t,e){return t.semantic*e.semantic+t.fts5*e.fts5+t.recency*e.recency+t.projectMatch*e.projectMatch}var no={constraint:1.3,decision:1.25,heuristic:1.15,rejected:1.1};function bt(t){return no[t]??1}var vt=class{embeddingInitialized=!1;async initialize(){try{let e=F();await e.initialize(),this.embeddingInitialized=e.isAvailable(),d.info("SEARCH",`HybridSearch initialized (embedding: ${this.embeddingInitialized?"active":"disabled"})`)}catch(e){d.warn("SEARCH","Embedding initialization failed, using only FTS5",{},e),this.embeddingInitialized=!1}}async search(e,r,s={}){let n=s.limit||10,o=s.weights||_r,i=s.project||"",a=new Map;if(this.embeddingInitialized)try{let m=await F().embed(r);if(m){let h=await H().search(e,m,{project:s.project,limit:n*2,threshold:.3});for(let y of h)a.set(String(y.observationId),{id:String(y.observationId),title:y.title,content:y.text||"",type:y.type,project:y.project,created_at:y.created_at,created_at_epoch:y.created_at_epoch,semanticScore:y.similarity,fts5Rank:null,source:"vector"});d.debug("SEARCH",`Vector search: ${h.length} results`)}}catch(u){d.warn("SEARCH","Vector search failed, using only keyword",{},u)}try{let{searchObservationsFTSWithRank:u}=await Promise.resolve().then(()=>(U(),Dr)),m=u(e,r,{project:s.project,limit:n*2});for(let g of m){let h=String(g.id),y=a.get(h);y?(y.fts5Rank=g.fts5_rank,y.source="vector"):a.set(h,{id:h,title:g.title,content:g.text||g.narrative||"",type:g.type,project:g.project,created_at:g.created_at,created_at_epoch:g.created_at_epoch,semanticScore:0,fts5Rank:g.fts5_rank,source:"keyword"})}d.debug("SEARCH",`Keyword search: ${m.length} results`)}catch(u){d.error("SEARCH","Keyword search failed",{},u)}if(a.size===0)return[];let c=Array.from(a.values()).filter(u=>u.fts5Rank!==null).map(u=>u.fts5Rank),p=[];for(let u of a.values()){let m={semantic:u.semanticScore,fts5:u.fts5Rank!==null?vr(u.fts5Rank,c):0,recency:ht(u.created_at_epoch),projectMatch:i?yt(u.project,i):0},g=Et(m,o),h=u.semanticScore>0&&u.fts5Rank!==null,E=Math.min(1,g*(h?1.15:1)*bt(u.type));p.push({id:u.id,title:u.title,content:u.content,type:u.type,project:u.project,created_at:u.created_at,created_at_epoch:u.created_at_epoch,score:E,source:h?"hybrid":u.source,signals:m})}p.sort((u,m)=>m.score-u.score);let l=p.slice(0,n);if(l.length>0)try{let{updateLastAccessed:u}=await Promise.resolve().then(()=>(ie(),Lr)),m=l.map(g=>parseInt(g.id,10)).filter(g=>g>0);m.length>0&&u(e,m)}catch{}return l}},_t=null;function ae(){return _t||(_t=new vt),_t}var fo=50,ce=[];function pe(){return ce}function kr(){return fo}function Mr(t){ce.push(t)}function Pr(t){let e=ce.indexOf(t);e>-1&&ce.splice(e,1)}function ho(t,e){let r=`event: ${t}
data: ${JSON.stringify(e)}

`;ce.forEach(s=>{try{s.write(r)}catch(n){d.warn("WORKER","Broadcast failed to client",{},n)}})}var W={data:[],ts:0},$r=6e4;function yo(){W.ts=0}function T(t,e,r,s){if(!t)return e;let n=parseInt(t,10);return isNaN(n)||n<r||n>s?e:n}function R(t){return typeof t=="string"&&t.length>0&&t.length<=200&&/^[\w\-\.\/@ ]+$/.test(t)&&!t.includes("..")}function L(t,e){return typeof t=="string"&&t.length>0&&t.length<=e}async function Eo(t,e,r,s,n){try{let o=F();if(!o.isAvailable())return;let i=[r];s&&i.push(s),n?.length&&i.push(n.join(", "));let a=i.join(" ").substring(0,2e3),c=await o.embed(a);c&&await H().storeEmbedding(t.db,e,c,o.getProvider()||"unknown")}catch(o){d.debug("WORKER",`Embedding generation failed for obs ${e}: ${o}`)}}function Fr(t){return{db:t,broadcast:ho,invalidateProjectsCache:yo,generateEmbeddingForObservation:(e,r,s,n)=>Eo(t,e,r,s,n)}}import{Router as So}from"express";function Br(t,e=100){return t.query("SELECT * FROM sessions ORDER BY started_at_epoch DESC LIMIT ?").all(e)}function qr(t,e,r=100){return t.query("SELECT * FROM sessions WHERE project = ? ORDER BY started_at_epoch DESC LIMIT ?").all(e,r)}ie();function Tt(t,e,r,s,n,o,i,a,c){let p=new Date,l=t.run(`INSERT INTO summaries 
     (session_id, project, request, investigated, learned, completed, next_steps, notes, created_at, created_at_epoch)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,[e,r,s,n,o,i,a,c,p.toISOString(),p.getTime()]);return Number(l.lastInsertRowid)}function Rt(t,e,r=50){return t.query("SELECT * FROM summaries WHERE project = ? ORDER BY created_at_epoch DESC, id DESC LIMIT ?").all(e,r)}function Ot(t,e){return t.query("SELECT * FROM checkpoints WHERE session_id = ? ORDER BY created_at_epoch DESC, id DESC LIMIT 1").get(e)}function wt(t,e){return t.query("SELECT * FROM checkpoints WHERE project = ? ORDER BY created_at_epoch DESC, id DESC LIMIT 1").get(e)}function Dt(t,e,r,s){let n=new Date(r),o=new Date(s),i=Math.ceil((s-r)/(1440*60*1e3)),a=i<=7?"Weekly":i<=31?"Monthly":"Custom",c=(N,I="created_at_epoch")=>{let Q=e?`SELECT COUNT(*) as count FROM ${N} WHERE project = ? AND ${I} >= ? AND ${I} <= ?`:`SELECT COUNT(*) as count FROM ${N} WHERE ${I} >= ? AND ${I} <= ?`,Gt=t.query(Q);return(e?Gt.get(e,r,s):Gt.get(r,s))?.count||0},p=c("observations"),l=c("summaries"),u=c("prompts"),m=c("sessions","started_at_epoch"),g=e?`SELECT DATE(datetime(created_at_epoch / 1000, 'unixepoch')) as day, COUNT(*) as count
       FROM observations
       WHERE project = ? AND created_at_epoch >= ? AND created_at_epoch <= ?
       GROUP BY day ORDER BY day ASC`:`SELECT DATE(datetime(created_at_epoch / 1000, 'unixepoch')) as day, COUNT(*) as count
       FROM observations
       WHERE created_at_epoch >= ? AND created_at_epoch <= ?
       GROUP BY day ORDER BY day ASC`,h=t.query(g),y=e?h.all(e,r,s):h.all(r,s),E=e?`SELECT type, COUNT(*) as count FROM observations
       WHERE project = ? AND created_at_epoch >= ? AND created_at_epoch <= ?
       GROUP BY type ORDER BY count DESC`:`SELECT type, COUNT(*) as count FROM observations
       WHERE created_at_epoch >= ? AND created_at_epoch <= ?
       GROUP BY type ORDER BY count DESC`,O=t.query(E),S=e?O.all(e,r,s):O.all(r,s),_=e?"SELECT COUNT(*) as count FROM sessions WHERE project = ? AND started_at_epoch >= ? AND started_at_epoch <= ?":"SELECT COUNT(*) as count FROM sessions WHERE started_at_epoch >= ? AND started_at_epoch <= ?",G=(e?t.query(_).get(e,r,s)?.count:t.query(_).get(r,s)?.count)||0,Pt=e?"SELECT COUNT(*) as count FROM sessions WHERE project = ? AND started_at_epoch >= ? AND started_at_epoch <= ? AND status = 'completed'":"SELECT COUNT(*) as count FROM sessions WHERE started_at_epoch >= ? AND started_at_epoch <= ? AND status = 'completed'",ls=(e?t.query(Pt).get(e,r,s)?.count:t.query(Pt).get(r,s)?.count)||0,$t=e?`SELECT AVG((completed_at_epoch - started_at_epoch) / 1000.0 / 60.0) as avg_min
       FROM sessions
       WHERE project = ? AND started_at_epoch >= ? AND started_at_epoch <= ?
         AND status = 'completed' AND completed_at_epoch IS NOT NULL AND completed_at_epoch > started_at_epoch`:`SELECT AVG((completed_at_epoch - started_at_epoch) / 1000.0 / 60.0) as avg_min
       FROM sessions
       WHERE started_at_epoch >= ? AND started_at_epoch <= ?
         AND status = 'completed' AND completed_at_epoch IS NOT NULL AND completed_at_epoch > started_at_epoch`,ds=e?t.query($t).get(e,r,s):t.query($t).get(r,s),ms=Math.round((ds?.avg_min||0)*10)/10,Ft=e?`SELECT COUNT(*) as count FROM observations
       WHERE project = ? AND created_at_epoch >= ? AND created_at_epoch <= ?
         AND type IN ('constraint', 'decision', 'heuristic', 'rejected')`:`SELECT COUNT(*) as count FROM observations
       WHERE created_at_epoch >= ? AND created_at_epoch <= ?
         AND type IN ('constraint', 'decision', 'heuristic', 'rejected')`,gs=(e?t.query(Ft).get(e,r,s)?.count:t.query(Ft).get(r,s)?.count)||0,Bt=e?`SELECT COUNT(*) as count FROM observations
       WHERE project = ? AND created_at_epoch >= ? AND created_at_epoch <= ? AND is_stale = 1`:`SELECT COUNT(*) as count FROM observations
       WHERE created_at_epoch >= ? AND created_at_epoch <= ? AND is_stale = 1`,fs=(e?t.query(Bt).get(e,r,s)?.count:t.query(Bt).get(r,s)?.count)||0,qt=e?`SELECT learned, completed, next_steps FROM summaries
       WHERE project = ? AND created_at_epoch >= ? AND created_at_epoch <= ?
       ORDER BY created_at_epoch DESC, id DESC`:`SELECT learned, completed, next_steps FROM summaries
       WHERE created_at_epoch >= ? AND created_at_epoch <= ?
       ORDER BY created_at_epoch DESC, id DESC`,hs=e?t.query(qt).all(e,r,s):t.query(qt).all(r,s),Ht=[],Ut=[],Wt=[];for(let N of hs){if(N.learned){let I=N.learned.split("; ").filter(Boolean);Ht.push(...I)}if(N.completed){let I=N.completed.split("; ").filter(Boolean);Ut.push(...I)}if(N.next_steps){let I=N.next_steps.split("; ").filter(Boolean);Wt.push(...I)}}let Kt=e?`SELECT files_modified FROM observations
       WHERE project = ? AND created_at_epoch >= ? AND created_at_epoch <= ?
         AND files_modified IS NOT NULL AND files_modified != ''`:`SELECT files_modified FROM observations
       WHERE created_at_epoch >= ? AND created_at_epoch <= ?
         AND files_modified IS NOT NULL AND files_modified != ''`,ys=e?t.query(Kt).all(e,r,s):t.query(Kt).all(r,s),We=new Map;for(let N of ys){let I=N.files_modified.split(",").map(Q=>Q.trim()).filter(Boolean);for(let Q of I)We.set(Q,(We.get(Q)||0)+1)}let Es=Array.from(We.entries()).map(([N,I])=>({file:N,count:I})).sort((N,I)=>I.count-N.count).slice(0,15);return{period:{start:n.toISOString().split("T")[0],end:o.toISOString().split("T")[0],days:i,label:a},overview:{observations:p,summaries:l,sessions:m,prompts:u,knowledgeCount:gs,staleCount:fs},timeline:y,typeDistribution:S,sessionStats:{total:G,completed:ls,avgDurationMinutes:ms},topLearnings:[...new Set(Ht)].slice(0,10),completedTasks:[...new Set(Ut)].slice(0,10),nextSteps:[...new Set(Wt)].slice(0,10),fileHotspots:Es}}U();ie();U();var ue=["constraint","decision","heuristic","rejected"];U();import{join as Hr}from"path";var bo=process.env.KIRO_MEMORY_DATA_DIR||process.env.CONTEXTKIT_DATA_DIR||Hr(process.env.HOME||"/tmp",".kiro-memory"),Wa=Hr(bo,"worker.token");var Ur="2.1.0";var Wr=new Set(["observation-created","summary-created","prompt-created","session-created"]);function Kr(t,e){let r=So(),s=Ne({windowMs:6e4,max:60,standardHeaders:!0,legacyHeaders:!1});return r.post("/api/notify",s,(n,o)=>{if(n.headers["x-worker-token"]!==e){o.status(401).json({error:"Invalid or missing X-Worker-Token"});return}let{event:a,data:c}=n.body||{};if(!a||typeof a!="string"||!Wr.has(a)){o.status(400).json({error:`Event must be one of: ${[...Wr].join(", ")}`});return}t.broadcast(a,c||{}),o.json({ok:!0})}),r.get("/health",(n,o)=>{o.json({status:"ok",timestamp:Date.now(),version:Ur})}),r.get("/events",(n,o)=>{let i=pe();if(i.length>=kr()){o.status(503).json({error:"Too many SSE connections"});return}o.setHeader("Content-Type","text/event-stream"),o.setHeader("Cache-Control","no-cache"),o.setHeader("Connection","keep-alive"),o.setHeader("X-Accel-Buffering","no"),o.flushHeaders(),Mr(o),d.info("WORKER","SSE client connected",{clients:i.length}),o.write(`event: connected
data: ${JSON.stringify({timestamp:Date.now()})}

`);let a=setInterval(()=>{try{o.write(`:keepalive ${Date.now()}

`)}catch{clearInterval(a)}},15e3);n.on("close",()=>{clearInterval(a),Pr(o),d.info("WORKER","SSE client disconnected",{clients:pe().length})})}),r}import{Router as _o}from"express";ie();U();function Gr(t){let e=_o();return e.get("/api/observations",(r,s)=>{let{offset:n,limit:o,project:i}=r.query,a=T(n,0,0,1e6),c=T(o,50,1,200);try{let p=i?"SELECT COUNT(*) as total FROM observations WHERE project = ?":"SELECT COUNT(*) as total FROM observations",l=t.db.db.query(p),{total:u}=i?l.get(i):l.get(),m=i?"SELECT * FROM observations WHERE project = ? ORDER BY created_at_epoch DESC LIMIT ? OFFSET ?":"SELECT * FROM observations ORDER BY created_at_epoch DESC LIMIT ? OFFSET ?",g=t.db.db.query(m),h=i?g.all(i,c,a):g.all(c,a);s.setHeader("X-Total-Count",u),s.json(h)}catch(p){d.error("WORKER","Observation list failed",{},p),s.status(500).json({error:"Failed to list observations"})}}),e.post("/api/observations",(r,s)=>{let{memorySessionId:n,project:o,type:i,title:a,content:c,concepts:p,files:l}=r.body;if(!R(o)){s.status(400).json({error:'Invalid or missing "project"'});return}if(!L(a,500)){s.status(400).json({error:'Invalid or missing "title" (max 500 chars)'});return}if(c&&!L(c,1e5)){s.status(400).json({error:'"content" too large (max 100KB)'});return}if(p&&!Array.isArray(p)){s.status(400).json({error:'"concepts" must be an array'});return}if(l&&!Array.isArray(l)){s.status(400).json({error:'"files" must be an array'});return}try{let u=ee(t.db.db,n||"api-"+Date.now(),o,i||"manual",a,null,c,null,null,p?.join(", ")||null,l?.join(", ")||null,null,0);t.broadcast("observation-created",{id:u,project:o,title:a}),t.invalidateProjectsCache(),t.generateEmbeddingForObservation(u,a,c,p).catch(()=>{}),s.json({id:u,success:!0})}catch(u){d.error("WORKER","Observation creation failed",{},u),s.status(500).json({error:"Failed to store observation"})}}),e.post("/api/observations/batch",(r,s)=>{let{ids:n}=r.body;if(!n||!Array.isArray(n)||n.length===0||n.length>100){s.status(400).json({error:'"ids" must be an array of 1-100 elements'});return}if(!n.every(o=>typeof o=="number"&&Number.isInteger(o)&&o>0)){s.status(400).json({error:"All IDs must be positive integers"});return}try{let o=ne(t.db.db,n);s.json({observations:o})}catch(o){d.error("WORKER","Batch fetch failed",{ids:n},o),s.status(500).json({error:"Batch fetch failed"})}}),e.post("/api/knowledge",(r,s)=>{let{project:n,knowledge_type:o,title:i,content:a,concepts:c,files:p,severity:l,alternatives:u,reason:m,context:g,confidence:h}=r.body;if(!R(n)){s.status(400).json({error:'Invalid or missing "project"'});return}if(!o||!ue.includes(o)){s.status(400).json({error:`Invalid "knowledge_type". Must be one of: ${ue.join(", ")}`});return}if(!L(i,500)){s.status(400).json({error:'Invalid or missing "title" (max 500 chars)'});return}if(!L(a,1e5)){s.status(400).json({error:'Invalid or missing "content" (max 100KB)'});return}if(c&&!Array.isArray(c)){s.status(400).json({error:'"concepts" must be an array'});return}if(p&&!Array.isArray(p)){s.status(400).json({error:'"files" must be an array'});return}try{let y;switch(o){case"constraint":y={knowledgeType:"constraint",severity:l==="hard"?"hard":"soft",reason:m};break;case"decision":y={knowledgeType:"decision",alternatives:u,reason:m};break;case"heuristic":y={knowledgeType:"heuristic",context:g,confidence:["high","medium","low"].includes(h)?h:void 0};break;case"rejected":y={knowledgeType:"rejected",reason:m||"",alternatives:u};break;default:s.status(400).json({error:"Invalid knowledge_type"});return}let E=ee(t.db.db,"api-"+Date.now(),n,o,i,null,a,null,JSON.stringify(y),c?.join(", ")||null,p?.join(", ")||null,null,0);t.broadcast("observation-created",{id:E,project:n,title:i,type:o}),t.generateEmbeddingForObservation(E,i,a,c).catch(()=>{}),s.json({id:E,success:!0,knowledge_type:o})}catch(y){d.error("WORKER","Knowledge save failed",{},y),s.status(500).json({error:"Failed to store knowledge"})}}),e.post("/api/memory/save",(r,s)=>{let{project:n,title:o,content:i,type:a,concepts:c}=r.body;if(!R(n)){s.status(400).json({error:'Invalid or missing "project"'});return}if(!L(o,500)){s.status(400).json({error:'Invalid or missing "title" (max 500 chars)'});return}if(!L(i,1e5)){s.status(400).json({error:'Invalid or missing "content" (max 100KB)'});return}let p=a||"research",l=Array.isArray(c)?c.join(", "):c||null;try{let u=ee(t.db.db,"memory-save-"+Date.now(),n,p,o,null,i,i,null,l,null,null,0);t.broadcast("observation-created",{id:u,project:n,title:o}),t.invalidateProjectsCache(),t.generateEmbeddingForObservation(u,o,i,Array.isArray(c)?c:void 0).catch(()=>{}),s.json({id:u,success:!0})}catch(u){d.error("WORKER","Memory save failed",{},u),s.status(500).json({error:"Failed to save memory"})}}),e.get("/api/context/:project",(r,s)=>{let{project:n}=r.params;if(!R(n)){s.status(400).json({error:"Invalid project name"});return}try{let o={project:n,observations:Fe(t.db.db,n,20),summaries:Rt(t.db.db,n,5)};s.json(o)}catch(o){d.error("WORKER","Context retrieval failed",{project:n},o),s.status(500).json({error:"Failed to get context"})}}),e}import{Router as vo}from"express";function Xr(t){let e=vo();return e.get("/api/summaries",(r,s)=>{let{offset:n,limit:o,project:i}=r.query,a=T(n,0,0,1e6),c=T(o,20,1,200);try{let p=i?"SELECT COUNT(*) as total FROM summaries WHERE project = ?":"SELECT COUNT(*) as total FROM summaries",l=t.db.db.query(p),{total:u}=i?l.get(i):l.get(),m=i?"SELECT * FROM summaries WHERE project = ? ORDER BY created_at_epoch DESC LIMIT ? OFFSET ?":"SELECT * FROM summaries ORDER BY created_at_epoch DESC LIMIT ? OFFSET ?",g=t.db.db.query(m),h=i?g.all(i,c,a):g.all(c,a);s.setHeader("X-Total-Count",u),s.json(h)}catch(p){d.error("WORKER","Summary list failed",{},p),s.status(500).json({error:"Failed to list summaries"})}}),e.post("/api/summaries",(r,s)=>{let{sessionId:n,project:o,request:i,learned:a,completed:c,nextSteps:p}=r.body;if(!R(o)){s.status(400).json({error:'Invalid or missing "project"'});return}let l=5e4;if(i&&!L(i,l)){s.status(400).json({error:'"request" too large'});return}if(a&&!L(a,l)){s.status(400).json({error:'"learned" too large'});return}if(c&&!L(c,l)){s.status(400).json({error:'"completed" too large'});return}if(p&&!L(p,l)){s.status(400).json({error:'"nextSteps" too large'});return}try{let u=Tt(t.db.db,n||"api-"+Date.now(),o,i||null,null,a||null,c||null,p||null,null);t.broadcast("summary-created",{id:u,project:o}),s.json({id:u,success:!0})}catch(u){d.error("WORKER","Summary creation failed",{},u),s.status(500).json({error:"Failed to store summary"})}}),e}import{Router as To}from"express";U();function zr(t){let e=To();return e.get("/api/search",(r,s)=>{let{q:n,project:o,type:i,limit:a}=r.query;if(!n){s.status(400).json({error:'Query parameter "q" is required'});return}try{let c={project:o||void 0,type:i||void 0,limit:T(a,20,1,100)},p={observations:re(t.db.db,n,c),summaries:se(t.db.db,n,c)};s.json(p)}catch(c){d.error("WORKER","Search failed",{query:n},c),s.status(500).json({error:"Search failed"})}}),e.get("/api/hybrid-search",async(r,s)=>{let{q:n,project:o,limit:i}=r.query;if(!n){s.status(400).json({error:'Query parameter "q" is required'});return}try{let c=await ae().search(t.db.db,n,{project:o||void 0,limit:T(i,10,1,100)});s.json({results:c,count:c.length})}catch(a){d.error("WORKER","Hybrid search failed",{query:n},a),s.status(500).json({error:"Hybrid search failed"})}}),e.get("/api/timeline",(r,s)=>{let{anchor:n,depth_before:o,depth_after:i}=r.query;if(!n){s.status(400).json({error:'Query parameter "anchor" is required'});return}let a=T(n,0,1,Number.MAX_SAFE_INTEGER);if(a===0){s.status(400).json({error:'Invalid "anchor" (must be positive integer)'});return}try{let c=oe(t.db.db,a,T(o,5,1,50),T(i,5,1,50));s.json({timeline:c})}catch(c){d.error("WORKER","Timeline failed",{anchor:n},c),s.status(500).json({error:"Timeline failed"})}}),e}import{Router as Ro}from"express";function Yr(t,e,r=30){let s=Date.now()-r*24*60*60*1e3,n=e?`SELECT DATE(datetime(created_at_epoch / 1000, 'unixepoch')) as day, COUNT(*) as count
       FROM observations
       WHERE project = ? AND created_at_epoch >= ?
       GROUP BY day
       ORDER BY day ASC`:`SELECT DATE(datetime(created_at_epoch / 1000, 'unixepoch')) as day, COUNT(*) as count
       FROM observations
       WHERE created_at_epoch >= ?
       GROUP BY day
       ORDER BY day ASC`,o=t.query(n);return e?o.all(e,s):o.all(s)}function Vr(t,e){let r=e?`SELECT type, COUNT(*) as count
       FROM observations
       WHERE project = ?
       GROUP BY type
       ORDER BY count DESC`:`SELECT type, COUNT(*) as count
       FROM observations
       GROUP BY type
       ORDER BY count DESC`,s=t.query(r);return e?s.all(e):s.all()}function Qr(t,e){let s=`
    SELECT
      COUNT(*) as total,
      COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed,
      AVG(CASE
        WHEN status = 'completed' AND completed_at_epoch IS NOT NULL AND completed_at_epoch > started_at_epoch
        THEN (completed_at_epoch - started_at_epoch) / 1000.0 / 60.0
      END) as avg_min
    FROM sessions
    ${e?"WHERE project = ?":""}
  `,n=e?t.query(s).get(e):t.query(s).get();return{total:n?.total||0,completed:n?.completed||0,avgDurationMinutes:Math.round((n?.avg_min||0)*10)/10}}function Jr(t,e){let r=Date.now(),s=r-r%(1440*60*1e3),n=r-10080*60*1e3,o=e?"WHERE project = @project":"",a=`
    WITH
      obs_stats AS (
        SELECT
          COUNT(*) as total,
          COUNT(CASE WHEN created_at_epoch >= @todayStart THEN 1 END) as today,
          COUNT(CASE WHEN created_at_epoch >= @weekStart THEN 1 END) as this_week,
          COUNT(CASE WHEN is_stale = 1 THEN 1 END) as stale,
          COUNT(CASE WHEN type IN ('constraint', 'decision', 'heuristic', 'rejected') THEN 1 END) as knowledge,
          COALESCE(SUM(discovery_tokens), 0) as discovery_tokens,
          COALESCE(SUM(CAST((LENGTH(COALESCE(title, '')) + LENGTH(COALESCE(narrative, ''))) / 4 AS INTEGER)), 0) as read_tokens
        FROM observations
        ${e?"WHERE project = @project":""}
      ),
      sum_count AS (
        SELECT COUNT(*) as total FROM summaries ${o}
      ),
      sess_count AS (
        SELECT COUNT(*) as total FROM sessions ${o}
      ),
      prompt_count AS (
        SELECT COUNT(*) as total FROM prompts ${o}
      )
    SELECT
      obs_stats.total as observations,
      obs_stats.today as observations_today,
      obs_stats.this_week as observations_this_week,
      obs_stats.stale as stale_count,
      obs_stats.knowledge as knowledge_count,
      obs_stats.discovery_tokens,
      obs_stats.read_tokens,
      sum_count.total as summaries,
      sess_count.total as sessions,
      prompt_count.total as prompts
    FROM obs_stats, sum_count, sess_count, prompt_count
  `,c={"@todayStart":s,"@weekStart":n};e&&(c["@project"]=e);let p=t.query(a).get(c),l=p?.discovery_tokens||0,u=p?.read_tokens||0,m=Math.max(0,l-u),g=l>0?Math.round((1-u/l)*100):0;return{observations:p?.observations||0,summaries:p?.summaries||0,sessions:p?.sessions||0,prompts:p?.prompts||0,observationsToday:p?.observations_today||0,observationsThisWeek:p?.observations_this_week||0,staleCount:p?.stale_count||0,knowledgeCount:p?.knowledge_count||0,tokenEconomics:{discoveryTokens:l,readTokens:u,savings:m,reductionPct:g}}}var qe=class{db;windowSize;threshold;constructor(e,r=20,s=2){this.db=e,this.windowSize=r,this.threshold=s}getBaseline(e){let r=this.db.query(`
      SELECT
        s.id,
        s.content_session_id,
        s.started_at_epoch,
        s.completed_at_epoch,
        CASE
          WHEN s.completed_at_epoch IS NOT NULL AND s.completed_at_epoch > s.started_at_epoch
          THEN (s.completed_at_epoch - s.started_at_epoch) / 1000.0 / 60.0
          ELSE NULL
        END as duration_minutes,
        (SELECT COUNT(*) FROM observations o WHERE o.memory_session_id = s.memory_session_id) as obs_count,
        (SELECT COUNT(*) FROM observations o WHERE o.memory_session_id = s.memory_session_id AND o.type = 'command') as cmd_count
      FROM sessions s
      WHERE s.project = ? AND s.status = 'completed' AND s.completed_at_epoch IS NOT NULL
      ORDER BY s.completed_at_epoch DESC, s.id DESC
      LIMIT ?
    `).all(e,this.windowSize);if(r.length<3)return d.debug("DB",`Baseline for "${e}": only ${r.length} sessions, skipping`),null;let s=r.filter(i=>i.duration_minutes!==null).map(i=>i.duration_minutes),n=r.map(i=>i.obs_count),o=r.map(i=>i.cmd_count);return{project:e,avgDurationMinutes:Be(s),stdDurationMinutes:It(s),avgObservations:Be(n),stdObservations:It(n),avgCommands:Be(o),stdCommands:It(o),sampleSize:r.length}}detectAnomalies(e){let r=this.getBaseline(e);if(!r)return[];let s=this.db.query(`
      SELECT
        s.id,
        s.content_session_id,
        s.project,
        s.started_at_epoch,
        s.completed_at_epoch,
        CASE
          WHEN s.completed_at_epoch IS NOT NULL AND s.completed_at_epoch > s.started_at_epoch
          THEN (s.completed_at_epoch - s.started_at_epoch) / 1000.0 / 60.0
          ELSE NULL
        END as duration_minutes,
        (SELECT COUNT(*) FROM observations o WHERE o.memory_session_id = s.memory_session_id) as obs_count,
        (SELECT COUNT(*) FROM observations o WHERE o.memory_session_id = s.memory_session_id AND o.type = 'command') as cmd_count,
        (SELECT COUNT(*) FROM observations o WHERE o.memory_session_id = s.memory_session_id AND o.type = 'file-write') as write_count
      FROM sessions s
      WHERE s.project = ? AND s.status = 'completed' AND s.completed_at_epoch IS NOT NULL
      ORDER BY s.completed_at_epoch DESC, s.id DESC
      LIMIT ?
    `).all(e,this.windowSize),n=[];for(let o of s){if(o.duration_minutes!==null&&r.stdDurationMinutes>0){let i=(o.duration_minutes-r.avgDurationMinutes)/r.stdDurationMinutes;i>this.threshold&&n.push({sessionId:o.id,contentSessionId:o.content_session_id,project:o.project,type:"long-session",score:Math.round(i*100)/100,value:Math.round(o.duration_minutes*10)/10,mean:Math.round(r.avgDurationMinutes*10)/10,stdDev:Math.round(r.stdDurationMinutes*10)/10,description:`Session lasted ${Math.round(o.duration_minutes)} minutes (avg: ${Math.round(r.avgDurationMinutes)} min)`})}if(o.obs_count>0&&r.stdCommands>0){let i=o.cmd_count/o.obs_count,a=(o.cmd_count-r.avgCommands)/r.stdCommands;a>this.threshold&&i>.8&&n.push({sessionId:o.id,contentSessionId:o.content_session_id,project:o.project,type:"repetitive-commands",score:Math.round(a*100)/100,value:o.cmd_count,mean:Math.round(r.avgCommands*10)/10,stdDev:Math.round(r.stdCommands*10)/10,description:`${o.cmd_count} commands (${Math.round(i*100)}% of observations, avg: ${Math.round(r.avgCommands)})`})}o.obs_count>r.avgObservations&&o.write_count===0&&n.push({sessionId:o.id,contentSessionId:o.content_session_id,project:o.project,type:"no-progress",score:0,value:o.obs_count,mean:Math.round(r.avgObservations*10)/10,stdDev:Math.round(r.stdObservations*10)/10,description:`${o.obs_count} observations but no files written`})}return n}};function Be(t){return t.length===0?0:t.reduce((e,r)=>e+r,0)/t.length}function It(t){if(t.length<2)return 0;let e=Be(t),r=t.map(s=>(s-e)**2);return Math.sqrt(r.reduce((s,n)=>s+n,0)/(t.length-1))}function Zr(t){let e=Ro();return e.get("/api/analytics/overview",(r,s)=>{let{project:n}=r.query;if(n&&!R(n)){s.status(400).json({error:"Invalid project name"});return}try{let o=Jr(t.db.db,n||void 0);s.json(o)}catch(o){d.error("WORKER","Analytics overview failed",{project:n},o),s.status(500).json({error:"Analytics overview failed"})}}),e.get("/api/analytics/timeline",(r,s)=>{let{project:n,days:o}=r.query;if(n&&!R(n)){s.status(400).json({error:"Invalid project name"});return}try{let i=Yr(t.db.db,n||void 0,T(o,30,1,365));s.json(i)}catch(i){d.error("WORKER","Analytics timeline failed",{project:n},i),s.status(500).json({error:"Analytics timeline failed"})}}),e.get("/api/analytics/types",(r,s)=>{let{project:n}=r.query;if(n&&!R(n)){s.status(400).json({error:"Invalid project name"});return}try{let o=Vr(t.db.db,n||void 0);s.json(o)}catch(o){d.error("WORKER","Analytics types failed",{project:n},o),s.status(500).json({error:"Analytics types failed"})}}),e.get("/api/analytics/sessions",(r,s)=>{let{project:n}=r.query;if(n&&!R(n)){s.status(400).json({error:"Invalid project name"});return}try{let o=Qr(t.db.db,n||void 0);s.json(o)}catch(o){d.error("WORKER","Analytics sessions failed",{project:n},o),s.status(500).json({error:"Analytics sessions failed"})}}),e.get("/api/analytics/anomalies",(r,s)=>{let{project:n,window:o,threshold:i}=r.query;if(!n){s.status(400).json({error:"project parameter is required"});return}if(!R(n)){s.status(400).json({error:"Invalid project name"});return}let a=T(o,20,3,200),c=i!==void 0?parseFloat(i):2;if(isNaN(c)||c<=0||c>10){s.status(400).json({error:"threshold must be a number between 0 and 10"});return}try{let p=new qe(t.db.db,a,c),l=p.detectAnomalies(n),u=p.getBaseline(n);s.json({anomalies:l,baseline:u,project:n})}catch(p){d.error("WORKER","Anomaly detection failed",{project:n},p),s.status(500).json({error:"Anomaly detection failed"})}}),e}import{Router as Oo}from"express";function es(t){let e=Oo();return e.get("/api/sessions",(r,s)=>{let{project:n}=r.query;if(n&&!R(n)){s.status(400).json({error:"Invalid project name"});return}try{let o=n?qr(t.db.db,n,50):Br(t.db.db,50);s.json(o)}catch(o){d.error("WORKER","Session list failed",{project:n},o),s.status(500).json({error:"Sessions list failed"})}}),e.get("/api/sessions/:id/checkpoint",(r,s)=>{let n=parseInt(r.params.id,10);if(isNaN(n)||n<=0){s.status(400).json({error:"Invalid session ID"});return}try{let o=Ot(t.db.db,n);if(!o){s.status(404).json({error:"No checkpoint found for this session"});return}s.json(o)}catch(o){d.error("WORKER","Checkpoint fetch failed",{sessionId:n},o),s.status(500).json({error:"Checkpoint fetch failed"})}}),e.get("/api/checkpoint",(r,s)=>{let{project:n}=r.query;if(!n){s.status(400).json({error:"Project parameter is required"});return}if(!R(n)){s.status(400).json({error:"Invalid project name"});return}try{let o=wt(t.db.db,n);if(!o){s.status(404).json({error:"No checkpoint found for this project"});return}s.json(o)}catch(o){d.error("WORKER","Project checkpoint fetch failed",{project:n},o),s.status(500).json({error:"Project checkpoint fetch failed"})}}),e.get("/api/prompts",(r,s)=>{let{offset:n,limit:o,project:i}=r.query,a=T(n,0,0,1e6),c=T(o,20,1,200);try{let p=i?"SELECT COUNT(*) as total FROM prompts WHERE project = ?":"SELECT COUNT(*) as total FROM prompts",l=t.db.db.query(p),{total:u}=i?l.get(i):l.get(),m=i?"SELECT * FROM prompts WHERE project = ? ORDER BY created_at_epoch DESC LIMIT ? OFFSET ?":"SELECT * FROM prompts ORDER BY created_at_epoch DESC LIMIT ? OFFSET ?",g=t.db.db.query(m),h=i?g.all(i,c,a):g.all(c,a);s.setHeader("X-Total-Count",u),s.json(h)}catch(p){d.error("WORKER","Prompt list failed",{},p),s.status(500).json({error:"Failed to list prompts"})}}),e}import{Router as wo}from"express";U();function ts(t){let e=wo();return e.get("/api/projects",(r,s)=>{try{let n=Date.now();if(n-W.ts<$r&&W.data.length>0){s.json(W.data);return}let i=t.db.db.query(`SELECT DISTINCT project FROM (
          SELECT project FROM observations
          UNION
          SELECT project FROM summaries
          UNION
          SELECT project FROM prompts
        ) ORDER BY project ASC`).all();W.data=i.map(a=>a.project),W.ts=n,s.json(W.data)}catch(n){d.error("WORKER","Project list failed",{},n),s.status(500).json({error:"Failed to list projects"})}}),e.get("/api/project-aliases",(r,s)=>{try{let o=t.db.db.query("SELECT project_name, display_name FROM project_aliases").all(),i={};for(let a of o)i[a.project_name]=a.display_name;s.json(i)}catch(n){d.error("WORKER","Alias list failed",{},n),s.status(500).json({error:"Failed to list project aliases"})}}),e.put("/api/project-aliases/:project",(r,s)=>{let{project:n}=r.params,{displayName:o}=r.body;if(!R(n)){s.status(400).json({error:"Invalid project name"});return}if(!o||typeof o!="string"||o.trim().length===0||o.length>100){s.status(400).json({error:'Field "displayName" is required (string, max 100 chars)'});return}try{let i=new Date().toISOString();t.db.db.query(`
        INSERT INTO project_aliases (project_name, display_name, created_at, updated_at)
        VALUES (?, ?, ?, ?)
        ON CONFLICT(project_name) DO UPDATE SET display_name = excluded.display_name, updated_at = excluded.updated_at
      `).run(n,o.trim(),i,i),s.json({ok:!0,project_name:n,display_name:o.trim()})}catch(i){d.error("WORKER","Alias update failed",{project:n},i),s.status(500).json({error:"Failed to update project alias"})}}),e.get("/api/stats/:project",(r,s)=>{let{project:n}=r.params;if(!R(n)){s.status(400).json({error:"Invalid project name"});return}try{let o=Pe(t.db.db,n);s.json(o)}catch(o){d.error("WORKER","Stats failed",{project:n},o),s.status(500).json({error:"Stats failed"})}}),e}import{Router as Do}from"express";function rs(t){let e=[];if(e.push(`# Kiro Memory Report \u2014 ${t.period.label}`),e.push(""),e.push(`**Period**: ${t.period.start} \u2192 ${t.period.end} (${t.period.days} days)`),e.push(""),e.push("## Overview"),e.push(""),e.push("| Metric | Count |"),e.push("|--------|------:|"),e.push(`| Observations | ${t.overview.observations} |`),e.push(`| Summaries | ${t.overview.summaries} |`),e.push(`| Sessions | ${t.overview.sessions} |`),e.push(`| Prompts | ${t.overview.prompts} |`),e.push(`| Knowledge items | ${t.overview.knowledgeCount} |`),t.overview.staleCount>0&&e.push(`| Stale observations | ${t.overview.staleCount} |`),e.push(""),t.sessionStats.total>0){let r=Math.round(t.sessionStats.completed/t.sessionStats.total*100);e.push("## Sessions"),e.push(""),e.push(`- **Total**: ${t.sessionStats.total}`),e.push(`- **Completed**: ${t.sessionStats.completed} (${r}%)`),t.sessionStats.avgDurationMinutes>0&&e.push(`- **Avg duration**: ${t.sessionStats.avgDurationMinutes} min`),e.push("")}if(t.timeline.length>0){e.push("## Activity Timeline"),e.push(""),e.push("| Date | Observations |"),e.push("|------|------------:|");for(let r of t.timeline)e.push(`| ${r.day} | ${r.count} |`);e.push("")}if(t.typeDistribution.length>0){e.push("## Observation Types"),e.push("");for(let r of t.typeDistribution)e.push(`- **${r.type}**: ${r.count}`);e.push("")}if(t.topLearnings.length>0){e.push("## Key Learnings"),e.push("");for(let r of t.topLearnings)e.push(`- ${r}`);e.push("")}if(t.completedTasks.length>0){e.push("## Completed"),e.push("");for(let r of t.completedTasks)e.push(`- ${r}`);e.push("")}if(t.nextSteps.length>0){e.push("## Next Steps"),e.push("");for(let r of t.nextSteps)e.push(`- ${r}`);e.push("")}if(t.fileHotspots.length>0){e.push("## File Hotspots"),e.push(""),e.push("| File | Modifications |"),e.push("|------|-------------:|");for(let r of t.fileHotspots.slice(0,10))e.push(`| \`${r.file}\` | ${r.count} |`);e.push("")}return e.join(`
`)}function ss(t,e){let r=Do();function s(n,o,i){if(!e){i();return}if(n.headers["x-worker-token"]!==e){o.status(401).json({error:"Invalid or missing X-Worker-Token"});return}i()}return r.post("/api/embeddings/backfill",s,async(n,o)=>{let{batchSize:i}=n.body||{};try{let c=await H().backfillEmbeddings(t.db.db,T(String(i),50,1,500));o.json({success:!0,generated:c})}catch(a){d.error("WORKER","Backfill embeddings failed",{},a),o.status(500).json({error:"Backfill failed"})}}),r.get("/api/embeddings/stats",(n,o)=>{try{let a=H().getStats(t.db.db),c=F();o.json({...a,provider:c.getProvider(),dimensions:c.getDimensions(),available:c.isAvailable()})}catch(i){d.error("WORKER","Embedding stats failed",{},i),o.status(500).json({error:"Stats failed"})}}),r.post("/api/retention/cleanup",s,(n,o)=>{let{maxAgeDays:i,dryRun:a}=n.body||{},c=T(String(i),90,7,730),p=Date.now()-c*864e5;try{if(a){let m=t.db.db.query("SELECT COUNT(*) as c FROM observations WHERE created_at_epoch < ?").get(p).c,g=t.db.db.query("SELECT COUNT(*) as c FROM summaries WHERE created_at_epoch < ?").get(p).c,h=t.db.db.query("SELECT COUNT(*) as c FROM prompts WHERE created_at_epoch < ?").get(p).c;o.json({dryRun:!0,maxAgeDays:c,wouldDelete:{observations:m,summaries:g,prompts:h}});return}let u=t.db.db.transaction(()=>{t.db.db.run("DELETE FROM observation_embeddings WHERE observation_id IN (SELECT id FROM observations WHERE created_at_epoch < ?)",[p]);let m=t.db.db.run("DELETE FROM observations WHERE created_at_epoch < ?",[p]),g=t.db.db.run("DELETE FROM summaries WHERE created_at_epoch < ?",[p]),h=t.db.db.run("DELETE FROM prompts WHERE created_at_epoch < ?",[p]);return{observations:m.changes,summaries:g.changes,prompts:h.changes}})();t.invalidateProjectsCache(),d.info("WORKER",`Retention cleanup: deleted ${u.observations} obs, ${u.summaries} sum, ${u.prompts} prompts (> ${c}d)`),o.json({success:!0,maxAgeDays:c,deleted:u})}catch(l){d.error("WORKER","Retention cleanup failed",{maxAgeDays:c},l),o.status(500).json({error:"Retention cleanup failed"})}}),r.get("/api/export",(n,o)=>{let{project:i,format:a,type:c,days:p}=n.query;if(i&&!R(i)){o.status(400).json({error:"Invalid project name"});return}let l=T(p,30,1,365),u=Date.now()-l*864e5;try{let m="SELECT * FROM observations WHERE created_at_epoch > ?",g=[u];i&&(m+=" AND project = ?",g.push(i)),c&&(m+=" AND type = ?",g.push(c)),m+=" ORDER BY created_at_epoch DESC LIMIT 1000";let h=t.db.db.query(m).all(...g),y="SELECT * FROM summaries WHERE created_at_epoch > ?",E=[u];i&&(y+=" AND project = ?",E.push(i)),y+=" ORDER BY created_at_epoch DESC LIMIT 100";let O=t.db.db.query(y).all(...E);if(a==="markdown"||a==="md"){let S=["# Kiro Memory Export",`> Project: ${i||"All"} | Period: ${l} days | Generated: ${new Date().toISOString()}`,"",`## Observations (${h.length})`,""];for(let _ of h){let G=new Date(_.created_at_epoch).toISOString().split("T")[0];S.push(`### [${_.type}] ${_.title}`),S.push(`- **Date**: ${G} | **Project**: ${_.project} | **ID**: #${_.id}`),_.narrative&&S.push(`- ${_.narrative}`),_.concepts&&S.push(`- **Concepts**: ${_.concepts}`),S.push("")}S.push(`## Summaries (${O.length})`,"");for(let _ of O){let G=new Date(_.created_at_epoch).toISOString().split("T")[0];S.push(`### Session ${_.session_id} (${G})`),_.request&&S.push(`- **Request**: ${_.request}`),_.completed&&S.push(`- **Completed**: ${_.completed}`),_.next_steps&&S.push(`- **Next steps**: ${_.next_steps}`),S.push("")}o.type("text/markdown").send(S.join(`
`))}else o.json({meta:{project:i||"all",daysBack:l,exportedAt:new Date().toISOString()},observations:h,summaries:O})}catch(m){d.error("WORKER","Export failed",{project:i,fmt:a},m),o.status(500).json({error:"Export failed"})}}),r.get("/api/report",(n,o)=>{let{project:i,period:a,format:c}=n.query;if(i&&!R(i)){o.status(400).json({error:"Invalid project name"});return}let u=(["weekly","monthly"].includes(a||"")?a:"weekly")==="monthly"?30:7,m=Date.now(),g=m-u*24*60*60*1e3;try{let h=Dt(t.db.db,i||void 0,g,m),y=c||"json";y==="markdown"||y==="md"?o.type("text/markdown").send(rs(h)):y==="text"?o.type("text/plain").send(JSON.stringify(h,null,2)):o.json(h)}catch(h){d.error("WORKER","Report generation failed",{project:i,period:a},h),o.status(500).json({error:"Report generation failed"})}}),r}import{Router as jo}from"express";var is={type:"object",properties:{error:{type:"string",description:"Messaggio di errore leggibile"}},required:["error"]},ns={type:"object",properties:{id:{type:"integer"},session_id:{type:"string"},project:{type:"string"},type:{type:"string"},title:{type:"string"},narrative:{type:["string","null"]},content:{type:["string","null"]},summary:{type:["string","null"]},metadata:{type:["string","null"]},concepts:{type:["string","null"]},files:{type:["string","null"]},raw_payload:{type:["string","null"]},discovery_tokens:{type:"integer"},created_at_epoch:{type:"integer"}}},os={type:"object",properties:{id:{type:"integer"},session_id:{type:"string"},project:{type:"string"},request:{type:["string","null"]},learned:{type:["string","null"]},completed:{type:["string","null"]},next_steps:{type:["string","null"]},raw_payload:{type:["string","null"]},created_at_epoch:{type:"integer"}}},Io={type:"object",properties:{id:{type:"integer"},session_id:{type:"string"},project:{type:"string"},started_at_epoch:{type:"integer"},ended_at_epoch:{type:["integer","null"]}}},Ao={type:"object",properties:{id:{type:"integer"},session_id:{type:"string"},project:{type:"string"},prompt:{type:"string"},created_at_epoch:{type:"integer"}}};function At(t){return{description:"Lista paginata. Il totale \xE8 incluso nell'header X-Total-Count.",headers:{"X-Total-Count":{schema:{type:"integer"},description:"Numero totale di record nel database"}},content:{"application/json":{schema:{type:"array",items:t}}}}}function f(t){return{description:t,content:{"application/json":{schema:is}}}}var He={openapi:"3.1.0",info:{title:"Kiro Memory REST API",version:"2.1.0",description:["API REST del worker Kiro Memory (porta 3001).","Fornisce accesso a osservazioni, sommari, sessioni, ricerca,","analytics, export, embeddings vettoriali e gestione progetti."].join(" "),license:{name:"MIT"},contact:{name:"Auriti-Labs",url:"https://github.com/Auriti-Labs/kiro-memory"}},servers:[{url:"http://127.0.0.1:3001",description:"Worker locale (default)"}],components:{schemas:{Error:is,Observation:ns,Summary:os,Session:Io,Prompt:Ao,Checkpoint:{type:"object",properties:{id:{type:"integer"},session_id:{type:"integer"},project:{type:"string"},content:{type:"string"},created_at_epoch:{type:"integer"}}},AnalyticsOverview:{type:"object",properties:{totalObservations:{type:"integer"},totalSummaries:{type:"integer"},totalPrompts:{type:"integer"},totalSessions:{type:"integer"},projects:{type:"array",items:{type:"string"}}}},TimelineEntry:{type:"object",properties:{date:{type:"string",format:"date"},count:{type:"integer"}}},TypeDistributionEntry:{type:"object",properties:{type:{type:"string"},count:{type:"integer"}}},SessionStats:{type:"object",properties:{totalSessions:{type:"integer"},avgObsPerSession:{type:"number"},avgDurationMs:{type:"number"}}},AnomalyEntry:{type:"object",properties:{sessionId:{type:"integer"},project:{type:"string"},obsCount:{type:"integer"},zScore:{type:"number"},isAnomaly:{type:"boolean"}}},EmbeddingStats:{type:"object",properties:{total:{type:"integer"},withEmbed:{type:"integer"},provider:{type:"string"},dimensions:{type:"integer"},available:{type:"boolean"}}},HybridSearchResult:{type:"object",properties:{id:{type:"integer"},project:{type:"string"},type:{type:"string"},title:{type:"string"},score:{type:"number"},source:{type:"string",enum:["vector","fts","hybrid"]}}},ProjectAlias:{type:"object",properties:{project_name:{type:"string"},display_name:{type:"string"}}},ProjectStats:{type:"object",properties:{project:{type:"string"},observations:{type:"integer"},summaries:{type:"integer"},prompts:{type:"integer"},sessions:{type:"integer"},lastActivity:{type:"integer",description:"epoch ms"}}},ExportData:{type:"object",properties:{meta:{type:"object",properties:{project:{type:"string"},daysBack:{type:"integer"},exportedAt:{type:"string",format:"date-time"}}},observations:{type:"array",items:ns},summaries:{type:"array",items:os}}}},securitySchemes:{workerToken:{type:"apiKey",in:"header",name:"X-Worker-Token",description:"Token segreto per endpoint riservati (notify, backfill, cleanup)"}},parameters:{projectQuery:{name:"project",in:"query",schema:{type:"string"},description:"Filtra per nome progetto"},offsetQuery:{name:"offset",in:"query",schema:{type:"integer",default:0,minimum:0},description:"Offset paginazione"},limitQuery:{name:"limit",in:"query",schema:{type:"integer",default:20,minimum:1,maximum:200},description:"Numero massimo di risultati"}}},paths:{"/health":{get:{tags:["Core"],summary:"Health check",description:"Verifica che il worker sia attivo e restituisce la versione.",operationId:"getHealth",responses:{200:{description:"Worker attivo",content:{"application/json":{schema:{type:"object",properties:{status:{type:"string",example:"ok"},timestamp:{type:"integer",description:"epoch ms"},version:{type:"string",example:"2.1.0"}}}}}}}}},"/events":{get:{tags:["Core"],summary:"Server-Sent Events (SSE)",description:["Stream SSE per aggiornamenti in tempo reale alla dashboard.","Emette eventi: `connected`, `observation-created`, `summary-created`,","`prompt-created`, `session-created`. Keepalive ogni 15s.","Limite: 50 connessioni simultanee."].join(" "),operationId:"getEvents",responses:{200:{description:"Stream SSE attivo",content:{"text/event-stream":{schema:{type:"string"}}}},503:f("Troppi client SSE connessi")}}},"/api/notify":{post:{tags:["Core"],summary:"Notifica interna hook \u2192 SSE",description:["Endpoint riservato agli hook Kiro. Riceve un evento e lo broadcast","a tutti i client SSE connessi. Richiede `X-Worker-Token`.","Rate limit: 60 richieste/minuto."].join(" "),operationId:"postNotify",security:[{workerToken:[]}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",required:["event"],properties:{event:{type:"string",enum:["observation-created","summary-created","prompt-created","session-created"]},data:{type:"object",additionalProperties:!0}}}}}},responses:{200:{description:"Evento broadcast con successo",content:{"application/json":{schema:{type:"object",properties:{ok:{type:"boolean"}}}}}},400:f("Evento non valido o non consentito"),401:f("Token mancante o non valido")}}},"/api/observations":{get:{tags:["Observations"],summary:"Lista osservazioni paginate",operationId:"listObservations",parameters:[{$ref:"#/components/parameters/offsetQuery"},{$ref:"#/components/parameters/limitQuery"},{$ref:"#/components/parameters/projectQuery"}],responses:{200:At({$ref:"#/components/schemas/Observation"}),500:f("Errore interno")}},post:{tags:["Observations"],summary:"Crea una nuova osservazione",operationId:"createObservation",requestBody:{required:!0,content:{"application/json":{schema:{type:"object",required:["project","title"],properties:{memorySessionId:{type:"string"},project:{type:"string"},type:{type:"string",default:"manual"},title:{type:"string",maxLength:500},content:{type:"string",maxLength:1e5},concepts:{type:"array",items:{type:"string"}},files:{type:"array",items:{type:"string"}}}}}}},responses:{200:{description:"Osservazione creata",content:{"application/json":{schema:{type:"object",properties:{id:{type:"integer"},success:{type:"boolean"}}}}}},400:f("Payload non valido"),500:f("Errore di persistenza")}}},"/api/observations/batch":{post:{tags:["Observations"],summary:"Recupero batch per ID (max 100)",operationId:"batchGetObservations",requestBody:{required:!0,content:{"application/json":{schema:{type:"object",required:["ids"],properties:{ids:{type:"array",items:{type:"integer",minimum:1},minItems:1,maxItems:100}}}}}},responses:{200:{description:"Osservazioni trovate",content:{"application/json":{schema:{type:"object",properties:{observations:{type:"array",items:{$ref:"#/components/schemas/Observation"}}}}}}},400:f("Array ids non valido"),500:f("Errore interno")}}},"/api/knowledge":{post:{tags:["Observations"],summary:"Salva conoscenza strutturata",description:["Crea un'osservazione di tipo knowledge con metadati tipizzati.","Tipi supportati: `constraint`, `decision`, `heuristic`, `rejected`."].join(" "),operationId:"createKnowledge",requestBody:{required:!0,content:{"application/json":{schema:{type:"object",required:["project","knowledge_type","title","content"],properties:{project:{type:"string"},knowledge_type:{type:"string",enum:["constraint","decision","heuristic","rejected"]},title:{type:"string",maxLength:500},content:{type:"string",maxLength:1e5},concepts:{type:"array",items:{type:"string"}},files:{type:"array",items:{type:"string"}},severity:{type:"string",enum:["hard","soft"],description:"Solo per constraint"},alternatives:{type:"array",items:{type:"string"},description:"Solo per decision/rejected"},reason:{type:"string",description:"Motivazione (constraint, decision, rejected)"},context:{type:"string",description:"Contesto applicativo (heuristic)"},confidence:{type:"string",enum:["high","medium","low"],description:"Solo per heuristic"}}}}}},responses:{200:{description:"Conoscenza salvata",content:{"application/json":{schema:{type:"object",properties:{id:{type:"integer"},success:{type:"boolean"},knowledge_type:{type:"string"}}}}}},400:f("Payload non valido o knowledge_type sconosciuto"),500:f("Errore di persistenza")}}},"/api/memory/save":{post:{tags:["Observations"],summary:"Salva una memoria (endpoint programmabile)",operationId:"saveMemory",requestBody:{required:!0,content:{"application/json":{schema:{type:"object",required:["project","title","content"],properties:{project:{type:"string"},title:{type:"string",maxLength:500},content:{type:"string",maxLength:1e5},type:{type:"string",default:"research"},concepts:{type:["array","string"],items:{type:"string"}}}}}}},responses:{200:{description:"Memoria salvata",content:{"application/json":{schema:{type:"object",properties:{id:{type:"integer"},success:{type:"boolean"}}}}}},400:f("Campo obbligatorio mancante o non valido"),500:f("Errore di persistenza")}}},"/api/context/{project}":{get:{tags:["Observations"],summary:"Contesto progetto (ultime osservazioni + sommari)",operationId:"getProjectContext",parameters:[{name:"project",in:"path",required:!0,schema:{type:"string"},description:"Nome del progetto"}],responses:{200:{description:"Contesto del progetto",content:{"application/json":{schema:{type:"object",properties:{project:{type:"string"},observations:{type:"array",items:{$ref:"#/components/schemas/Observation"}},summaries:{type:"array",items:{$ref:"#/components/schemas/Summary"}}}}}}},400:f("Nome progetto non valido"),500:f("Errore interno")}}},"/api/summaries":{get:{tags:["Summaries"],summary:"Lista sommari paginata",operationId:"listSummaries",parameters:[{$ref:"#/components/parameters/offsetQuery"},{$ref:"#/components/parameters/limitQuery"},{$ref:"#/components/parameters/projectQuery"}],responses:{200:At({$ref:"#/components/schemas/Summary"}),500:f("Errore interno")}},post:{tags:["Summaries"],summary:"Crea un nuovo sommario di sessione",operationId:"createSummary",requestBody:{required:!0,content:{"application/json":{schema:{type:"object",required:["project"],properties:{sessionId:{type:"string"},project:{type:"string"},request:{type:"string",maxLength:5e4},learned:{type:"string",maxLength:5e4},completed:{type:"string",maxLength:5e4},nextSteps:{type:"string",maxLength:5e4}}}}}},responses:{200:{description:"Sommario creato",content:{"application/json":{schema:{type:"object",properties:{id:{type:"integer"},success:{type:"boolean"}}}}}},400:f("Payload non valido o campo troppo grande"),500:f("Errore di persistenza")}}},"/api/search":{get:{tags:["Search"],summary:"Ricerca full-text FTS5",operationId:"searchFTS",parameters:[{name:"q",in:"query",required:!0,schema:{type:"string"},description:"Testo da cercare (SQLite FTS5)"},{$ref:"#/components/parameters/projectQuery"},{name:"type",in:"query",schema:{type:"string"},description:"Filtra per tipo osservazione"},{name:"limit",in:"query",schema:{type:"integer",default:20,minimum:1,maximum:100}}],responses:{200:{description:"Risultati ricerca FTS5",content:{"application/json":{schema:{type:"object",properties:{observations:{type:"array",items:{$ref:"#/components/schemas/Observation"}},summaries:{type:"array",items:{$ref:"#/components/schemas/Summary"}}}}}}},400:f('Parametro "q" obbligatorio'),500:f("Ricerca fallita")}}},"/api/hybrid-search":{get:{tags:["Search"],summary:"Ricerca ibrida (vettoriale + keyword)",description:"Combina embedding vettoriali e FTS5 per una ricerca semantica avanzata.",operationId:"searchHybrid",parameters:[{name:"q",in:"query",required:!0,schema:{type:"string"},description:"Testo da cercare"},{$ref:"#/components/parameters/projectQuery"},{name:"limit",in:"query",schema:{type:"integer",default:10,minimum:1,maximum:100}}],responses:{200:{description:"Risultati ibridi con score di rilevanza",content:{"application/json":{schema:{type:"object",properties:{results:{type:"array",items:{$ref:"#/components/schemas/HybridSearchResult"}},count:{type:"integer"}}}}}},400:f('Parametro "q" obbligatorio'),500:f("Ricerca ibrida fallita")}}},"/api/timeline":{get:{tags:["Search"],summary:"Timeline cronologica intorno a un'osservazione",operationId:"getTimeline",parameters:[{name:"anchor",in:"query",required:!0,schema:{type:"integer",minimum:1},description:"ID dell'osservazione centrale"},{name:"depth_before",in:"query",schema:{type:"integer",default:5,minimum:1,maximum:50},description:"Numero di osservazioni precedenti"},{name:"depth_after",in:"query",schema:{type:"integer",default:5,minimum:1,maximum:50},description:"Numero di osservazioni successive"}],responses:{200:{description:"Timeline restituita",content:{"application/json":{schema:{type:"object",properties:{timeline:{type:"array",items:{$ref:"#/components/schemas/Observation"}}}}}}},400:f('Parametro "anchor" mancante o non valido'),500:f("Timeline fallita")}}},"/api/analytics/overview":{get:{tags:["Analytics"],summary:"Panoramica aggregata delle statistiche",operationId:"getAnalyticsOverview",parameters:[{$ref:"#/components/parameters/projectQuery"}],responses:{200:{description:"Overview aggregata",content:{"application/json":{schema:{$ref:"#/components/schemas/AnalyticsOverview"}}}},400:f("Nome progetto non valido"),500:f("Analytics overview fallita")}}},"/api/analytics/timeline":{get:{tags:["Analytics"],summary:"Distribuzione temporale osservazioni per giorno",operationId:"getAnalyticsTimeline",parameters:[{$ref:"#/components/parameters/projectQuery"},{name:"days",in:"query",schema:{type:"integer",default:30,minimum:1,maximum:365},description:"Finestra temporale in giorni"}],responses:{200:{description:"Serie temporale giornaliera",content:{"application/json":{schema:{type:"array",items:{$ref:"#/components/schemas/TimelineEntry"}}}}},400:f("Nome progetto non valido"),500:f("Analytics timeline fallita")}}},"/api/analytics/types":{get:{tags:["Analytics"],summary:"Distribuzione per tipo osservazione",operationId:"getAnalyticsTypes",parameters:[{$ref:"#/components/parameters/projectQuery"}],responses:{200:{description:"Distribuzione dei tipi",content:{"application/json":{schema:{type:"array",items:{$ref:"#/components/schemas/TypeDistributionEntry"}}}}},400:f("Nome progetto non valido"),500:f("Analytics types fallita")}}},"/api/analytics/sessions":{get:{tags:["Analytics"],summary:"Statistiche aggregate delle sessioni",operationId:"getAnalyticsSessions",parameters:[{$ref:"#/components/parameters/projectQuery"}],responses:{200:{description:"Statistiche sessioni",content:{"application/json":{schema:{$ref:"#/components/schemas/SessionStats"}}}},400:f("Nome progetto non valido"),500:f("Analytics sessions fallita")}}},"/api/analytics/anomalies":{get:{tags:["Analytics"],summary:"Rilevamento anomalie sessioni tramite z-score",operationId:"getAnomalies",parameters:[{name:"project",in:"query",required:!0,schema:{type:"string"},description:"Nome progetto (obbligatorio)"},{name:"window",in:"query",schema:{type:"integer",default:20,minimum:3,maximum:200},description:"Dimensione finestra rolling"},{name:"threshold",in:"query",schema:{type:"number",default:2,minimum:.1,maximum:10},description:"Soglia z-score per segnalare anomalia"}],responses:{200:{description:"Anomalie rilevate",content:{"application/json":{schema:{type:"object",properties:{anomalies:{type:"array",items:{$ref:"#/components/schemas/AnomalyEntry"}},baseline:{type:"number"},project:{type:"string"}}}}}},400:f("Parametro project obbligatorio o threshold non valida"),500:f("Rilevamento anomalie fallito")}}},"/api/sessions":{get:{tags:["Sessions"],summary:"Lista sessioni (max 50)",operationId:"listSessions",parameters:[{$ref:"#/components/parameters/projectQuery"}],responses:{200:{description:"Lista sessioni",content:{"application/json":{schema:{type:"array",items:{$ref:"#/components/schemas/Session"}}}}},400:f("Nome progetto non valido"),500:f("Errore interno")}}},"/api/sessions/{id}/checkpoint":{get:{tags:["Sessions"],summary:"Ultimo checkpoint di una sessione",operationId:"getSessionCheckpoint",parameters:[{name:"id",in:"path",required:!0,schema:{type:"integer",minimum:1},description:"ID numerico della sessione"}],responses:{200:{description:"Checkpoint trovato",content:{"application/json":{schema:{$ref:"#/components/schemas/Checkpoint"}}}},400:f("ID sessione non valido"),404:f("Nessun checkpoint trovato per questa sessione"),500:f("Errore interno")}}},"/api/checkpoint":{get:{tags:["Sessions"],summary:"Ultimo checkpoint del progetto",operationId:"getProjectCheckpoint",parameters:[{name:"project",in:"query",required:!0,schema:{type:"string"},description:"Nome progetto (obbligatorio)"}],responses:{200:{description:"Checkpoint trovato",content:{"application/json":{schema:{$ref:"#/components/schemas/Checkpoint"}}}},400:f("Parametro project mancante o non valido"),404:f("Nessun checkpoint trovato per questo progetto"),500:f("Errore interno")}}},"/api/prompts":{get:{tags:["Sessions"],summary:"Lista prompt utente paginata",operationId:"listPrompts",parameters:[{$ref:"#/components/parameters/offsetQuery"},{name:"limit",in:"query",schema:{type:"integer",default:20,minimum:1,maximum:200}},{$ref:"#/components/parameters/projectQuery"}],responses:{200:At({$ref:"#/components/schemas/Prompt"}),500:f("Errore interno")}}},"/api/projects":{get:{tags:["Projects"],summary:"Lista nomi progetto distinti (cache 60s)",operationId:"listProjects",responses:{200:{description:"Array di nomi progetto",content:{"application/json":{schema:{type:"array",items:{type:"string"}}}}},500:f("Errore interno")}}},"/api/project-aliases":{get:{tags:["Projects"],summary:"Mappa alias \u2192 display name",operationId:"getProjectAliases",responses:{200:{description:"Oggetto `{ project_name: display_name }`",content:{"application/json":{schema:{type:"object",additionalProperties:{type:"string"}}}}},500:f("Errore interno")}}},"/api/project-aliases/{project}":{put:{tags:["Projects"],summary:"Crea o aggiorna display name di un progetto",operationId:"upsertProjectAlias",parameters:[{name:"project",in:"path",required:!0,schema:{type:"string"},description:"Nome tecnico del progetto"}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",required:["displayName"],properties:{displayName:{type:"string",maxLength:100}}}}}},responses:{200:{description:"Alias aggiornato",content:{"application/json":{schema:{type:"object",properties:{ok:{type:"boolean"},project_name:{type:"string"},display_name:{type:"string"}}}}}},400:f("Payload non valido o nome progetto non valido"),500:f("Errore interno")}}},"/api/stats/{project}":{get:{tags:["Projects"],summary:"Statistiche aggregate per progetto",operationId:"getProjectStats",parameters:[{name:"project",in:"path",required:!0,schema:{type:"string"},description:"Nome del progetto"}],responses:{200:{description:"Statistiche progetto",content:{"application/json":{schema:{$ref:"#/components/schemas/ProjectStats"}}}},400:f("Nome progetto non valido"),500:f("Errore interno")}}},"/api/embeddings/backfill":{post:{tags:["Data"],summary:"Backfill embedding per osservazioni senza vettore",operationId:"backfillEmbeddings",security:[{workerToken:[]}],requestBody:{content:{"application/json":{schema:{type:"object",properties:{batchSize:{type:"integer",default:50,minimum:1,maximum:500}}}}}},responses:{200:{description:"Backfill completato",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"},generated:{type:"integer",description:"Embedding generati"}}}}}},401:f("Token non valido"),500:f("Backfill fallito")}}},"/api/embeddings/stats":{get:{tags:["Data"],summary:"Statistiche embedding vettoriali",operationId:"getEmbeddingStats",responses:{200:{description:"Statistiche embedding",content:{"application/json":{schema:{$ref:"#/components/schemas/EmbeddingStats"}}}},500:f("Errore interno")}}},"/api/retention/cleanup":{post:{tags:["Data"],summary:"Pulizia dati secondo policy di retention",description:"Elimina osservazioni, sommari e prompt pi\xF9 vecchi di `maxAgeDays` giorni. Supporta modalit\xE0 dry-run.",operationId:"runRetentionCleanup",security:[{workerToken:[]}],requestBody:{content:{"application/json":{schema:{type:"object",properties:{maxAgeDays:{type:"integer",default:90,minimum:7,maximum:730,description:"Et\xE0 massima in giorni"},dryRun:{type:"boolean",default:!1,description:"Se true, simula senza eliminare"}}}}}},responses:{200:{description:"Cleanup eseguito o simulato",content:{"application/json":{schema:{oneOf:[{description:"Risultato dry-run",type:"object",properties:{dryRun:{type:"boolean"},maxAgeDays:{type:"integer"},wouldDelete:{type:"object",properties:{observations:{type:"integer"},summaries:{type:"integer"},prompts:{type:"integer"}}}}},{description:"Risultato cleanup reale",type:"object",properties:{success:{type:"boolean"},maxAgeDays:{type:"integer"},deleted:{type:"object",properties:{observations:{type:"integer"},summaries:{type:"integer"},prompts:{type:"integer"}}}}}]}}}},401:f("Token non valido"),500:f("Cleanup fallito")}}},"/api/export":{get:{tags:["Data"],summary:"Esporta osservazioni e sommari",description:"Esporta i dati in formato JSON (default) o Markdown.",operationId:"exportData",parameters:[{$ref:"#/components/parameters/projectQuery"},{name:"format",in:"query",schema:{type:"string",enum:["json","markdown","md"],default:"json"},description:"Formato di output"},{name:"type",in:"query",schema:{type:"string"},description:"Filtra per tipo osservazione"},{name:"days",in:"query",schema:{type:"integer",default:30,minimum:1,maximum:365},description:"Finestra temporale in giorni"}],responses:{200:{description:"Export in formato selezionato",content:{"application/json":{schema:{$ref:"#/components/schemas/ExportData"}},"text/markdown":{schema:{type:"string"}}}},400:f("Nome progetto non valido"),500:f("Export fallito")}}},"/api/report":{get:{tags:["Data"],summary:"Report attivit\xE0 (weekly/monthly)",operationId:"getReport",parameters:[{$ref:"#/components/parameters/projectQuery"},{name:"period",in:"query",schema:{type:"string",enum:["weekly","monthly"],default:"weekly"},description:"Periodo del report"},{name:"format",in:"query",schema:{type:"string",enum:["json","markdown","md","text"],default:"json"},description:"Formato di output"}],responses:{200:{description:"Report generato",content:{"application/json":{schema:{type:"object",additionalProperties:!0}},"text/markdown":{schema:{type:"string"}},"text/plain":{schema:{type:"string"}}}},400:f("Nome progetto non valido"),500:f("Generazione report fallita")}}},"/api/docs":{get:{tags:["Docs"],summary:"Swagger UI interattiva",operationId:"getSwaggerUI",responses:{200:{description:"Pagina HTML Swagger UI",content:{"text/html":{schema:{type:"string"}}}}}}},"/api/docs/openapi.json":{get:{tags:["Docs"],summary:"Specifica OpenAPI 3.1 in formato JSON",operationId:"getOpenApiSpec",responses:{200:{description:"Specifica OpenAPI 3.1",content:{"application/json":{schema:{type:"object",additionalProperties:!0}}}}}}}},tags:[{name:"Core",description:"Health check, SSE, notifiche interne"},{name:"Observations",description:"CRUD osservazioni, knowledge, memoria"},{name:"Summaries",description:"Sommari di sessione"},{name:"Search",description:"Ricerca FTS5, vettoriale ibrida, timeline"},{name:"Analytics",description:"Overview, distribuzione, anomalie"},{name:"Sessions",description:"Sessioni, checkpoint, prompt"},{name:"Projects",description:"Lista progetti, alias, statistiche"},{name:"Data",description:"Embedding, retention, export, report"},{name:"Docs",description:"Documentazione API interattiva"}]};function Co(t){return`<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kiro Memory API \u2014 Documentazione</title>
  <meta name="description" content="Documentazione interattiva dell'API REST di Kiro Memory" />
  <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5/swagger-ui.css" />
  <style>
    /* Stile minimo per rimuovere il banner Swagger */
    .swagger-ui .topbar { display: none; }
    body { margin: 0; background: #fafafa; }
    #kiro-header {
      background: #1a1a2e;
      color: #e0e0e0;
      padding: 14px 24px;
      font-family: system-ui, sans-serif;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #kiro-header h1 { margin: 0; font-size: 1.1rem; font-weight: 600; }
    #kiro-header .badge {
      background: #16213e;
      border: 1px solid #0f3460;
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 0.75rem;
      color: #94a3b8;
    }
  </style>
</head>
<body>
  <div id="kiro-header">
    <h1>Kiro Memory REST API</h1>
    <span class="badge">v${He.info.version}</span>
    <span class="badge">OpenAPI 3.1</span>
  </div>
  <div id="swagger-ui"></div>
  <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-bundle.js"></script>
  <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-standalone-preset.js"></script>
  <script>
    window.onload = function () {
      SwaggerUIBundle({
        url: '${t}',
        dom_id: '#swagger-ui',
        deepLinking: true,
        presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
        layout: 'StandaloneLayout',
        tryItOutEnabled: true,
        requestSnippetsEnabled: true,
        displayRequestDuration: true,
        filter: true,
        defaultModelsExpandDepth: 1,
        defaultModelExpandDepth: 2,
        docExpansion: 'list'
      });
    };
  </script>
</body>
</html>`}function as(){let t=jo();return t.get("/api/docs/openapi.json",(e,r)=>{r.setHeader("Cache-Control","public, max-age=300"),r.json(He)}),t.get("/api/docs",(e,r)=>{let s=Co("/api/docs/openapi.json");r.setHeader("Content-Type","text/html; charset=utf-8"),r.setHeader("Cache-Control","public, max-age=300"),r.send(s)}),t}var us=Lo(Po(import.meta.url)),de=process.env.KIRO_MEMORY_WORKER_PORT||process.env.CONTEXTKIT_WORKER_PORT||3001,jt=process.env.KIRO_MEMORY_WORKER_HOST||process.env.CONTEXTKIT_WORKER_HOST||"127.0.0.1",le=Lt(D,"worker.pid"),Ct=Lt(D,"worker.token");Ue(D)||ko(D,{recursive:!0});var kt=xo.randomBytes(32).toString("hex");ps(Ct,kt,"utf-8");try{Mo(Ct,384)}catch(t){process.platform!=="win32"&&d.warn("WORKER",`chmod 600 failed on ${Ct}`,{},t)}var Nt=new V;d.info("WORKER","Database initialized");ae().initialize().catch(t=>{d.warn("WORKER","Embedding initialization failed, FTS5 search only",{},t)});var K=Fr(Nt),C=xt();C.use(Jt({contentSecurityPolicy:{directives:{defaultSrc:["'self'"],scriptSrc:["'self'","'unsafe-inline'"],styleSrc:["'self'","'unsafe-inline'","https://fonts.googleapis.com"],imgSrc:["'self'","data:"],connectSrc:["'self'"],fontSrc:["'self'","https://fonts.gstatic.com"],frameSrc:["'none'"]}}}));C.use(No({origin:[`http://localhost:${de}`,`http://127.0.0.1:${de}`,`http://${jt}:${de}`],credentials:!0,maxAge:86400}));C.use(xt.json({limit:"1mb"}));C.use("/api/",Ne({windowMs:6e4,max:200,standardHeaders:!0,legacyHeaders:!1,message:{error:"Too many requests, retry later"}}));C.use(Kr(K,kt));C.use(Gr(K));C.use(Xr(K));C.use(zr(K));C.use(Zr(K));C.use(es(K));C.use(ts(K));C.use(ss(K,kt));C.use(as());C.use(xt.static(us,{index:!1,maxAge:"1h"}));C.get("/",(t,e)=>{let r=Lt(us,"viewer.html");Ue(r)?e.sendFile(r):e.status(404).json({error:"Viewer not found. Run npm run build first."})});var $o=C.listen(Number(de),jt,()=>{d.info("WORKER",`Kiro Memory worker started on http://${jt}:${de}`),ps(le,String(process.pid),"utf-8")});function Mt(t){d.info("WORKER",`Received ${t}, shutting down...`);let e=pe();for(let s of e)try{s.end()}catch{}let r=setTimeout(()=>{d.warn("WORKER","Forced shutdown after 5s timeout"),Ue(le)&&cs(le),Nt.close(),process.exit(1)},5e3);$o.close(()=>{clearTimeout(r),d.info("WORKER","Server closed"),Ue(le)&&cs(le),Nt.close(),process.exit(0)})}process.on("SIGTERM",()=>Mt("SIGTERM"));process.on("SIGINT",()=>Mt("SIGINT"));process.on("uncaughtException",t=>{d.error("WORKER","Uncaught exception",{},t),Mt("uncaughtException")});process.on("unhandledRejection",t=>{d.error("WORKER","Unhandled promise rejection",{reason:t},t)});
//# sourceMappingURL=worker-service.js.map
