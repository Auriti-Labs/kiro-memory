import { createRequire } from 'module';const require = createRequire(import.meta.url);
var us=Object.create;var He=Object.defineProperty;var ls=Object.getOwnPropertyDescriptor;var ds=Object.getOwnPropertyNames;var ps=Object.getPrototypeOf,ms=Object.prototype.hasOwnProperty;var pe=(t,e)=>()=>(t&&(e=t(t=0)),e);var B=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),Ht=(t,e)=>{for(var r in e)He(t,r,{get:e[r],enumerable:!0})},fs=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ds(e))!ms.call(t,n)&&n!==r&&He(t,n,{get:()=>e[n],enumerable:!(s=ls(e,n))||s.enumerable});return t};var gs=(t,e,r)=>(r=t!=null?us(ps(t)):{},fs(e||!t||!t.__esModule?He(r,"default",{value:t,enumerable:!0}):r,t));var _e=B(G=>{"use strict";Object.defineProperty(G,"__esModule",{value:!0});G.isInSubnet=Ms;G.isCorrect=ks;G.numberToPaddedHex=Xt;G.stringToPaddedHex=Ps;G.testBit=Fs;function Ms(t){return this.subnetMask<t.subnetMask?!1:this.mask(t.subnetMask)===t.mask()}function ks(t){return function(){return this.addressMinusSuffix!==this.correctForm()?!1:this.subnetMask===t&&!this.parsedSubnet?!0:this.parsedSubnet===String(this.subnetMask)}}function Xt(t){return t.toString(16).padStart(2,"0")}function Ps(t){return Xt(parseInt(t,10))}function Fs(t,e){let{length:r}=t;if(e>r)return!1;let s=r-e;return t.substring(s,s+1)==="1"}});var Xe=B(M=>{"use strict";Object.defineProperty(M,"__esModule",{value:!0});M.RE_SUBNET_STRING=M.RE_ADDRESS=M.GROUPS=M.BITS=void 0;M.BITS=32;M.GROUPS=4;M.RE_ADDRESS=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/g;M.RE_SUBNET_STRING=/\/\d{1,2}$/});var ve=B(Te=>{"use strict";Object.defineProperty(Te,"__esModule",{value:!0});Te.AddressError=void 0;var Ye=class extends Error{constructor(e,r){super(e),this.name="AddressError",this.parseMessage=r}};Te.AddressError=Ye});var ze=B(k=>{"use strict";var Bs=k&&k.__createBinding||(Object.create?(function(t,e,r,s){s===void 0&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}):(function(t,e,r,s){s===void 0&&(s=r),t[s]=e[r]})),$s=k&&k.__setModuleDefault||(Object.create?(function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}):function(t,e){t.default=e}),Vt=k&&k.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&Bs(e,t,r);return $s(e,t),e};Object.defineProperty(k,"__esModule",{value:!0});k.Address4=void 0;var J=Vt(_e()),L=Vt(Xe()),Yt=ve(),Ve=class t{constructor(e){this.groups=L.GROUPS,this.parsedAddress=[],this.parsedSubnet="",this.subnet="/32",this.subnetMask=32,this.v4=!0,this.isCorrect=J.isCorrect(L.BITS),this.isInSubnet=J.isInSubnet,this.address=e;let r=L.RE_SUBNET_STRING.exec(e);if(r){if(this.parsedSubnet=r[0].replace("/",""),this.subnetMask=parseInt(this.parsedSubnet,10),this.subnet=`/${this.subnetMask}`,this.subnetMask<0||this.subnetMask>L.BITS)throw new Yt.AddressError("Invalid subnet mask.");e=e.replace(L.RE_SUBNET_STRING,"")}this.addressMinusSuffix=e,this.parsedAddress=this.parse(e)}static isValid(e){try{return new t(e),!0}catch{return!1}}parse(e){let r=e.split(".");if(!e.match(L.RE_ADDRESS))throw new Yt.AddressError("Invalid IPv4 address.");return r}correctForm(){return this.parsedAddress.map(e=>parseInt(e,10)).join(".")}static fromHex(e){let r=e.replace(/:/g,"").padStart(8,"0"),s=[],n;for(n=0;n<8;n+=2){let o=r.slice(n,n+2);s.push(parseInt(o,16))}return new t(s.join("."))}static fromInteger(e){return t.fromHex(e.toString(16))}static fromArpa(e){let s=e.replace(/(\.in-addr\.arpa)?\.$/,"").split(".").reverse().join(".");return new t(s)}toHex(){return this.parsedAddress.map(e=>J.stringToPaddedHex(e)).join(":")}toArray(){return this.parsedAddress.map(e=>parseInt(e,10))}toGroup6(){let e=[],r;for(r=0;r<L.GROUPS;r+=2)e.push(`${J.stringToPaddedHex(this.parsedAddress[r])}${J.stringToPaddedHex(this.parsedAddress[r+1])}`);return e.join(":")}bigInt(){return BigInt(`0x${this.parsedAddress.map(e=>J.stringToPaddedHex(e)).join("")}`)}_startAddress(){return BigInt(`0b${this.mask()+"0".repeat(L.BITS-this.subnetMask)}`)}startAddress(){return t.fromBigInt(this._startAddress())}startAddressExclusive(){let e=BigInt("1");return t.fromBigInt(this._startAddress()+e)}_endAddress(){return BigInt(`0b${this.mask()+"1".repeat(L.BITS-this.subnetMask)}`)}endAddress(){return t.fromBigInt(this._endAddress())}endAddressExclusive(){let e=BigInt("1");return t.fromBigInt(this._endAddress()-e)}static fromBigInt(e){return t.fromHex(e.toString(16))}mask(e){return e===void 0&&(e=this.subnetMask),this.getBitsBase2(0,e)}getBitsBase2(e,r){return this.binaryZeroPad().slice(e,r)}reverseForm(e){e||(e={});let r=this.correctForm().split(".").reverse().join(".");return e.omitSuffix?r:`${r}.in-addr.arpa.`}isMulticast(){return this.isInSubnet(new t("224.0.0.0/4"))}binaryZeroPad(){return this.bigInt().toString(2).padStart(L.BITS,"0")}groupForV6(){let e=this.parsedAddress;return this.address.replace(L.RE_ADDRESS,`<span class="hover-group group-v4 group-6">${e.slice(0,2).join(".")}</span>.<span class="hover-group group-v4 group-7">${e.slice(2,4).join(".")}</span>`)}};k.Address4=Ve});var Je=B(_=>{"use strict";Object.defineProperty(_,"__esModule",{value:!0});_.RE_URL_WITH_PORT=_.RE_URL=_.RE_ZONE_STRING=_.RE_SUBNET_STRING=_.RE_BAD_ADDRESS=_.RE_BAD_CHARACTERS=_.TYPES=_.SCOPES=_.GROUPS=_.BITS=void 0;_.BITS=128;_.GROUPS=8;_.SCOPES={0:"Reserved",1:"Interface local",2:"Link local",4:"Admin local",5:"Site local",8:"Organization local",14:"Global",15:"Reserved"};_.TYPES={"ff01::1/128":"Multicast (All nodes on this interface)","ff01::2/128":"Multicast (All routers on this interface)","ff02::1/128":"Multicast (All nodes on this link)","ff02::2/128":"Multicast (All routers on this link)","ff05::2/128":"Multicast (All routers in this site)","ff02::5/128":"Multicast (OSPFv3 AllSPF routers)","ff02::6/128":"Multicast (OSPFv3 AllDR routers)","ff02::9/128":"Multicast (RIP routers)","ff02::a/128":"Multicast (EIGRP routers)","ff02::d/128":"Multicast (PIM routers)","ff02::16/128":"Multicast (MLDv2 reports)","ff01::fb/128":"Multicast (mDNSv6)","ff02::fb/128":"Multicast (mDNSv6)","ff05::fb/128":"Multicast (mDNSv6)","ff02::1:2/128":"Multicast (All DHCP servers and relay agents on this link)","ff05::1:2/128":"Multicast (All DHCP servers and relay agents in this site)","ff02::1:3/128":"Multicast (All DHCP servers on this link)","ff05::1:3/128":"Multicast (All DHCP servers in this site)","::/128":"Unspecified","::1/128":"Loopback","ff00::/8":"Multicast","fe80::/10":"Link-local unicast"};_.RE_BAD_CHARACTERS=/([^0-9a-f:/%])/gi;_.RE_BAD_ADDRESS=/([0-9a-f]{5,}|:{3,}|[^:]:$|^:[^:]|\/$)/gi;_.RE_SUBNET_STRING=/\/\d{1,3}(?=%|$)/;_.RE_ZONE_STRING=/%.*$/;_.RE_URL=/^\[{0,1}([0-9a-f:]+)\]{0,1}/;_.RE_URL_WITH_PORT=/\[([0-9a-f:]+)\]:([0-9]{1,5})/});var Ze=B(Z=>{"use strict";Object.defineProperty(Z,"__esModule",{value:!0});Z.spanAllZeroes=zt;Z.spanAll=Hs;Z.spanLeadingZeroes=Us;Z.simpleGroup=qs;function zt(t){return t.replace(/(0+)/g,'<span class="zero">$1</span>')}function Hs(t,e=0){return t.split("").map((s,n)=>`<span class="digit value-${s} position-${n+e}">${zt(s)}</span>`).join("")}function Jt(t){return t.replace(/^(0+)/,'<span class="zero">$1</span>')}function Us(t){return t.split(":").map(r=>Jt(r)).join(":")}function qs(t,e=0){return t.split(":").map((s,n)=>/group-v4/.test(s)?s:`<span class="hover-group group-${n+e}">${Jt(s)}</span>`)}});var Zt=B(x=>{"use strict";var Ws=x&&x.__createBinding||(Object.create?(function(t,e,r,s){s===void 0&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}):(function(t,e,r,s){s===void 0&&(s=r),t[s]=e[r]})),Ks=x&&x.__setModuleDefault||(Object.create?(function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}):function(t,e){t.default=e}),Gs=x&&x.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&Ws(e,t,r);return Ks(e,t),e};Object.defineProperty(x,"__esModule",{value:!0});x.ADDRESS_BOUNDARY=void 0;x.groupPossibilities=Oe;x.padGroup=Re;x.simpleRegularExpression=Ys;x.possibleElisions=Vs;var Xs=Gs(Je());function Oe(t){return`(${t.join("|")})`}function Re(t){return t.length<4?`0{0,${4-t.length}}${t}`:t}x.ADDRESS_BOUNDARY="[^A-Fa-f0-9:]";function Ys(t){let e=[];t.forEach((s,n)=>{parseInt(s,16)===0&&e.push(n)});let r=e.map(s=>t.map((n,o)=>{if(o===s){let i=o===0||o===Xs.GROUPS-1?":":"";return Oe([Re(n),i])}return Re(n)}).join(":"));return r.push(t.map(Re).join(":")),Oe(r)}function Vs(t,e,r){let s=e?"":":",n=r?"":":",o=[];!e&&!r&&o.push("::"),e&&r&&o.push(""),(r&&!e||!r&&e)&&o.push(":"),o.push(`${s}(:0{1,4}){1,${t-1}}`),o.push(`(0{1,4}:){1,${t-1}}${n}`),o.push(`(0{1,4}:){${t-1}}0{1,4}`);for(let i=1;i<t-1;i++)for(let a=1;a<t-i;a++)o.push(`(0{1,4}:){${a}}:(0{1,4}:){${t-a-i-1}}0{1,4}`);return Oe(o)}});var rr=B(P=>{"use strict";var zs=P&&P.__createBinding||(Object.create?(function(t,e,r,s){s===void 0&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}):(function(t,e,r,s){s===void 0&&(s=r),t[s]=e[r]})),Js=P&&P.__setModuleDefault||(Object.create?(function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}):function(t,e){t.default=e}),Ie=P&&P.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&zs(e,t,r);return Js(e,t),e};Object.defineProperty(P,"__esModule",{value:!0});P.Address6=void 0;var Qt=Ie(_e()),Qe=Ie(Xe()),b=Ie(Je()),et=Ie(Ze()),X=ze(),Y=Zt(),$=ve(),we=_e();function De(t){if(!t)throw new Error("Assertion failed.")}function Zs(t){let e=/(\d+)(\d{3})/;for(;e.test(t);)t=t.replace(e,"$1,$2");return t}function Qs(t){return t=t.replace(/^(0{1,})([1-9]+)$/,'<span class="parse-error">$1</span>$2'),t=t.replace(/^(0{1,})(0)$/,'<span class="parse-error">$1</span>$2'),t}function en(t,e){let r=[],s=[],n;for(n=0;n<t.length;n++)n<e[0]?r.push(t[n]):n>e[1]&&s.push(t[n]);return r.concat(["compact"]).concat(s)}function er(t){return parseInt(t,16).toString(16).padStart(4,"0")}function tr(t){return t&255}var tt=class t{constructor(e,r){this.addressMinusSuffix="",this.parsedSubnet="",this.subnet="/128",this.subnetMask=128,this.v4=!1,this.zone="",this.isInSubnet=Qt.isInSubnet,this.isCorrect=Qt.isCorrect(b.BITS),r===void 0?this.groups=b.GROUPS:this.groups=r,this.address=e;let s=b.RE_SUBNET_STRING.exec(e);if(s){if(this.parsedSubnet=s[0].replace("/",""),this.subnetMask=parseInt(this.parsedSubnet,10),this.subnet=`/${this.subnetMask}`,Number.isNaN(this.subnetMask)||this.subnetMask<0||this.subnetMask>b.BITS)throw new $.AddressError("Invalid subnet mask.");e=e.replace(b.RE_SUBNET_STRING,"")}else if(/\//.test(e))throw new $.AddressError("Invalid subnet mask.");let n=b.RE_ZONE_STRING.exec(e);n&&(this.zone=n[0],e=e.replace(b.RE_ZONE_STRING,"")),this.addressMinusSuffix=e,this.parsedAddress=this.parse(this.addressMinusSuffix)}static isValid(e){try{return new t(e),!0}catch{return!1}}static fromBigInt(e){let r=e.toString(16).padStart(32,"0"),s=[],n;for(n=0;n<b.GROUPS;n++)s.push(r.slice(n*4,(n+1)*4));return new t(s.join(":"))}static fromURL(e){let r,s=null,n;if(e.indexOf("[")!==-1&&e.indexOf("]:")!==-1){if(n=b.RE_URL_WITH_PORT.exec(e),n===null)return{error:"failed to parse address with port",address:null,port:null};r=n[1],s=n[2]}else if(e.indexOf("/")!==-1){if(e=e.replace(/^[a-z0-9]+:\/\//,""),n=b.RE_URL.exec(e),n===null)return{error:"failed to parse address from URL",address:null,port:null};r=n[1]}else r=e;return s?(s=parseInt(s,10),(s<0||s>65536)&&(s=null)):s=null,{address:new t(r),port:s}}static fromAddress4(e){let r=new X.Address4(e),s=b.BITS-(Qe.BITS-r.subnetMask);return new t(`::ffff:${r.correctForm()}/${s}`)}static fromArpa(e){let r=e.replace(/(\.ip6\.arpa)?\.$/,""),s=7;if(r.length!==63)throw new $.AddressError("Invalid 'ip6.arpa' form.");let n=r.split(".").reverse();for(let o=s;o>0;o--){let i=o*4;n.splice(i,0,":")}return r=n.join(""),new t(r)}microsoftTranscription(){return`${this.correctForm().replace(/:/g,"-")}.ipv6-literal.net`}mask(e=this.subnetMask){return this.getBitsBase2(0,e)}possibleSubnets(e=128){let r=b.BITS-this.subnetMask,s=Math.abs(e-b.BITS),n=r-s;return n<0?"0":Zs((BigInt("2")**BigInt(n)).toString(10))}_startAddress(){return BigInt(`0b${this.mask()+"0".repeat(b.BITS-this.subnetMask)}`)}startAddress(){return t.fromBigInt(this._startAddress())}startAddressExclusive(){let e=BigInt("1");return t.fromBigInt(this._startAddress()+e)}_endAddress(){return BigInt(`0b${this.mask()+"1".repeat(b.BITS-this.subnetMask)}`)}endAddress(){return t.fromBigInt(this._endAddress())}endAddressExclusive(){let e=BigInt("1");return t.fromBigInt(this._endAddress()-e)}getScope(){let e=b.SCOPES[parseInt(this.getBits(12,16).toString(10),10)];return this.getType()==="Global unicast"&&e!=="Link local"&&(e="Global"),e||"Unknown"}getType(){for(let e of Object.keys(b.TYPES))if(this.isInSubnet(new t(e)))return b.TYPES[e];return"Global unicast"}getBits(e,r){return BigInt(`0b${this.getBitsBase2(e,r)}`)}getBitsBase2(e,r){return this.binaryZeroPad().slice(e,r)}getBitsBase16(e,r){let s=r-e;if(s%4!==0)throw new Error("Length of bits to retrieve must be divisible by four");return this.getBits(e,r).toString(16).padStart(s/4,"0")}getBitsPastSubnet(){return this.getBitsBase2(this.subnetMask,b.BITS)}reverseForm(e){e||(e={});let r=Math.floor(this.subnetMask/4),s=this.canonicalForm().replace(/:/g,"").split("").slice(0,r).reverse().join(".");return r>0?e.omitSuffix?s:`${s}.ip6.arpa.`:e.omitSuffix?"":"ip6.arpa."}correctForm(){let e,r=[],s=0,n=[];for(e=0;e<this.parsedAddress.length;e++){let a=parseInt(this.parsedAddress[e],16);a===0&&s++,a!==0&&s>0&&(s>1&&n.push([e-s,e-1]),s=0)}s>1&&n.push([this.parsedAddress.length-s,this.parsedAddress.length-1]);let o=n.map(a=>a[1]-a[0]+1);if(n.length>0){let a=o.indexOf(Math.max(...o));r=en(this.parsedAddress,n[a])}else r=this.parsedAddress;for(e=0;e<r.length;e++)r[e]!=="compact"&&(r[e]=parseInt(r[e],16).toString(16));let i=r.join(":");return i=i.replace(/^compact$/,"::"),i=i.replace(/(^compact)|(compact$)/,":"),i=i.replace(/compact/,""),i}binaryZeroPad(){return this.bigInt().toString(2).padStart(b.BITS,"0")}parse4in6(e){let r=e.split(":"),n=r.slice(-1)[0].match(Qe.RE_ADDRESS);if(n){this.parsedAddress4=n[0],this.address4=new X.Address4(this.parsedAddress4);for(let o=0;o<this.address4.groups;o++)if(/^0[0-9]+/.test(this.address4.parsedAddress[o]))throw new $.AddressError("IPv4 addresses can't have leading zeroes.",e.replace(Qe.RE_ADDRESS,this.address4.parsedAddress.map(Qs).join(".")));this.v4=!0,r[r.length-1]=this.address4.toGroup6(),e=r.join(":")}return e}parse(e){e=this.parse4in6(e);let r=e.match(b.RE_BAD_CHARACTERS);if(r)throw new $.AddressError(`Bad character${r.length>1?"s":""} detected in address: ${r.join("")}`,e.replace(b.RE_BAD_CHARACTERS,'<span class="parse-error">$1</span>'));let s=e.match(b.RE_BAD_ADDRESS);if(s)throw new $.AddressError(`Address failed regex: ${s.join("")}`,e.replace(b.RE_BAD_ADDRESS,'<span class="parse-error">$1</span>'));let n=[],o=e.split("::");if(o.length===2){let i=o[0].split(":"),a=o[1].split(":");i.length===1&&i[0]===""&&(i=[]),a.length===1&&a[0]===""&&(a=[]);let c=this.groups-(i.length+a.length);if(!c)throw new $.AddressError("Error parsing groups");this.elidedGroups=c,this.elisionBegin=i.length,this.elisionEnd=i.length+this.elidedGroups,n=n.concat(i);for(let u=0;u<c;u++)n.push("0");n=n.concat(a)}else if(o.length===1)n=e.split(":"),this.elidedGroups=0;else throw new $.AddressError("Too many :: groups found");if(n=n.map(i=>parseInt(i,16).toString(16)),n.length!==this.groups)throw new $.AddressError("Incorrect number of groups found");return n}canonicalForm(){return this.parsedAddress.map(er).join(":")}decimal(){return this.parsedAddress.map(e=>parseInt(e,16).toString(10).padStart(5,"0")).join(":")}bigInt(){return BigInt(`0x${this.parsedAddress.map(er).join("")}`)}to4(){let e=this.binaryZeroPad().split("");return X.Address4.fromHex(BigInt(`0b${e.slice(96,128).join("")}`).toString(16))}to4in6(){let e=this.to4(),s=new t(this.parsedAddress.slice(0,6).join(":"),6).correctForm(),n="";return/:$/.test(s)||(n=":"),s+n+e.address}inspectTeredo(){let e=this.getBitsBase16(0,32),s=(this.getBits(80,96)^BigInt("0xffff")).toString(),n=X.Address4.fromHex(this.getBitsBase16(32,64)),o=this.getBits(96,128),i=X.Address4.fromHex((o^BigInt("0xffffffff")).toString(16)),a=this.getBitsBase2(64,80),c=(0,we.testBit)(a,15),u=(0,we.testBit)(a,14),d=(0,we.testBit)(a,8),l=(0,we.testBit)(a,9),m=BigInt(`0b${a.slice(2,6)+a.slice(8,16)}`).toString(10);return{prefix:`${e.slice(0,4)}:${e.slice(4,8)}`,server4:n.address,client4:i.address,flags:a,coneNat:c,microsoft:{reserved:u,universalLocal:l,groupIndividual:d,nonce:m},udpPort:s}}inspect6to4(){let e=this.getBitsBase16(0,16),r=X.Address4.fromHex(this.getBitsBase16(16,48));return{prefix:e.slice(0,4),gateway:r.address}}to6to4(){if(!this.is4())return null;let e=["2002",this.getBitsBase16(96,112),this.getBitsBase16(112,128),"","/16"].join(":");return new t(e)}toByteArray(){let e=this.bigInt().toString(16),s=`${"0".repeat(e.length%2)}${e}`,n=[];for(let o=0,i=s.length;o<i;o+=2)n.push(parseInt(s.substring(o,o+2),16));return n}toUnsignedByteArray(){return this.toByteArray().map(tr)}static fromByteArray(e){return this.fromUnsignedByteArray(e.map(tr))}static fromUnsignedByteArray(e){let r=BigInt("256"),s=BigInt("0"),n=BigInt("1");for(let o=e.length-1;o>=0;o--)s+=n*BigInt(e[o].toString(10)),n*=r;return t.fromBigInt(s)}isCanonical(){return this.addressMinusSuffix===this.canonicalForm()}isLinkLocal(){return this.getBitsBase2(0,64)==="1111111010000000000000000000000000000000000000000000000000000000"}isMulticast(){return this.getType()==="Multicast"}is4(){return this.v4}isTeredo(){return this.isInSubnet(new t("2001::/32"))}is6to4(){return this.isInSubnet(new t("2002::/16"))}isLoopback(){return this.getType()==="Loopback"}href(e){return e===void 0?e="":e=`:${e}`,`http://[${this.correctForm()}]${e}/`}link(e){e||(e={}),e.className===void 0&&(e.className=""),e.prefix===void 0&&(e.prefix="/#address="),e.v4===void 0&&(e.v4=!1);let r=this.correctForm;e.v4&&(r=this.to4in6);let s=r.call(this);return e.className?`<a href="${e.prefix}${s}" class="${e.className}">${s}</a>`:`<a href="${e.prefix}${s}">${s}</a>`}group(){if(this.elidedGroups===0)return et.simpleGroup(this.address).join(":");De(typeof this.elidedGroups=="number"),De(typeof this.elisionBegin=="number");let e=[],[r,s]=this.address.split("::");r.length?e.push(...et.simpleGroup(r)):e.push("");let n=["hover-group"];for(let o=this.elisionBegin;o<this.elisionBegin+this.elidedGroups;o++)n.push(`group-${o}`);return e.push(`<span class="${n.join(" ")}"></span>`),s.length?e.push(...et.simpleGroup(s,this.elisionEnd)):e.push(""),this.is4()&&(De(this.address4 instanceof X.Address4),e.pop(),e.push(this.address4.groupForV6())),e.join(":")}regularExpressionString(e=!1){let r=[],s=new t(this.correctForm());if(s.elidedGroups===0)r.push((0,Y.simpleRegularExpression)(s.parsedAddress));else if(s.elidedGroups===b.GROUPS)r.push((0,Y.possibleElisions)(b.GROUPS));else{let n=s.address.split("::");n[0].length&&r.push((0,Y.simpleRegularExpression)(n[0].split(":"))),De(typeof s.elidedGroups=="number"),r.push((0,Y.possibleElisions)(s.elidedGroups,n[0].length!==0,n[1].length!==0)),n[1].length&&r.push((0,Y.simpleRegularExpression)(n[1].split(":"))),r=[r.join(":")]}return e||(r=["(?=^|",Y.ADDRESS_BOUNDARY,"|[^\\w\\:])(",...r,")(?=[^\\w\\:]|",Y.ADDRESS_BOUNDARY,"|$)"]),r.join("")}regularExpression(e=!1){return new RegExp(this.regularExpressionString(e),"i")}};P.Address6=tt});var sr=B(I=>{"use strict";var tn=I&&I.__createBinding||(Object.create?(function(t,e,r,s){s===void 0&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}):(function(t,e,r,s){s===void 0&&(s=r),t[s]=e[r]})),rn=I&&I.__setModuleDefault||(Object.create?(function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}):function(t,e){t.default=e}),sn=I&&I.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&tn(e,t,r);return rn(e,t),e};Object.defineProperty(I,"__esModule",{value:!0});I.v6=I.AddressError=I.Address6=I.Address4=void 0;var nn=ze();Object.defineProperty(I,"Address4",{enumerable:!0,get:function(){return nn.Address4}});var on=rr();Object.defineProperty(I,"Address6",{enumerable:!0,get:function(){return on.Address6}});var an=ve();Object.defineProperty(I,"AddressError",{enumerable:!0,get:function(){return an.AddressError}});var cn=sn(Ze());I.v6={helpers:cn}});var _r={};Ht(_r,{getObservationsByIds:()=>se,getProjectStats:()=>ke,getStaleObservations:()=>yr,getTimeline:()=>ne,markObservationsStale:()=>Sr,searchObservationsFTS:()=>te,searchObservationsFTSWithRank:()=>Jn,searchObservationsLIKE:()=>Me,searchSummariesFiltered:()=>re});import{existsSync as Vn,statSync as zn}from"fs";function Er(t){return t.replace(/[%_\\]/g,"\\$&")}function br(t){return(t.length>1e4?t.substring(0,1e4):t).replace(/[""\u0022]/g,"").split(/\s+/).filter(s=>s.length>0).slice(0,100).map(s=>`"${s}"`).join(" ")}function te(t,e,r={}){let s=r.limit||50;try{let n=br(e);if(!n)return Me(t,e,r);let o=`
      SELECT o.* FROM observations o
      JOIN observations_fts fts ON o.id = fts.rowid
      WHERE observations_fts MATCH ?
    `,i=[n];return r.project&&(o+=" AND o.project = ?",i.push(r.project)),r.type&&(o+=" AND o.type = ?",i.push(r.type)),r.dateStart&&(o+=" AND o.created_at_epoch >= ?",i.push(r.dateStart)),r.dateEnd&&(o+=" AND o.created_at_epoch <= ?",i.push(r.dateEnd)),o+=` ORDER BY bm25(observations_fts, ${ht}) LIMIT ?`,i.push(s),t.query(o).all(...i)}catch{return Me(t,e,r)}}function Jn(t,e,r={}){let s=r.limit||50;try{let n=br(e);if(!n)return[];let o=`
      SELECT o.*, bm25(observations_fts, ${ht}) as fts5_rank FROM observations o
      JOIN observations_fts fts ON o.id = fts.rowid
      WHERE observations_fts MATCH ?
    `,i=[n];return r.project&&(o+=" AND o.project = ?",i.push(r.project)),r.type&&(o+=" AND o.type = ?",i.push(r.type)),r.dateStart&&(o+=" AND o.created_at_epoch >= ?",i.push(r.dateStart)),r.dateEnd&&(o+=" AND o.created_at_epoch <= ?",i.push(r.dateEnd)),o+=` ORDER BY bm25(observations_fts, ${ht}) LIMIT ?`,i.push(s),t.query(o).all(...i)}catch{return[]}}function Me(t,e,r={}){let s=r.limit||50,n=`%${Er(e)}%`,o=`
    SELECT * FROM observations
    WHERE (title LIKE ? ESCAPE '\\' OR text LIKE ? ESCAPE '\\' OR narrative LIKE ? ESCAPE '\\' OR concepts LIKE ? ESCAPE '\\')
  `,i=[n,n,n,n];return r.project&&(o+=" AND project = ?",i.push(r.project)),r.type&&(o+=" AND type = ?",i.push(r.type)),r.dateStart&&(o+=" AND created_at_epoch >= ?",i.push(r.dateStart)),r.dateEnd&&(o+=" AND created_at_epoch <= ?",i.push(r.dateEnd)),o+=" ORDER BY created_at_epoch DESC, id DESC LIMIT ?",i.push(s),t.query(o).all(...i)}function re(t,e,r={}){let s=r.limit||20,n=`%${Er(e)}%`,o=`
    SELECT * FROM summaries
    WHERE (request LIKE ? ESCAPE '\\' OR learned LIKE ? ESCAPE '\\' OR completed LIKE ? ESCAPE '\\' OR notes LIKE ? ESCAPE '\\' OR next_steps LIKE ? ESCAPE '\\')
  `,i=[n,n,n,n,n];return r.project&&(o+=" AND project = ?",i.push(r.project)),r.dateStart&&(o+=" AND created_at_epoch >= ?",i.push(r.dateStart)),r.dateEnd&&(o+=" AND created_at_epoch <= ?",i.push(r.dateEnd)),o+=" ORDER BY created_at_epoch DESC, id DESC LIMIT ?",i.push(s),t.query(o).all(...i)}function se(t,e){if(!Array.isArray(e)||e.length===0)return[];let r=e.filter(i=>typeof i=="number"&&Number.isInteger(i)&&i>0).slice(0,500);if(r.length===0)return[];let n=`SELECT * FROM observations WHERE id IN (${r.map(()=>"?").join(",")}) ORDER BY created_at_epoch DESC, id DESC`;return t.query(n).all(...r)}function ne(t,e,r=5,s=5){let o=t.query("SELECT created_at_epoch FROM observations WHERE id = ?").get(e);if(!o)return[];let i=o.created_at_epoch,c=t.query(`
    SELECT id, 'observation' as type, title, text as content, project, created_at, created_at_epoch
    FROM observations
    WHERE (created_at_epoch < ? OR (created_at_epoch = ? AND id < ?))
    ORDER BY created_at_epoch DESC, id DESC
    LIMIT ?
  `).all(i,i,e,r).reverse(),d=t.query(`
    SELECT id, 'observation' as type, title, text as content, project, created_at, created_at_epoch
    FROM observations WHERE id = ?
  `).all(e),m=t.query(`
    SELECT id, 'observation' as type, title, text as content, project, created_at, created_at_epoch
    FROM observations
    WHERE (created_at_epoch > ? OR (created_at_epoch = ? AND id > ?))
    ORDER BY created_at_epoch ASC, id ASC
    LIMIT ?
  `).all(i,i,e,s);return[...c,...d,...m]}function ke(t,e){let s=t.query(`
    WITH
      obs_stats AS (
        SELECT
          COUNT(*) as count,
          COALESCE(SUM(discovery_tokens), 0) as discovery_tokens,
          COALESCE(SUM(
            CAST((LENGTH(COALESCE(title, '')) + LENGTH(COALESCE(narrative, ''))) / 4 AS INTEGER)
          ), 0) as read_tokens
        FROM observations WHERE project = ?
      ),
      sum_count AS (SELECT COUNT(*) as count FROM summaries WHERE project = ?),
      ses_count AS (SELECT COUNT(*) as count FROM sessions WHERE project = ?),
      prm_count AS (SELECT COUNT(*) as count FROM prompts WHERE project = ?)
    SELECT
      obs_stats.count as observations,
      obs_stats.discovery_tokens,
      obs_stats.read_tokens,
      sum_count.count as summaries,
      ses_count.count as sessions,
      prm_count.count as prompts
    FROM obs_stats, sum_count, ses_count, prm_count
  `).get(e,e,e,e),n=s?.discovery_tokens||0,o=s?.read_tokens||0,i=Math.max(0,n-o);return{observations:s?.observations||0,summaries:s?.summaries||0,sessions:s?.sessions||0,prompts:s?.prompts||0,tokenEconomics:{discoveryTokens:n,readTokens:o,savings:i}}}function yr(t,e){let r=t.query(`
    SELECT * FROM observations
    WHERE project = ? AND files_modified IS NOT NULL AND files_modified != ''
    ORDER BY created_at_epoch DESC, id DESC
    LIMIT 500
  `).all(e),s=[];for(let n of r){if(!n.files_modified)continue;let o=n.files_modified.split(",").map(a=>a.trim()).filter(Boolean),i=!1;for(let a of o)try{if(!Vn(a))continue;if(zn(a).mtimeMs>n.created_at_epoch){i=!0;break}}catch{}i&&s.push(n)}return s}function Sr(t,e,r){if(!Array.isArray(e)||e.length===0)return;let s=e.filter(o=>typeof o=="number"&&Number.isInteger(o)&&o>0).slice(0,500);if(s.length===0)return;let n=s.map(()=>"?").join(",");t.run(`UPDATE observations SET is_stale = ? WHERE id IN (${n})`,[r?1:0,...s])}var ht,U=pe(()=>{"use strict";ht="10.0, 1.0, 5.0, 3.0"});function Pe(t){if(!t)return t;let e=t;for(let{pattern:r}of Zn)r.lastIndex=0,e=e.replace(r,s=>`${s.substring(0,Math.min(4,s.length))}***REDACTED***`);return e}var Zn,Tr=pe(()=>{"use strict";Zn=[{name:"aws-key",pattern:/(?:AKIA|ABIA|ACCA|ASIA)[A-Z0-9]{16}/g},{name:"jwt",pattern:/eyJ[a-zA-Z0-9_-]{10,}\.eyJ[a-zA-Z0-9_-]{10,}\.[a-zA-Z0-9_-]{10,}/g},{name:"api-key",pattern:/(?:api[_-]?key|apikey|api[_-]?secret)\s*[:=]\s*['"]?([a-zA-Z0-9_\-]{20,})['"]?/gi},{name:"credential",pattern:/(?:password|passwd|pwd|secret|token|auth[_-]?token|access[_-]?token|bearer)\s*[:=]\s*['"]?([^\s'"]{8,})['"]?/gi},{name:"url-credential",pattern:/(?:https?:\/\/)([^:]+):([^@]+)@/g},{name:"private-key",pattern:/-----BEGIN (?:RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----/g},{name:"github-token",pattern:/gh[pousr]_[a-zA-Z0-9]{36,}/g},{name:"slack-token",pattern:/xox[bpoas]-[a-zA-Z0-9-]{10,}/g},{name:"bearer-header",pattern:/\bBearer\s+([a-zA-Z0-9_\-\.]{20,})/g},{name:"hex-secret",pattern:/(?:key|secret|token|password)\s*[:=]\s*['"]?([0-9a-f]{32,})['"]?/gi}]});function vr(t){let e=new Map,r=[t.title,t.text||"",t.narrative||"",t.concepts||""].join(" ").toLowerCase(),s=[t.filesModified||"",t.filesRead||""].join(",");for(let i of Qn){let a=0;for(let c of i.keywords)r.includes(c.toLowerCase())&&(a+=i.weight);if(i.types&&i.types.includes(t.type)&&(a+=i.weight*2),i.filePatterns&&s)for(let c of i.filePatterns)c.test(s)&&(a+=i.weight);a>0&&e.set(i.category,(e.get(i.category)||0)+a)}let n="general",o=0;for(let[i,a]of e)a>o&&(o=a,n=i);return n}var Qn,Rr=pe(()=>{"use strict";Qn=[{category:"security",keywords:["security","vulnerability","cve","xss","csrf","injection","sanitize","escape","auth","authentication","authorization","permission","helmet","cors","rate-limit","token","encrypt","decrypt","secret","redact","owasp"],filePatterns:[/security/i,/auth/i,/secrets?\.ts/i],weight:10},{category:"testing",keywords:["test","spec","expect","assert","mock","stub","fixture","coverage","jest","vitest","bun test","unit test","integration test","e2e"],types:["test"],filePatterns:[/\.test\./i,/\.spec\./i,/tests?\//i,/__tests__/i],weight:8},{category:"debugging",keywords:["debug","fix","bug","error","crash","stacktrace","stack trace","exception","breakpoint","investigate","root cause","troubleshoot","diagnose","bisect","regression"],types:["bugfix"],weight:8},{category:"architecture",keywords:["architect","design","pattern","modular","migration","schema","database","api design","abstract","dependency injection","singleton","factory","observer","middleware","pipeline","microservice","monolith"],types:["decision","constraint"],weight:7},{category:"refactoring",keywords:["refactor","rename","extract","inline","move","split","merge","simplify","cleanup","clean up","dead code","consolidate","reorganize","restructure","decouple"],weight:6},{category:"config",keywords:["config","configuration","env","environment","dotenv",".env","settings","tsconfig","eslint","prettier","webpack","vite","esbuild","docker","ci/cd","github actions","deploy","build","bundle","package.json"],filePatterns:[/\.config\./i,/\.env/i,/tsconfig/i,/\.ya?ml/i,/Dockerfile/i,/docker-compose/i],weight:5},{category:"docs",keywords:["document","readme","changelog","jsdoc","comment","explain","guide","tutorial","api doc","openapi","swagger"],types:["docs"],filePatterns:[/\.md$/i,/docs?\//i,/readme/i,/changelog/i],weight:5},{category:"feature-dev",keywords:["feature","implement","add","create","new","endpoint","component","module","service","handler","route","hook","plugin","integration"],types:["feature","file-write"],weight:3}]});var Ir={};Ht(Ir,{consolidateObservations:()=>Dr,createObservation:()=>Q,deleteObservation:()=>ro,getObservationsByProject:()=>Fe,getObservationsBySession:()=>to,isDuplicateObservation:()=>Or,searchObservations:()=>wr,updateLastAccessed:()=>so});function eo(t){return t.replace(/[%_\\]/g,"\\$&")}function Or(t,e,r=3e4){if(!e)return!1;let s=Date.now()-r;return!!t.query("SELECT id FROM observations WHERE content_hash = ? AND created_at_epoch > ? LIMIT 1").get(e,s)}function Q(t,e,r,s,n,o,i,a,c,u,d,l,m,f=null,g=0){let h=new Date,E=Pe(n),R=i&&Pe(i),y=a&&Pe(a),S=vr({type:s,title:E,text:R,narrative:y,concepts:u,filesModified:l,filesRead:d}),K=t.run(`INSERT INTO observations
     (memory_session_id, project, type, title, subtitle, text, narrative, facts, concepts, files_read, files_modified, prompt_number, created_at, created_at_epoch, content_hash, discovery_tokens, auto_category)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,[e,r,s,E,o,R,y,c,u,d,l,m,h.toISOString(),h.getTime(),f,g,S]);return Number(K.lastInsertRowid)}function to(t,e){return t.query("SELECT * FROM observations WHERE memory_session_id = ? ORDER BY prompt_number ASC").all(e)}function Fe(t,e,r=100){return t.query("SELECT * FROM observations WHERE project = ? ORDER BY created_at_epoch DESC, id DESC LIMIT ?").all(e,r)}function wr(t,e,r){let s=r?`SELECT * FROM observations
       WHERE project = ? AND (title LIKE ? ESCAPE '\\' OR text LIKE ? ESCAPE '\\' OR narrative LIKE ? ESCAPE '\\')
       ORDER BY created_at_epoch DESC, id DESC`:`SELECT * FROM observations
       WHERE title LIKE ? ESCAPE '\\' OR text LIKE ? ESCAPE '\\' OR narrative LIKE ? ESCAPE '\\'
       ORDER BY created_at_epoch DESC, id DESC`,n=`%${eo(e)}%`,o=t.query(s);return r?o.all(r,n,n,n):o.all(n,n,n)}function ro(t,e){t.run("DELETE FROM observations WHERE id = ?",[e])}function so(t,e){if(!Array.isArray(e)||e.length===0)return;let r=e.filter(o=>typeof o=="number"&&Number.isInteger(o)&&o>0).slice(0,500);if(r.length===0)return;let s=Date.now(),n=r.map(()=>"?").join(",");t.run(`UPDATE observations SET last_accessed_epoch = ? WHERE id IN (${n})`,[s,...r])}function Dr(t,e,r={}){let s=r.minGroupSize||3,n=t.query(`
    SELECT type, files_modified, COUNT(*) as cnt, GROUP_CONCAT(id) as ids
    FROM observations
    WHERE project = ? AND files_modified IS NOT NULL AND files_modified != ''
    GROUP BY type, files_modified
    HAVING cnt >= ?
    ORDER BY cnt DESC
  `).all(e,s);if(n.length===0)return{merged:0,removed:0};if(r.dryRun){let i=0,a=0;for(let c of n){let u=c.ids.split(",").map(Number),d=u.map(()=>"?").join(","),l=t.query(`SELECT COUNT(*) as cnt FROM observations WHERE id IN (${d})`).get(...u)?.cnt||0;l>=s&&(i+=1,a+=l-1)}return{merged:i,removed:a}}return t.transaction(()=>{let i=0,a=0;for(let c of n){let u=c.ids.split(",").map(Number),d=u.map(()=>"?").join(","),l=t.query(`SELECT * FROM observations WHERE id IN (${d}) ORDER BY created_at_epoch DESC, id DESC`).all(...u);if(l.length<s)continue;let m=l[0],f=l.slice(1),g=new Set;m.text&&g.add(m.text);for(let y of f)y.text&&!g.has(y.text)&&g.add(y.text);let h=Array.from(g).join(`
---
`).substring(0,1e5);t.run("UPDATE observations SET text = ?, title = ? WHERE id = ?",[h,`[consolidated x${l.length}] ${m.title}`,m.id]);let E=f.map(y=>y.id),R=E.map(()=>"?").join(",");t.run(`DELETE FROM observations WHERE id IN (${R})`,E),t.run(`DELETE FROM observation_embeddings WHERE observation_id IN (${R})`,E),i+=1,a+=E.length}return{merged:i,removed:a}})()}var oe=pe(()=>{"use strict";Tr();Rr()});import Dt from"express";import bo from"cors";var Ut=Symbol("dangerouslyDisableDefaultSrc"),hs=new Set(["none","self","strict-dynamic","report-sample","inline-speculation-rules","unsafe-inline","unsafe-eval","unsafe-hashes","wasm-unsafe-eval"]),qt=()=>({"default-src":["'self'"],"base-uri":["'self'"],"font-src":["'self'","https:","data:"],"form-action":["'self'"],"frame-ancestors":["'self'"],"img-src":["'self'","data:"],"object-src":["'none'"],"script-src":["'self'"],"script-src-attr":["'none'"],"style-src":["'self'","https:","'unsafe-inline'"],"upgrade-insecure-requests":[]}),Es=t=>t.replace(/[A-Z]/g,e=>"-"+e.toLowerCase()),Wt=(t,e)=>{if(/;|,/.test(e))throw new Error(`Content-Security-Policy received an invalid directive value for ${JSON.stringify(t)}`)},Kt=(t,e)=>{if(hs.has(e)||e.startsWith("nonce-")||e.startsWith("sha256-")||e.startsWith("sha384-")||e.startsWith("sha512-"))throw new Error(`Content-Security-Policy received an invalid directive value for ${JSON.stringify(t)}. ${JSON.stringify(e)} should be quoted`)};function bs(t){let e=qt(),{useDefaults:r=!0,directives:s=e}=t,n=new Map,o=new Set,i=new Set;for(let a in s){if(!Object.hasOwn(s,a))continue;if(a.length===0||/[^a-zA-Z0-9-]/.test(a))throw new Error(`Content-Security-Policy received an invalid directive name ${JSON.stringify(a)}`);let c=Es(a);if(o.has(c))throw new Error(`Content-Security-Policy received a duplicate directive ${JSON.stringify(c)}`);o.add(c);let u=s[a],d;if(u===null){if(c==="default-src")throw new Error("Content-Security-Policy needs a default-src but it was set to `null`. If you really want to disable it, set it to `contentSecurityPolicy.dangerouslyDisableDefaultSrc`.");i.add(c);continue}else if(typeof u=="string")d=[u];else if(u)if(u===Ut)if(c==="default-src"){i.add("default-src");continue}else throw new Error(`Content-Security-Policy: tried to disable ${JSON.stringify(c)} as if it were default-src; simply omit the key`);else d=u;else throw new Error(`Content-Security-Policy received an invalid directive value for ${JSON.stringify(c)}`);for(let l of d)typeof l=="string"&&(Wt(c,l),Kt(c,l));n.set(c,d)}if(r&&Object.entries(e).forEach(([a,c])=>{!n.has(a)&&!i.has(a)&&n.set(a,c)}),!n.size)throw new Error("Content-Security-Policy has no directives. Either set some or disable the header");if(!n.has("default-src")&&!i.has("default-src"))throw new Error("Content-Security-Policy needs a default-src but none was provided. If you really want to disable it, set it to `contentSecurityPolicy.dangerouslyDisableDefaultSrc`.");return n}function ys(t,e,r){let s=[];for(let[n,o]of r){let i="";for(let a of o)if(typeof a=="function"){let c=a(t,e);Kt(n,c),i+=" "+c}else i+=" "+a;i?(Wt(n,i),s.push(`${n}${i}`)):s.push(n)}return s.join(";")}var ee=function(e={}){let r=e.reportOnly?"Content-Security-Policy-Report-Only":"Content-Security-Policy",s=bs(e);return function(o,i,a){let c=ys(o,i,s);c instanceof Error?a(c):(i.setHeader(r,c),a())}};ee.getDefaultDirectives=qt;ee.dangerouslyDisableDefaultSrc=Ut;var Ss=new Set(["require-corp","credentialless","unsafe-none"]);function _s({policy:t="require-corp"}){if(Ss.has(t))return t;throw new Error(`Cross-Origin-Embedder-Policy does not support the ${JSON.stringify(t)} policy`)}function Ue(t={}){let e=_s(t);return function(s,n,o){n.setHeader("Cross-Origin-Embedder-Policy",e),o()}}var Ts=new Set(["same-origin","same-origin-allow-popups","unsafe-none"]);function vs({policy:t="same-origin"}){if(Ts.has(t))return t;throw new Error(`Cross-Origin-Opener-Policy does not support the ${JSON.stringify(t)} policy`)}function qe(t={}){let e=vs(t);return function(s,n,o){n.setHeader("Cross-Origin-Opener-Policy",e),o()}}var Rs=new Set(["same-origin","same-site","cross-origin"]);function Os({policy:t="same-origin"}){if(Rs.has(t))return t;throw new Error(`Cross-Origin-Resource-Policy does not support the ${JSON.stringify(t)} policy`)}function We(t={}){let e=Os(t);return function(s,n,o){n.setHeader("Cross-Origin-Resource-Policy",e),o()}}function Ke(){return function(e,r,s){r.setHeader("Origin-Agent-Cluster","?1"),s()}}var ws=new Set(["no-referrer","no-referrer-when-downgrade","same-origin","origin","strict-origin","origin-when-cross-origin","strict-origin-when-cross-origin","unsafe-url",""]);function Ds({policy:t=["no-referrer"]}){let e=typeof t=="string"?[t]:t;if(e.length===0)throw new Error("Referrer-Policy received no policy tokens");let r=new Set;return e.forEach(s=>{if(ws.has(s)){if(r.has(s))throw new Error(`Referrer-Policy received a duplicate policy token ${JSON.stringify(s)}`)}else throw new Error(`Referrer-Policy received an unexpected policy token ${JSON.stringify(s)}`);r.add(s)}),e.join(",")}function Ge(t={}){let e=Ds(t);return function(s,n,o){n.setHeader("Referrer-Policy",e),o()}}var Is=365*24*60*60;function Ns(t=Is){if(t>=0&&Number.isFinite(t))return Math.floor(t);throw new Error(`Strict-Transport-Security: ${JSON.stringify(t)} is not a valid value for maxAge. Please choose a positive integer.`)}function As(t){if("maxage"in t)throw new Error("Strict-Transport-Security received an unsupported property, `maxage`. Did you mean to pass `maxAge`?");if("includeSubdomains"in t)throw new Error('Strict-Transport-Security middleware should use `includeSubDomains` instead of `includeSubdomains`. (The correct one has an uppercase "D".)');let e=[`max-age=${Ns(t.maxAge)}`];return(t.includeSubDomains===void 0||t.includeSubDomains)&&e.push("includeSubDomains"),t.preload&&e.push("preload"),e.join("; ")}function me(t={}){let e=As(t);return function(s,n,o){n.setHeader("Strict-Transport-Security",e),o()}}function fe(){return function(e,r,s){r.setHeader("X-Content-Type-Options","nosniff"),s()}}function ge(t={}){let e=t.allow?"on":"off";return function(s,n,o){n.setHeader("X-DNS-Prefetch-Control",e),o()}}function he(){return function(e,r,s){r.setHeader("X-Download-Options","noopen"),s()}}function Cs({action:t="sameorigin"}){let e=typeof t=="string"?t.toUpperCase():t;switch(e){case"SAME-ORIGIN":return"SAMEORIGIN";case"DENY":case"SAMEORIGIN":return e;default:throw new Error(`X-Frame-Options received an invalid action ${JSON.stringify(t)}`)}}function Ee(t={}){let e=Cs(t);return function(s,n,o){n.setHeader("X-Frame-Options",e),o()}}var xs=new Set(["none","master-only","by-content-type","all"]);function js({permittedPolicies:t="none"}){if(xs.has(t))return t;throw new Error(`X-Permitted-Cross-Domain-Policies does not support ${JSON.stringify(t)}`)}function be(t={}){let e=js(t);return function(s,n,o){n.setHeader("X-Permitted-Cross-Domain-Policies",e),o()}}function ye(){return function(e,r,s){r.removeHeader("X-Powered-By"),s()}}function Se(){return function(e,r,s){r.setHeader("X-XSS-Protection","0"),s()}}function Ls(t){let e=[];switch(t.contentSecurityPolicy){case void 0:case!0:e.push(ee());break;case!1:break;default:e.push(ee(t.contentSecurityPolicy));break}switch(t.crossOriginEmbedderPolicy){case void 0:case!1:break;case!0:e.push(Ue());break;default:e.push(Ue(t.crossOriginEmbedderPolicy));break}switch(t.crossOriginOpenerPolicy){case void 0:case!0:e.push(qe());break;case!1:break;default:e.push(qe(t.crossOriginOpenerPolicy));break}switch(t.crossOriginResourcePolicy){case void 0:case!0:e.push(We());break;case!1:break;default:e.push(We(t.crossOriginResourcePolicy));break}switch(t.originAgentCluster){case void 0:case!0:e.push(Ke());break;case!1:break;default:console.warn("Origin-Agent-Cluster does not take options. Remove the property to silence this warning."),e.push(Ke());break}switch(t.referrerPolicy){case void 0:case!0:e.push(Ge());break;case!1:break;default:e.push(Ge(t.referrerPolicy));break}if("strictTransportSecurity"in t&&"hsts"in t)throw new Error("Strict-Transport-Security option was specified twice. Remove `hsts` to silence this warning.");let r=t.strictTransportSecurity??t.hsts;switch(r){case void 0:case!0:e.push(me());break;case!1:break;default:e.push(me(r));break}if("xContentTypeOptions"in t&&"noSniff"in t)throw new Error("X-Content-Type-Options option was specified twice. Remove `noSniff` to silence this warning.");switch(t.xContentTypeOptions??t.noSniff){case void 0:case!0:e.push(fe());break;case!1:break;default:console.warn("X-Content-Type-Options does not take options. Remove the property to silence this warning."),e.push(fe());break}if("xDnsPrefetchControl"in t&&"dnsPrefetchControl"in t)throw new Error("X-DNS-Prefetch-Control option was specified twice. Remove `dnsPrefetchControl` to silence this warning.");let n=t.xDnsPrefetchControl??t.dnsPrefetchControl;switch(n){case void 0:case!0:e.push(ge());break;case!1:break;default:e.push(ge(n));break}if("xDownloadOptions"in t&&"ieNoOpen"in t)throw new Error("X-Download-Options option was specified twice. Remove `ieNoOpen` to silence this warning.");switch(t.xDownloadOptions??t.ieNoOpen){case void 0:case!0:e.push(he());break;case!1:break;default:console.warn("X-Download-Options does not take options. Remove the property to silence this warning."),e.push(he());break}if("xFrameOptions"in t&&"frameguard"in t)throw new Error("X-Frame-Options option was specified twice. Remove `frameguard` to silence this warning.");let i=t.xFrameOptions??t.frameguard;switch(i){case void 0:case!0:e.push(Ee());break;case!1:break;default:e.push(Ee(i));break}if("xPermittedCrossDomainPolicies"in t&&"permittedCrossDomainPolicies"in t)throw new Error("X-Permitted-Cross-Domain-Policies option was specified twice. Remove `permittedCrossDomainPolicies` to silence this warning.");let a=t.xPermittedCrossDomainPolicies??t.permittedCrossDomainPolicies;switch(a){case void 0:case!0:e.push(be());break;case!1:break;default:e.push(be(a));break}if("xPoweredBy"in t&&"hidePoweredBy"in t)throw new Error("X-Powered-By option was specified twice. Remove `hidePoweredBy` to silence this warning.");switch(t.xPoweredBy??t.hidePoweredBy){case void 0:case!0:e.push(ye());break;case!1:break;default:console.warn("X-Powered-By does not take options. Remove the property to silence this warning."),e.push(ye());break}if("xXssProtection"in t&&"xssFilter"in t)throw new Error("X-XSS-Protection option was specified twice. Remove `xssFilter` to silence this warning.");switch(t.xXssProtection??t.xssFilter){case void 0:case!0:e.push(Se());break;case!1:break;default:console.warn("X-XSS-Protection does not take options. Remove the property to silence this warning."),e.push(Se());break}return e}var Gt=Object.assign(function(e={}){if(e.constructor?.name==="IncomingMessage")throw new Error("It appears you have done something like `app.use(helmet)`, but it should be `app.use(helmet())`.");let r=Ls(e);return function(n,o,i){let a=0;(function c(u){if(u){i(u);return}let d=r[a];d?(a++,d(n,o,c)):i()})()}},{contentSecurityPolicy:ee,crossOriginEmbedderPolicy:Ue,crossOriginOpenerPolicy:qe,crossOriginResourcePolicy:We,originAgentCluster:Ke,referrerPolicy:Ge,strictTransportSecurity:me,xContentTypeOptions:fe,xDnsPrefetchControl:ge,xDownloadOptions:he,xFrameOptions:Ee,xPermittedCrossDomainPolicies:be,xPoweredBy:ye,xXssProtection:Se,dnsPrefetchControl:ge,xssFilter:Se,permittedCrossDomainPolicies:be,ieNoOpen:he,noSniff:fe,frameguard:Ee,hidePoweredBy:ye,hsts:me});var ar=gs(sr(),1);import{isIPv6 as un}from"node:net";import{isIPv6 as pn}from"node:net";import{Buffer as mn}from"node:buffer";import{createHash as fn}from"node:crypto";import{isIP as Tn}from"node:net";function ln(t,e=56){return e&&un(t)?`${new ar.Address6(`${t}/${e}`).startAddress().correctForm()}/${e}`:t}var dn=class{constructor(t){this.validations=t,this.previous=new Map,this.current=new Map,this.localKeys=!0}init(t){this.windowMs=t.windowMs,this.validations?.windowMs(this.windowMs),this.interval&&clearInterval(this.interval),this.interval=setInterval(()=>{this.clearExpired()},this.windowMs),this.interval.unref?.()}async get(t){return this.current.get(t)??this.previous.get(t)}async increment(t){let e=this.getClient(t),r=Date.now();return e.resetTime.getTime()<=r&&this.resetClient(e,r),e.totalHits++,e}async decrement(t){let e=this.getClient(t);e.totalHits>0&&e.totalHits--}async resetKey(t){this.current.delete(t),this.previous.delete(t)}async resetAll(){this.current.clear(),this.previous.clear()}shutdown(){clearInterval(this.interval),this.resetAll()}resetClient(t,e=Date.now()){return t.totalHits=0,t.resetTime.setTime(e+this.windowMs),t}getClient(t){if(this.current.has(t))return this.current.get(t);let e;return this.previous.has(t)?(e=this.previous.get(t),this.previous.delete(t)):(e={totalHits:0,resetTime:new Date},this.resetClient(e)),this.current.set(t,e),e}clearExpired(){this.previous=this.current,this.current=new Map}},nr=["draft-6","draft-7","draft-8"],Ae=(t,e)=>{let r;if(e){let s=Math.ceil((e.getTime()-Date.now())/1e3);r=Math.max(0,s)}else r=Math.ceil(t/1e3);return r},gn=t=>{let e=fn("sha256");e.update(t);let r=e.digest("hex").slice(0,12);return mn.from(r).toString("base64")},hn=(t,e)=>{t.headersSent||(t.setHeader("X-RateLimit-Limit",e.limit.toString()),t.setHeader("X-RateLimit-Remaining",e.remaining.toString()),e.resetTime instanceof Date&&(t.setHeader("Date",new Date().toUTCString()),t.setHeader("X-RateLimit-Reset",Math.ceil(e.resetTime.getTime()/1e3).toString())))},En=(t,e,r)=>{if(t.headersSent)return;let s=Math.ceil(r/1e3),n=Ae(r,e.resetTime);t.setHeader("RateLimit-Policy",`${e.limit};w=${s}`),t.setHeader("RateLimit-Limit",e.limit.toString()),t.setHeader("RateLimit-Remaining",e.remaining.toString()),typeof n=="number"&&t.setHeader("RateLimit-Reset",n.toString())},bn=(t,e,r)=>{if(t.headersSent)return;let s=Math.ceil(r/1e3),n=Ae(r,e.resetTime);t.setHeader("RateLimit-Policy",`${e.limit};w=${s}`),t.setHeader("RateLimit",`limit=${e.limit}, remaining=${e.remaining}, reset=${n}`)},yn=(t,e,r,s,n)=>{if(t.headersSent)return;let o=Math.ceil(r/1e3),i=Ae(r,e.resetTime),a=gn(n),c=`r=${e.remaining}; t=${i}`,u=`q=${e.limit}; w=${o}; pk=:${a}:`;t.append("RateLimit",`"${s}"; ${c}`),t.append("RateLimit-Policy",`"${s}"; ${u}`)},Sn=(t,e,r)=>{if(t.headersSent)return;let s=Ae(r,e.resetTime);t.setHeader("Retry-After",s.toString())},_n=t=>{let e={};for(let r of Object.keys(t)){let s=r;t[s]!==void 0&&(e[s]=t[s])}return e},O=class extends Error{constructor(t,e){let r=`https://express-rate-limit.github.io/${t}/`;super(`${e} See ${r} for more information.`),this.name=this.constructor.name,this.code=t,this.help=r}},Ne=class extends O{},or=new Set,ir=new WeakMap,vn={enabled:{default:!0},disable(){for(let t of Object.keys(this.enabled))this.enabled[t]=!1},ip(t){if(t===void 0)throw new O("ERR_ERL_UNDEFINED_IP_ADDRESS","An undefined 'request.ip' was detected. This might indicate a misconfiguration or the connection being destroyed prematurely.");if(!Tn(t))throw new O("ERR_ERL_INVALID_IP_ADDRESS",`An invalid 'request.ip' (${t}) was detected. Consider passing a custom 'keyGenerator' function to the rate limiter.`)},trustProxy(t){if(t.app.get("trust proxy")===!0)throw new O("ERR_ERL_PERMISSIVE_TRUST_PROXY","The Express 'trust proxy' setting is true, which allows anyone to trivially bypass IP-based rate limiting.")},xForwardedForHeader(t){if(t.headers["x-forwarded-for"]&&t.app.get("trust proxy")===!1)throw new O("ERR_ERL_UNEXPECTED_X_FORWARDED_FOR","The 'X-Forwarded-For' header is set but the Express 'trust proxy' setting is false (default). This could indicate a misconfiguration which would prevent express-rate-limit from accurately identifying users.")},forwardedHeader(t){if(t.headers.forwarded&&t.ip===t.socket?.remoteAddress)throw new O("ERR_ERL_FORWARDED_HEADER","The 'Forwarded' header (standardized X-Forwarded-For) is set but currently being ignored. Add a custom keyGenerator to use a value from this header.")},positiveHits(t){if(typeof t!="number"||t<1||t!==Math.round(t))throw new O("ERR_ERL_INVALID_HITS",`The totalHits value returned from the store must be a positive integer, got ${t}`)},unsharedStore(t){if(or.has(t)){let e=t?.localKeys?"":" (with a unique prefix)";throw new O("ERR_ERL_STORE_REUSE",`A Store instance must not be shared across multiple rate limiters. Create a new instance of ${t.constructor.name}${e} for each limiter instead.`)}or.add(t)},singleCount(t,e,r){let s=ir.get(t);s||(s=new Map,ir.set(t,s));let n=e.localKeys?e:e.constructor.name,o=s.get(n);o||(o=[],s.set(n,o));let i=`${e.prefix??""}${r}`;if(o.includes(i))throw new O("ERR_ERL_DOUBLE_COUNT",`The hit count for ${r} was incremented more than once for a single request.`);o.push(i)},limit(t){if(t===0)throw new Ne("WRN_ERL_MAX_ZERO","Setting limit or max to 0 disables rate limiting in express-rate-limit v6 and older, but will cause all requests to be blocked in v7")},draftPolliHeaders(t){if(t)throw new Ne("WRN_ERL_DEPRECATED_DRAFT_POLLI_HEADERS","The draft_polli_ratelimit_headers configuration option is deprecated and has been removed in express-rate-limit v7, please set standardHeaders: 'draft-6' instead.")},onLimitReached(t){if(t)throw new Ne("WRN_ERL_DEPRECATED_ON_LIMIT_REACHED","The onLimitReached configuration option is deprecated and has been removed in express-rate-limit v7.")},headersDraftVersion(t){if(typeof t!="string"||!nr.includes(t)){let e=nr.join(", ");throw new O("ERR_ERL_HEADERS_UNSUPPORTED_DRAFT_VERSION",`standardHeaders: only the following versions of the IETF draft specification are supported: ${e}.`)}},headersResetTime(t){if(!t)throw new O("ERR_ERL_HEADERS_NO_RESET","standardHeaders:  'draft-7' requires a 'resetTime', but the store did not provide one. The 'windowMs' value will be used instead, which may cause clients to wait longer than necessary.")},knownOptions(t){if(!t)return;let r=Object.keys({windowMs:!0,limit:!0,message:!0,statusCode:!0,legacyHeaders:!0,standardHeaders:!0,identifier:!0,requestPropertyName:!0,skipFailedRequests:!0,skipSuccessfulRequests:!0,keyGenerator:!0,ipv6Subnet:!0,handler:!0,skip:!0,requestWasSuccessful:!0,store:!0,validate:!0,headers:!0,max:!0,passOnStoreError:!0}).concat("draft_polli_ratelimit_headers","delayAfter","delayMs","maxDelayMs");for(let s of Object.keys(t))if(!r.includes(s))throw new O("ERR_ERL_UNKNOWN_OPTION",`Unexpected configuration option: ${s}`)},validationsConfig(){let t=Object.keys(this).filter(e=>!["enabled","disable"].includes(e));t.push("default");for(let e of Object.keys(this.enabled))if(!t.includes(e))throw new O("ERR_ERL_UNKNOWN_VALIDATION",`options.validate.${e} is not recognized. Supported validate options are: ${t.join(", ")}.`)},creationStack(t){let{stack:e}=new Error("express-rate-limit validation check (set options.validate.creationStack=false to disable)");if(e?.includes("Layer.handle [as handle_request]")||e?.includes("Layer.handleRequest"))throw t.localKeys?new O("ERR_ERL_CREATED_IN_REQUEST_HANDLER","express-rate-limit instance should be created at app initialization, not when responding to a request."):new O("ERR_ERL_CREATED_IN_REQUEST_HANDLER","express-rate-limit instance should *usually* be created at app initialization, not when responding to a request.")},ipv6Subnet(t){if(t!==!1&&(!Number.isInteger(t)||t<32||t>64))throw new O("ERR_ERL_IPV6_SUBNET",`Unexpected ipv6Subnet value: ${t}. Expected an integer between 32 and 64 (usually 48-64).`)},ipv6SubnetOrKeyGenerator(t){if(t.ipv6Subnet!==void 0&&t.keyGenerator)throw new O("ERR_ERL_IPV6SUBNET_OR_KEYGENERATOR","Incompatible options: the 'ipv6Subnet' option is ignored when a custom 'keyGenerator' function is also set.")},keyGeneratorIpFallback(t){if(!t)return;let e=t.toString();if((e.includes("req.ip")||e.includes("request.ip"))&&!e.includes("ipKeyGenerator"))throw new O("ERR_ERL_KEY_GEN_IPV6","Custom keyGenerator appears to use request IP without calling the ipKeyGenerator helper function for IPv6 addresses. This could allow IPv6 users to bypass limits.")},windowMs(t){if(typeof t!="number"||Number.isNaN(t)||t<1||t>2147483647)throw new O("ERR_ERL_WINDOW_MS",`Invalid windowMs value: ${t}${typeof t!="number"?` (${typeof t})`:""}, must be a number between 1 and 2147483647 when using the default MemoryStore`)}},Rn=t=>{let e;typeof t=="boolean"?e={default:t}:e={default:!0,...t};let r={enabled:e};for(let[s,n]of Object.entries(vn))typeof n=="function"&&(r[s]=(...o)=>{if(e[s]??e.default)try{n.apply(r,o)}catch(i){i instanceof Ne?console.warn(i):console.error(i)}});return r},On=t=>typeof t.incr=="function"&&typeof t.increment!="function",wn=t=>{if(!On(t))return t;let e=t;class r{async increment(n){return new Promise((o,i)=>{e.incr(n,(a,c,u)=>{a&&i(a),o({totalHits:c,resetTime:u})})})}async decrement(n){return e.decrement(n)}async resetKey(n){return e.resetKey(n)}async resetAll(){if(typeof e.resetAll=="function")return e.resetAll()}}return new r},Dn=t=>{let{validations:e,...r}=t;return{...r,validate:e.enabled}},In=t=>{let e=_n(t),r=Rn(e?.validate??!0);r.validationsConfig(),r.knownOptions(t),r.draftPolliHeaders(e.draft_polli_ratelimit_headers),r.onLimitReached(e.onLimitReached),e.ipv6Subnet!==void 0&&typeof e.ipv6Subnet!="function"&&r.ipv6Subnet(e.ipv6Subnet),r.keyGeneratorIpFallback(e.keyGenerator),r.ipv6SubnetOrKeyGenerator(e);let s=e.standardHeaders??!1;s===!0&&(s="draft-6");let n={windowMs:60*1e3,limit:t.max??5,message:"Too many requests, please try again later.",statusCode:429,legacyHeaders:t.headers??!0,identifier(o,i){let a="",c=n.requestPropertyName,{limit:u}=o[c],d=n.windowMs/1e3,l=n.windowMs/(1e3*60),m=n.windowMs/(1e3*60*60),f=n.windowMs/(1e3*60*60*24);return d<60?a=`${d}sec`:l<60?a=`${l}min`:m<24?a=`${m}hr${m>1?"s":""}`:a=`${f}day${f>1?"s":""}`,`${u}-in-${a}`},requestPropertyName:"rateLimit",skipFailedRequests:!1,skipSuccessfulRequests:!1,requestWasSuccessful:(o,i)=>i.statusCode<400,skip:(o,i)=>!1,async keyGenerator(o,i){r.ip(o.ip),r.trustProxy(o),r.xForwardedForHeader(o),r.forwardedHeader(o);let a=o.ip,c=56;return pn(a)&&(c=typeof n.ipv6Subnet=="function"?await n.ipv6Subnet(o,i):n.ipv6Subnet,typeof n.ipv6Subnet=="function"&&r.ipv6Subnet(c)),ln(a,c)},ipv6Subnet:56,async handler(o,i,a,c){i.status(n.statusCode);let u=typeof n.message=="function"?await n.message(o,i):n.message;i.writableEnded||i.send(u)},passOnStoreError:!1,...e,standardHeaders:s,store:wn(e.store??new dn(r)),validations:r};if(typeof n.store.increment!="function"||typeof n.store.decrement!="function"||typeof n.store.resetKey!="function"||n.store.resetAll!==void 0&&typeof n.store.resetAll!="function"||n.store.init!==void 0&&typeof n.store.init!="function")throw new TypeError("An invalid store was passed. Please ensure that the store is a class that implements the `Store` interface.");return n},Nn=t=>async(e,r,s)=>{try{await Promise.resolve(t(e,r,s)).catch(s)}catch(n){s(n)}},An=t=>{let e=In(t??{}),r=Dn(e);e.validations.creationStack(e.store),e.validations.unsharedStore(e.store),typeof e.store.init=="function"&&e.store.init(r);let s=Nn(async(o,i,a)=>{if(await e.skip(o,i)){a();return}let u=o,d=await e.keyGenerator(o,i),l=0,m;try{let E=await e.store.increment(d);l=E.totalHits,m=E.resetTime}catch(E){if(e.passOnStoreError){console.error("express-rate-limit: error from store, allowing request without rate-limiting.",E),a();return}throw E}e.validations.positiveHits(l),e.validations.singleCount(o,e.store,d);let g=await(typeof e.limit=="function"?e.limit(o,i):e.limit);e.validations.limit(g);let h={limit:g,used:l,remaining:Math.max(g-l,0),resetTime:m,key:d};if(Object.defineProperty(h,"current",{configurable:!1,enumerable:!1,value:l}),u[e.requestPropertyName]=h,e.legacyHeaders&&!i.headersSent&&hn(i,h),e.standardHeaders&&!i.headersSent)switch(e.standardHeaders){case"draft-6":{En(i,h,e.windowMs);break}case"draft-7":{e.validations.headersResetTime(h.resetTime),bn(i,h,e.windowMs);break}case"draft-8":{let R=await(typeof e.identifier=="function"?e.identifier(o,i):e.identifier);e.validations.headersResetTime(h.resetTime),yn(i,h,e.windowMs,R,d);break}default:{e.validations.headersDraftVersion(e.standardHeaders);break}}if(e.skipFailedRequests||e.skipSuccessfulRequests){let E=!1,R=async()=>{E||(await e.store.decrement(d),E=!0)};e.skipFailedRequests&&(i.on("finish",async()=>{await e.requestWasSuccessful(o,i)||await R()}),i.on("close",async()=>{i.writableEnded||await R()}),i.on("error",async()=>{await R()})),e.skipSuccessfulRequests&&i.on("finish",async()=>{await e.requestWasSuccessful(o,i)&&await R()})}if(e.validations.disable(),l>g){(e.legacyHeaders||e.standardHeaders)&&Sn(i,h,e.windowMs),e.handler(o,i,a,r);return}a()}),n=()=>{throw new Error("The current store does not support the get/getKey method")};return s.resetKey=e.store.resetKey.bind(e.store),s.getKey=typeof e.store.get=="function"?e.store.get.bind(e.store):n,s},Ce=An;import yo from"crypto";import{join as It,dirname as So}from"path";import{existsSync as Be,mkdirSync as _o,writeFileSync as Qr,unlinkSync as Zr,chmodSync as To}from"fs";import{fileURLToPath as vo}from"url";import Cn from"better-sqlite3";var xe=class{_db;_stmtCache=new Map;constructor(e,r){this._db=new Cn(e,{readonly:r?.readwrite===!1})}run(e,r){let s=this._db.prepare(e);return r?s.run(...r):s.run()}query(e){let r=this._stmtCache.get(e);return r||(r=new rt(this._db,e),this._stmtCache.set(e,r)),r}transaction(e){return this._db.transaction(e)}close(){this._stmtCache.clear(),this._db.close()}},rt=class{_stmt;constructor(e,r){this._stmt=e.prepare(r)}all(...e){return e.length>0?this._stmt.all(...e):this._stmt.all()}get(...e){return e.length>0?this._stmt.get(...e):this._stmt.get()}run(...e){return e.length>0?this._stmt.run(...e):this._stmt.run()}};import{join as N,dirname as kn,basename as Qo}from"path";import{homedir as nt}from"os";import{existsSync as pr,mkdirSync as Pn}from"fs";import{fileURLToPath as Fn}from"url";import{appendFileSync as xn,existsSync as cr,mkdirSync as jn,readFileSync as Ln}from"fs";import{join as je}from"path";import{homedir as Mn}from"os";var Le=(o=>(o[o.DEBUG=0]="DEBUG",o[o.INFO=1]="INFO",o[o.WARN=2]="WARN",o[o.ERROR=3]="ERROR",o[o.SILENT=4]="SILENT",o))(Le||{}),ur=je(Mn(),".contextkit"),st=class{level=null;useColor;logFilePath=null;logFileInitialized=!1;constructor(){this.useColor=process.stdout.isTTY??!1}ensureLogFileInitialized(){if(!this.logFileInitialized){this.logFileInitialized=!0;try{let e=je(ur,"logs");cr(e)||jn(e,{recursive:!0});let r=new Date().toISOString().split("T")[0];this.logFilePath=je(e,`kiro-memory-${r}.log`)}catch(e){console.error("[LOGGER] Failed to initialize log file:",e),this.logFilePath=null}}}getLevel(){if(this.level===null)try{let e=je(ur,"settings.json");if(cr(e)){let r=Ln(e,"utf-8"),s=JSON.parse(r),n=(s.KIRO_MEMORY_LOG_LEVEL||s.CONTEXTKIT_LOG_LEVEL||"INFO").toUpperCase();this.level=Le[n]??1}else this.level=1}catch{this.level=1}return this.level}correlationId(e,r){return`obs-${e}-${r}`}sessionId(e){return`session-${e}`}formatData(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="object"){if(e instanceof Error)return this.getLevel()===0?`${e.message}
${e.stack}`:e.message;if(Array.isArray(e))return`[${e.length} items]`;let r=Object.keys(e);return r.length===0?"{}":r.length<=3?JSON.stringify(e):`{${r.length} keys: ${r.slice(0,3).join(", ")}...}`}return String(e)}formatTimestamp(e){let r=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),o=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0"),c=String(e.getMilliseconds()).padStart(3,"0");return`${r}-${s}-${n} ${o}:${i}:${a}.${c}`}log(e,r,s,n,o){if(e<this.getLevel())return;this.ensureLogFileInitialized();let i=this.formatTimestamp(new Date),a=Le[e].padEnd(5),c=r.padEnd(6),u="";n?.correlationId?u=`[${n.correlationId}] `:n?.sessionId&&(u=`[session-${n.sessionId}] `);let d="";o!=null&&(o instanceof Error?d=this.getLevel()===0?`
${o.message}
${o.stack}`:` ${o.message}`:this.getLevel()===0&&typeof o=="object"?d=`
`+JSON.stringify(o,null,2):d=" "+this.formatData(o));let l="";if(n){let{sessionId:f,memorySessionId:g,correlationId:h,...E}=n;Object.keys(E).length>0&&(l=` {${Object.entries(E).map(([y,S])=>`${y}=${S}`).join(", ")}}`)}let m=`[${i}] [${a}] [${c}] ${u}${s}${l}${d}`;if(this.logFilePath)try{xn(this.logFilePath,m+`
`,"utf8")}catch(f){process.stderr.write(`[LOGGER] Failed to write to log file: ${f}
`)}else process.stderr.write(m+`
`)}debug(e,r,s,n){this.log(0,e,r,s,n)}info(e,r,s,n){this.log(1,e,r,s,n)}warn(e,r,s,n){this.log(2,e,r,s,n)}error(e,r,s,n){this.log(3,e,r,s,n)}dataIn(e,r,s,n){this.info(e,`\u2192 ${r}`,s,n)}dataOut(e,r,s,n){this.info(e,`\u2190 ${r}`,s,n)}success(e,r,s,n){this.info(e,`\u2713 ${r}`,s,n)}failure(e,r,s,n){this.error(e,`\u2717 ${r}`,s,n)}timing(e,r,s,n){this.info(e,`\u23F1 ${r}`,n,{duration:`${s}ms`})}happyPathError(e,r,s,n,o=""){let u=((new Error().stack||"").split(`
`)[2]||"").match(/at\s+(?:.*\s+)?\(?([^:]+):(\d+):(\d+)\)?/),d=u?`${u[1].split("/").pop()}:${u[2]}`:"unknown",l={...s,location:d};return this.warn(e,`[HAPPY-PATH] ${r}`,l,n),o}},p=new st;function Bn(){return typeof __dirname<"u"?__dirname:kn(Fn(import.meta.url))}var ni=Bn(),lr=N(nt(),".contextkit"),$n=pr(lr)?lr:N(nt(),".kiro-memory"),w=process.env.KIRO_MEMORY_DATA_DIR||process.env.CONTEXTKIT_DATA_DIR||$n,ot=process.env.KIRO_CONFIG_DIR||N(nt(),".kiro"),oi=N(ot,"plugins","kiro-memory"),ii=N(w,"archives"),ai=N(w,"logs"),ci=N(w,"trash"),ui=N(w,"backups"),li=N(w,"modes"),di=N(w,"settings.json"),dr=N(w,"contextkit.db"),mr=pr(dr)?dr:N(w,"kiro-memory.db"),pi=N(w,"vector-db"),mi=N(w,"observer-sessions"),fi=N(ot,"settings.json"),gi=N(ot,"context.md");function fr(t){Pn(t,{recursive:!0})}var Hn=256*1024*1024,Un=1e4,V=class{_db;get db(){return this._db}constructor(e=mr,r=!1){e!==":memory:"&&fr(w),this._db=new xe(e,{create:!0,readwrite:!0}),this._db.run("PRAGMA journal_mode = WAL"),this._db.run("PRAGMA busy_timeout = 5000"),this._db.run("PRAGMA synchronous = NORMAL"),this._db.run("PRAGMA foreign_keys = ON"),this._db.run("PRAGMA temp_store = memory"),this._db.run(`PRAGMA mmap_size = ${Hn}`),this._db.run(`PRAGMA cache_size = ${Un}`),r||new it(this._db).runAllMigrations()}query(e){return this._db.query(e)}run(e,r){return this._db.run(e,r)}withTransaction(e){return this._db.transaction(e)(this._db)}close(){this._db.close()}},it=class{db;constructor(e){this.db=e}runAllMigrations(){this.db.run(`
      CREATE TABLE IF NOT EXISTS schema_versions (
        id INTEGER PRIMARY KEY,
        version INTEGER UNIQUE NOT NULL,
        applied_at TEXT NOT NULL
      )
    `);let s=this.db.query("SELECT MAX(version) as version FROM schema_versions").get()?.version||0,n=this.getMigrations();for(let o of n)o.version>s&&(p.info("DB",`Applying migration ${o.version}`),this.db.transaction(()=>{o.up(this.db),this.db.query("INSERT INTO schema_versions (version, applied_at) VALUES (?, ?)").run(o.version,new Date().toISOString())})(),p.info("DB",`Migration ${o.version} applied successfully`))}getMigrations(){return[{version:1,up:e=>{e.run(`
            CREATE TABLE IF NOT EXISTS sessions (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              content_session_id TEXT NOT NULL UNIQUE,
              project TEXT NOT NULL,
              user_prompt TEXT NOT NULL,
              memory_session_id TEXT,
              status TEXT DEFAULT 'active',
              started_at TEXT NOT NULL,
              started_at_epoch INTEGER NOT NULL,
              completed_at TEXT,
              completed_at_epoch INTEGER
            )
          `),e.run(`
            CREATE TABLE IF NOT EXISTS observations (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              memory_session_id TEXT NOT NULL,
              project TEXT NOT NULL,
              type TEXT NOT NULL,
              title TEXT NOT NULL,
              subtitle TEXT,
              text TEXT,
              narrative TEXT,
              facts TEXT,
              concepts TEXT,
              files_read TEXT,
              files_modified TEXT,
              prompt_number INTEGER NOT NULL,
              created_at TEXT NOT NULL,
              created_at_epoch INTEGER NOT NULL
            )
          `),e.run(`
            CREATE TABLE IF NOT EXISTS summaries (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              session_id TEXT NOT NULL,
              project TEXT NOT NULL,
              request TEXT,
              investigated TEXT,
              learned TEXT,
              completed TEXT,
              next_steps TEXT,
              notes TEXT,
              created_at TEXT NOT NULL,
              created_at_epoch INTEGER NOT NULL
            )
          `),e.run(`
            CREATE TABLE IF NOT EXISTS prompts (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              content_session_id TEXT NOT NULL,
              project TEXT NOT NULL,
              prompt_number INTEGER NOT NULL,
              prompt_text TEXT NOT NULL,
              created_at TEXT NOT NULL,
              created_at_epoch INTEGER NOT NULL
            )
          `),e.run(`
            CREATE TABLE IF NOT EXISTS pending_messages (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              content_session_id TEXT NOT NULL,
              type TEXT NOT NULL,
              data TEXT NOT NULL,
              created_at TEXT NOT NULL,
              created_at_epoch INTEGER NOT NULL
            )
          `),e.run("CREATE INDEX IF NOT EXISTS idx_sessions_project ON sessions(project)"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_project ON observations(project)"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_session ON observations(memory_session_id)"),e.run("CREATE INDEX IF NOT EXISTS idx_summaries_session ON summaries(session_id)"),e.run("CREATE INDEX IF NOT EXISTS idx_prompts_session ON prompts(content_session_id)")}},{version:2,up:e=>{e.run(`
            CREATE VIRTUAL TABLE IF NOT EXISTS observations_fts USING fts5(
              title, text, narrative, concepts,
              content='observations',
              content_rowid='id'
            )
          `),e.run(`
            CREATE TRIGGER IF NOT EXISTS observations_ai AFTER INSERT ON observations BEGIN
              INSERT INTO observations_fts(rowid, title, text, narrative, concepts)
              VALUES (new.id, new.title, new.text, new.narrative, new.concepts);
            END
          `),e.run(`
            CREATE TRIGGER IF NOT EXISTS observations_ad AFTER DELETE ON observations BEGIN
              INSERT INTO observations_fts(observations_fts, rowid, title, text, narrative, concepts)
              VALUES ('delete', old.id, old.title, old.text, old.narrative, old.concepts);
            END
          `),e.run(`
            CREATE TRIGGER IF NOT EXISTS observations_au AFTER UPDATE ON observations BEGIN
              INSERT INTO observations_fts(observations_fts, rowid, title, text, narrative, concepts)
              VALUES ('delete', old.id, old.title, old.text, old.narrative, old.concepts);
              INSERT INTO observations_fts(rowid, title, text, narrative, concepts)
              VALUES (new.id, new.title, new.text, new.narrative, new.concepts);
            END
          `),e.run(`
            INSERT INTO observations_fts(rowid, title, text, narrative, concepts)
            SELECT id, title, text, narrative, concepts FROM observations
          `),e.run("CREATE INDEX IF NOT EXISTS idx_observations_type ON observations(type)"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_epoch ON observations(created_at_epoch)"),e.run("CREATE INDEX IF NOT EXISTS idx_summaries_project ON summaries(project)"),e.run("CREATE INDEX IF NOT EXISTS idx_summaries_epoch ON summaries(created_at_epoch)"),e.run("CREATE INDEX IF NOT EXISTS idx_prompts_project ON prompts(project)")}},{version:3,up:e=>{e.run(`
            CREATE TABLE IF NOT EXISTS project_aliases (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              project_name TEXT NOT NULL UNIQUE,
              display_name TEXT NOT NULL,
              created_at TEXT NOT NULL,
              updated_at TEXT NOT NULL
            )
          `),e.run("CREATE UNIQUE INDEX IF NOT EXISTS idx_project_aliases_name ON project_aliases(project_name)")}},{version:4,up:e=>{e.run(`
            CREATE TABLE IF NOT EXISTS observation_embeddings (
              observation_id INTEGER PRIMARY KEY,
              embedding BLOB NOT NULL,
              model TEXT NOT NULL,
              dimensions INTEGER NOT NULL,
              created_at TEXT NOT NULL,
              FOREIGN KEY (observation_id) REFERENCES observations(id) ON DELETE CASCADE
            )
          `),e.run("CREATE INDEX IF NOT EXISTS idx_embeddings_model ON observation_embeddings(model)")}},{version:5,up:e=>{e.run("ALTER TABLE observations ADD COLUMN last_accessed_epoch INTEGER"),e.run("ALTER TABLE observations ADD COLUMN is_stale INTEGER DEFAULT 0"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_last_accessed ON observations(last_accessed_epoch)"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_stale ON observations(is_stale)")}},{version:6,up:e=>{e.run(`
            CREATE TABLE IF NOT EXISTS checkpoints (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              session_id INTEGER NOT NULL,
              project TEXT NOT NULL,
              task TEXT NOT NULL,
              progress TEXT,
              next_steps TEXT,
              open_questions TEXT,
              relevant_files TEXT,
              context_snapshot TEXT,
              created_at TEXT NOT NULL,
              created_at_epoch INTEGER NOT NULL,
              FOREIGN KEY (session_id) REFERENCES sessions(id)
            )
          `),e.run("CREATE INDEX IF NOT EXISTS idx_checkpoints_session ON checkpoints(session_id)"),e.run("CREATE INDEX IF NOT EXISTS idx_checkpoints_project ON checkpoints(project)"),e.run("CREATE INDEX IF NOT EXISTS idx_checkpoints_epoch ON checkpoints(created_at_epoch)")}},{version:7,up:e=>{e.run("ALTER TABLE observations ADD COLUMN content_hash TEXT"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_hash ON observations(content_hash)")}},{version:8,up:e=>{e.run("ALTER TABLE observations ADD COLUMN discovery_tokens INTEGER DEFAULT 0"),e.run("ALTER TABLE summaries ADD COLUMN discovery_tokens INTEGER DEFAULT 0")}},{version:9,up:e=>{e.run("CREATE INDEX IF NOT EXISTS idx_observations_project_epoch ON observations(project, created_at_epoch DESC)"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_project_type ON observations(project, type)"),e.run("CREATE INDEX IF NOT EXISTS idx_summaries_project_epoch ON summaries(project, created_at_epoch DESC)"),e.run("CREATE INDEX IF NOT EXISTS idx_prompts_project_epoch ON prompts(project, created_at_epoch DESC)")}},{version:10,up:e=>{e.run(`
            CREATE TABLE IF NOT EXISTS job_queue (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              type TEXT NOT NULL,
              status TEXT NOT NULL DEFAULT 'pending',
              payload TEXT,
              result TEXT,
              error TEXT,
              retry_count INTEGER DEFAULT 0,
              max_retries INTEGER DEFAULT 3,
              priority INTEGER DEFAULT 0,
              created_at TEXT NOT NULL,
              created_at_epoch INTEGER NOT NULL,
              started_at_epoch INTEGER,
              completed_at_epoch INTEGER
            )
          `),e.run("CREATE INDEX IF NOT EXISTS idx_jobs_status ON job_queue(status)"),e.run("CREATE INDEX IF NOT EXISTS idx_jobs_type ON job_queue(type)"),e.run("CREATE INDEX IF NOT EXISTS idx_jobs_priority ON job_queue(status, priority DESC, created_at_epoch ASC)")}},{version:11,up:e=>{e.run("ALTER TABLE observations ADD COLUMN auto_category TEXT"),e.run("CREATE INDEX IF NOT EXISTS idx_observations_category ON observations(auto_category)")}}]}};var at={"all-MiniLM-L6-v2":{modelId:"Xenova/all-MiniLM-L6-v2",dimensions:384},"jina-code-v2":{modelId:"jinaai/jina-embeddings-v2-base-code",dimensions:768},"bge-small-en":{modelId:"BAAI/bge-small-en-v1.5",dimensions:384}},qn=new Set(["all-MiniLM-L6-v2","bge-small-en"]),ut=class{provider=null;model=null;initialized=!1;initializing=null;config;configName;constructor(){let e=process.env.KIRO_MEMORY_EMBEDDING_MODEL||"all-MiniLM-L6-v2";if(this.configName=e,at[e])this.config=at[e];else if(e.includes("/")){let r=parseInt(process.env.KIRO_MEMORY_EMBEDDING_DIMENSIONS||"384",10);this.config={modelId:e,dimensions:isNaN(r)?384:r}}else p.warn("EMBEDDING",`Unknown model name '${e}', falling back to 'all-MiniLM-L6-v2'`),this.configName="all-MiniLM-L6-v2",this.config=at["all-MiniLM-L6-v2"]}async initialize(){if(this.initialized)return this.provider!==null;if(this.initializing)return this.initializing;this.initializing=this._doInitialize();let e=await this.initializing;return this.initializing=null,e}async _doInitialize(){if(qn.has(this.configName))try{let r=await import("fastembed"),s=r.EmbeddingModel||r.default?.EmbeddingModel,n=r.FlagEmbedding||r.default?.FlagEmbedding;if(n&&s)return this.model=await n.init({model:s.BGESmallENV15}),this.provider="fastembed",this.initialized=!0,p.info("EMBEDDING",`Initialized with fastembed (BGE-small-en-v1.5) for model '${this.configName}'`),!0}catch(r){p.debug("EMBEDDING",`fastembed not available: ${r}`)}try{let r=await import("@huggingface/transformers"),s=r.pipeline||r.default?.pipeline;if(s)return this.model=await s("feature-extraction",this.config.modelId,{quantized:!0}),this.provider="transformers",this.initialized=!0,p.info("EMBEDDING",`Initialized with @huggingface/transformers (${this.config.modelId})`),!0}catch(r){p.debug("EMBEDDING",`@huggingface/transformers not available: ${r}`)}return this.provider=null,this.initialized=!0,p.warn("EMBEDDING","No embedding provider available, semantic search disabled"),!1}async embed(e){if(this.initialized||await this.initialize(),!this.provider||!this.model)return null;try{let r=e.substring(0,2e3);if(this.provider==="fastembed")return await this._embedFastembed(r);if(this.provider==="transformers")return await this._embedTransformers(r)}catch(r){p.error("EMBEDDING",`Error generating embedding: ${r}`)}return null}async embedBatch(e){if(this.initialized||await this.initialize(),!this.provider||!this.model)return e.map(()=>null);if(e.length===0)return[];let r=e.map(s=>s.substring(0,2e3));try{if(this.provider==="fastembed")return await this._embedBatchFastembed(r);if(this.provider==="transformers")return await this._embedBatchTransformers(r)}catch(s){p.warn("EMBEDDING",`Batch embedding failed, falling back to serial: ${s}`)}return this._embedBatchSerial(r)}isAvailable(){return this.initialized&&this.provider!==null}getProvider(){return this.provider}getDimensions(){return this.config.dimensions}getModelName(){return this.configName}async _embedBatchFastembed(e){let r=[],s=this.model.embed(e,e.length);for await(let n of s)if(n)for(let o of n)r.push(o instanceof Float32Array?o:new Float32Array(o));for(;r.length<e.length;)r.push(null);return r}async _embedBatchTransformers(e){let r=await this.model(e,{pooling:"mean",normalize:!0});if(!r?.data)return e.map(()=>null);let s=this.getDimensions(),n=r.data instanceof Float32Array?r.data:new Float32Array(r.data),o=[];for(let i=0;i<e.length;i++){let a=i*s;a+s<=n.length?o.push(n.slice(a,a+s)):o.push(null)}return o}async _embedBatchSerial(e){let r=[];for(let s of e)try{let n=await this.embed(s);r.push(n)}catch{r.push(null)}return r}async _embedFastembed(e){let r=this.model.embed([e],1);for await(let s of r)if(s&&s.length>0){let n=s[0];return n instanceof Float32Array?n:new Float32Array(n)}return null}async _embedTransformers(e){let r=await this.model(e,{pooling:"mean",normalize:!0});return r?.data?r.data instanceof Float32Array?r.data:new Float32Array(r.data):null}},ct=null;function F(){return ct||(ct=new ut),ct}var Wn=2e3;function Kn(t,e){let r=t.length;if(r!==e.length)return 0;let s=0,n=0,o=0;for(let a=0;a<r;a++){let c=t[a],u=e[a];s+=c*u,n+=c*c,o+=u*u}let i=Math.sqrt(n*o);return i===0?0:s/i}function Gn(t){return Buffer.from(t.buffer,t.byteOffset,t.byteLength)}function Xn(t){let e=t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);return new Float32Array(e)}var dt=class{async search(e,r,s={}){let n=s.limit||10,o=s.threshold||.3,i=s.maxCandidates||Wn;try{let a=[],c=[];s.project&&(a.push("o.project = ?"),c.push(s.project));let d=`
        SELECT e.observation_id, e.embedding,
               o.title, o.text, o.type, o.project, o.created_at, o.created_at_epoch
        FROM observation_embeddings e
        JOIN observations o ON o.id = e.observation_id
        ${a.length>0?`WHERE ${a.join(" AND ")}`:""}
        ORDER BY o.created_at_epoch DESC
        LIMIT ?
      `;c.push(i);let l=e.query(d).all(...c),m=[];for(let f of l){let g=Xn(f.embedding),h=Kn(r,g);h>=o&&m.push({id:f.observation_id,observationId:f.observation_id,similarity:h,title:f.title,text:f.text,type:f.type,project:f.project,created_at:f.created_at,created_at_epoch:f.created_at_epoch})}return m.sort((f,g)=>g.similarity-f.similarity),p.debug("VECTOR",`Search: ${l.length} candidates \u2192 ${m.length} above threshold \u2192 ${Math.min(m.length,n)} results`),m.slice(0,n)}catch(a){return p.error("VECTOR",`Vector search error: ${a}`),[]}}async storeEmbedding(e,r,s,n){try{let o=Gn(s);e.query(`
        INSERT OR REPLACE INTO observation_embeddings
          (observation_id, embedding, model, dimensions, created_at)
        VALUES (?, ?, ?, ?, ?)
      `).run(r,o,n,s.length,new Date().toISOString()),p.debug("VECTOR",`Embedding saved for observation ${r}`)}catch(o){p.error("VECTOR",`Error saving embedding: ${o}`)}}async backfillEmbeddings(e,r=50){let s=F();if(!await s.initialize())return p.warn("VECTOR","Embedding service not available, backfill skipped"),0;let n=e.query(`
      SELECT o.id, o.title, o.text, o.narrative, o.concepts
      FROM observations o
      LEFT JOIN observation_embeddings e ON e.observation_id = o.id
      WHERE e.observation_id IS NULL
      ORDER BY o.created_at_epoch DESC
      LIMIT ?
    `).all(r);if(n.length===0)return 0;let o=0,i=s.getModelName();for(let a of n){let c=[a.title];a.text&&c.push(a.text),a.narrative&&c.push(a.narrative),a.concepts&&c.push(a.concepts);let u=c.join(" ").substring(0,2e3),d=await s.embed(u);d&&(await this.storeEmbedding(e,a.id,d,i),o++)}return p.info("VECTOR",`Backfill completed: ${o}/${n.length} embeddings generated`),o}getStats(e){try{let r=e.query("SELECT COUNT(*) as count FROM observations").get(),s=e.query("SELECT COUNT(*) as count FROM observation_embeddings").get(),n=r?.count||0,o=s?.count||0,i=n>0?Math.round(o/n*100):0;return{total:n,embedded:o,percentage:i}}catch{return{total:0,embedded:0,percentage:0}}}},lt=null;function H(){return lt||(lt=new dt),lt}var gr={semantic:.4,fts5:.3,recency:.2,projectMatch:.1};function pt(t,e=168){if(!t||t<=0)return 0;let s=Date.now()-t;if(s<=0)return 1;let n=s/(1e3*60*60);return Math.exp(-n*Math.LN2/e)}function hr(t,e){if(e.length===0)return 0;if(e.length===1)return 1;let r=Math.min(...e),s=Math.max(...e);return r===s?1:(s-t)/(s-r)}function mt(t,e){return!t||!e?0:t.toLowerCase()===e.toLowerCase()?1:0}function ft(t,e){return t.semantic*e.semantic+t.fts5*e.fts5+t.recency*e.recency+t.projectMatch*e.projectMatch}var Yn={constraint:1.3,decision:1.25,heuristic:1.15,rejected:1.1};function gt(t){return Yn[t]??1}var bt=class{embeddingInitialized=!1;async initialize(){try{let e=F();await e.initialize(),this.embeddingInitialized=e.isAvailable(),p.info("SEARCH",`HybridSearch initialized (embedding: ${this.embeddingInitialized?"active":"disabled"})`)}catch(e){p.warn("SEARCH","Embedding initialization failed, using only FTS5",{},e),this.embeddingInitialized=!1}}async search(e,r,s={}){let n=s.limit||10,o=s.weights||gr,i=s.project||"",a=new Map;if(this.embeddingInitialized)try{let m=await F().embed(r);if(m){let g=await H().search(e,m,{project:s.project,limit:n*2,threshold:.3});for(let h of g)a.set(String(h.observationId),{id:String(h.observationId),title:h.title,content:h.text||"",type:h.type,project:h.project,created_at:h.created_at,created_at_epoch:h.created_at_epoch,semanticScore:h.similarity,fts5Rank:null,source:"vector"});p.debug("SEARCH",`Vector search: ${g.length} results`)}}catch(l){p.warn("SEARCH","Vector search failed, using only keyword",{},l)}try{let{searchObservationsFTSWithRank:l}=await Promise.resolve().then(()=>(U(),_r)),m=l(e,r,{project:s.project,limit:n*2});for(let f of m){let g=String(f.id),h=a.get(g);h?(h.fts5Rank=f.fts5_rank,h.source="vector"):a.set(g,{id:g,title:f.title,content:f.text||f.narrative||"",type:f.type,project:f.project,created_at:f.created_at,created_at_epoch:f.created_at_epoch,semanticScore:0,fts5Rank:f.fts5_rank,source:"keyword"})}p.debug("SEARCH",`Keyword search: ${m.length} results`)}catch(l){p.error("SEARCH","Keyword search failed",{},l)}if(a.size===0)return[];let c=Array.from(a.values()).filter(l=>l.fts5Rank!==null).map(l=>l.fts5Rank),u=[];for(let l of a.values()){let m={semantic:l.semanticScore,fts5:l.fts5Rank!==null?hr(l.fts5Rank,c):0,recency:pt(l.created_at_epoch),projectMatch:i?mt(l.project,i):0},f=ft(m,o),g=l.semanticScore>0&&l.fts5Rank!==null,E=Math.min(1,f*(g?1.15:1)*gt(l.type));u.push({id:l.id,title:l.title,content:l.content,type:l.type,project:l.project,created_at:l.created_at,created_at_epoch:l.created_at_epoch,score:E,source:g?"hybrid":l.source,signals:m})}u.sort((l,m)=>m.score-l.score);let d=u.slice(0,n);if(d.length>0)try{let{updateLastAccessed:l}=await Promise.resolve().then(()=>(oe(),Ir)),m=d.map(f=>parseInt(f.id,10)).filter(f=>f>0);m.length>0&&l(e,m)}catch{}return d}},Et=null;function ie(){return Et||(Et=new bt),Et}var no=50,ae=[];function ce(){return ae}function Nr(){return no}function Ar(t){ae.push(t)}function Cr(t){let e=ae.indexOf(t);e>-1&&ae.splice(e,1)}function oo(t,e){let r=`event: ${t}
data: ${JSON.stringify(e)}

`;ae.forEach(s=>{try{s.write(r)}catch(n){p.warn("WORKER","Broadcast failed to client",{},n)}})}var q={data:[],ts:0},xr=6e4;function io(){q.ts=0}function T(t,e,r,s){if(!t)return e;let n=parseInt(t,10);return isNaN(n)||n<r||n>s?e:n}function v(t){return typeof t=="string"&&t.length>0&&t.length<=200&&/^[\w\-\.\/@ ]+$/.test(t)&&!t.includes("..")}function j(t,e){return typeof t=="string"&&t.length>0&&t.length<=e}async function ao(t,e,r,s,n){try{let o=F();if(!o.isAvailable())return;let i=[r];s&&i.push(s),n?.length&&i.push(n.join(", "));let a=i.join(" ").substring(0,2e3),c=await o.embed(a);c&&await H().storeEmbedding(t.db,e,c,o.getProvider()||"unknown")}catch(o){p.debug("WORKER",`Embedding generation failed for obs ${e}: ${o}`)}}function jr(t){return{db:t,broadcast:oo,invalidateProjectsCache:io,generateEmbeddingForObservation:(e,r,s,n)=>ao(t,e,r,s,n)}}import{Router as uo}from"express";function Lr(t,e=100){return t.query("SELECT * FROM sessions ORDER BY started_at_epoch DESC LIMIT ?").all(e)}function Mr(t,e,r=100){return t.query("SELECT * FROM sessions WHERE project = ? ORDER BY started_at_epoch DESC LIMIT ?").all(e,r)}oe();function yt(t,e,r,s,n,o,i,a,c){let u=new Date,d=t.run(`INSERT INTO summaries 
     (session_id, project, request, investigated, learned, completed, next_steps, notes, created_at, created_at_epoch)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,[e,r,s,n,o,i,a,c,u.toISOString(),u.getTime()]);return Number(d.lastInsertRowid)}function St(t,e,r=50){return t.query("SELECT * FROM summaries WHERE project = ? ORDER BY created_at_epoch DESC, id DESC LIMIT ?").all(e,r)}function _t(t,e){return t.query("SELECT * FROM checkpoints WHERE session_id = ? ORDER BY created_at_epoch DESC, id DESC LIMIT 1").get(e)}function Tt(t,e){return t.query("SELECT * FROM checkpoints WHERE project = ? ORDER BY created_at_epoch DESC, id DESC LIMIT 1").get(e)}function vt(t,e,r,s){let n=new Date(r),o=new Date(s),i=Math.ceil((s-r)/(1440*60*1e3)),a=i<=7?"Weekly":i<=31?"Monthly":"Custom",c=(A,D="created_at_epoch")=>{let z=e?`SELECT COUNT(*) as count FROM ${A} WHERE project = ? AND ${D} >= ? AND ${D} <= ?`:`SELECT COUNT(*) as count FROM ${A} WHERE ${D} >= ? AND ${D} <= ?`,$t=t.query(z);return(e?$t.get(e,r,s):$t.get(r,s))?.count||0},u=c("observations"),d=c("summaries"),l=c("prompts"),m=c("sessions","started_at_epoch"),f=e?`SELECT DATE(datetime(created_at_epoch / 1000, 'unixepoch')) as day, COUNT(*) as count
       FROM observations
       WHERE project = ? AND created_at_epoch >= ? AND created_at_epoch <= ?
       GROUP BY day ORDER BY day ASC`:`SELECT DATE(datetime(created_at_epoch / 1000, 'unixepoch')) as day, COUNT(*) as count
       FROM observations
       WHERE created_at_epoch >= ? AND created_at_epoch <= ?
       GROUP BY day ORDER BY day ASC`,g=t.query(f),h=e?g.all(e,r,s):g.all(r,s),E=e?`SELECT type, COUNT(*) as count FROM observations
       WHERE project = ? AND created_at_epoch >= ? AND created_at_epoch <= ?
       GROUP BY type ORDER BY count DESC`:`SELECT type, COUNT(*) as count FROM observations
       WHERE created_at_epoch >= ? AND created_at_epoch <= ?
       GROUP BY type ORDER BY count DESC`,R=t.query(E),y=e?R.all(e,r,s):R.all(r,s),S=e?"SELECT COUNT(*) as count FROM sessions WHERE project = ? AND started_at_epoch >= ? AND started_at_epoch <= ?":"SELECT COUNT(*) as count FROM sessions WHERE started_at_epoch >= ? AND started_at_epoch <= ?",K=(e?t.query(S).get(e,r,s)?.count:t.query(S).get(r,s)?.count)||0,Ct=e?"SELECT COUNT(*) as count FROM sessions WHERE project = ? AND started_at_epoch >= ? AND started_at_epoch <= ? AND status = 'completed'":"SELECT COUNT(*) as count FROM sessions WHERE started_at_epoch >= ? AND started_at_epoch <= ? AND status = 'completed'",ts=(e?t.query(Ct).get(e,r,s)?.count:t.query(Ct).get(r,s)?.count)||0,xt=e?`SELECT AVG((completed_at_epoch - started_at_epoch) / 1000.0 / 60.0) as avg_min
       FROM sessions
       WHERE project = ? AND started_at_epoch >= ? AND started_at_epoch <= ?
         AND status = 'completed' AND completed_at_epoch IS NOT NULL AND completed_at_epoch > started_at_epoch`:`SELECT AVG((completed_at_epoch - started_at_epoch) / 1000.0 / 60.0) as avg_min
       FROM sessions
       WHERE started_at_epoch >= ? AND started_at_epoch <= ?
         AND status = 'completed' AND completed_at_epoch IS NOT NULL AND completed_at_epoch > started_at_epoch`,rs=e?t.query(xt).get(e,r,s):t.query(xt).get(r,s),ss=Math.round((rs?.avg_min||0)*10)/10,jt=e?`SELECT COUNT(*) as count FROM observations
       WHERE project = ? AND created_at_epoch >= ? AND created_at_epoch <= ?
         AND type IN ('constraint', 'decision', 'heuristic', 'rejected')`:`SELECT COUNT(*) as count FROM observations
       WHERE created_at_epoch >= ? AND created_at_epoch <= ?
         AND type IN ('constraint', 'decision', 'heuristic', 'rejected')`,ns=(e?t.query(jt).get(e,r,s)?.count:t.query(jt).get(r,s)?.count)||0,Lt=e?`SELECT COUNT(*) as count FROM observations
       WHERE project = ? AND created_at_epoch >= ? AND created_at_epoch <= ? AND is_stale = 1`:`SELECT COUNT(*) as count FROM observations
       WHERE created_at_epoch >= ? AND created_at_epoch <= ? AND is_stale = 1`,os=(e?t.query(Lt).get(e,r,s)?.count:t.query(Lt).get(r,s)?.count)||0,Mt=e?`SELECT learned, completed, next_steps FROM summaries
       WHERE project = ? AND created_at_epoch >= ? AND created_at_epoch <= ?
       ORDER BY created_at_epoch DESC, id DESC`:`SELECT learned, completed, next_steps FROM summaries
       WHERE created_at_epoch >= ? AND created_at_epoch <= ?
       ORDER BY created_at_epoch DESC, id DESC`,is=e?t.query(Mt).all(e,r,s):t.query(Mt).all(r,s),kt=[],Pt=[],Ft=[];for(let A of is){if(A.learned){let D=A.learned.split("; ").filter(Boolean);kt.push(...D)}if(A.completed){let D=A.completed.split("; ").filter(Boolean);Pt.push(...D)}if(A.next_steps){let D=A.next_steps.split("; ").filter(Boolean);Ft.push(...D)}}let Bt=e?`SELECT files_modified FROM observations
       WHERE project = ? AND created_at_epoch >= ? AND created_at_epoch <= ?
         AND files_modified IS NOT NULL AND files_modified != ''`:`SELECT files_modified FROM observations
       WHERE created_at_epoch >= ? AND created_at_epoch <= ?
         AND files_modified IS NOT NULL AND files_modified != ''`,as=e?t.query(Bt).all(e,r,s):t.query(Bt).all(r,s),$e=new Map;for(let A of as){let D=A.files_modified.split(",").map(z=>z.trim()).filter(Boolean);for(let z of D)$e.set(z,($e.get(z)||0)+1)}let cs=Array.from($e.entries()).map(([A,D])=>({file:A,count:D})).sort((A,D)=>D.count-A.count).slice(0,15);return{period:{start:n.toISOString().split("T")[0],end:o.toISOString().split("T")[0],days:i,label:a},overview:{observations:u,summaries:d,sessions:m,prompts:l,knowledgeCount:ns,staleCount:os},timeline:h,typeDistribution:y,sessionStats:{total:K,completed:ts,avgDurationMinutes:ss},topLearnings:[...new Set(kt)].slice(0,10),completedTasks:[...new Set(Pt)].slice(0,10),nextSteps:[...new Set(Ft)].slice(0,10),fileHotspots:cs}}U();oe();U();var ue=["constraint","decision","heuristic","rejected"];U();import{join as kr}from"path";var co=process.env.KIRO_MEMORY_DATA_DIR||process.env.CONTEXTKIT_DATA_DIR||kr(process.env.HOME||"/tmp",".kiro-memory"),Aa=kr(co,"worker.token");var Pr="2.1.0";var Fr=new Set(["observation-created","summary-created","prompt-created","session-created"]);function Br(t,e){let r=uo(),s=Ce({windowMs:6e4,max:60,standardHeaders:!0,legacyHeaders:!1});return r.post("/api/notify",s,(n,o)=>{if(n.headers["x-worker-token"]!==e){o.status(401).json({error:"Invalid or missing X-Worker-Token"});return}let{event:a,data:c}=n.body||{};if(!a||typeof a!="string"||!Fr.has(a)){o.status(400).json({error:`Event must be one of: ${[...Fr].join(", ")}`});return}t.broadcast(a,c||{}),o.json({ok:!0})}),r.get("/health",(n,o)=>{o.json({status:"ok",timestamp:Date.now(),version:Pr})}),r.get("/events",(n,o)=>{let i=ce();if(i.length>=Nr()){o.status(503).json({error:"Too many SSE connections"});return}o.setHeader("Content-Type","text/event-stream"),o.setHeader("Cache-Control","no-cache"),o.setHeader("Connection","keep-alive"),o.setHeader("X-Accel-Buffering","no"),o.flushHeaders(),Ar(o),p.info("WORKER","SSE client connected",{clients:i.length}),o.write(`event: connected
data: ${JSON.stringify({timestamp:Date.now()})}

`);let a=setInterval(()=>{try{o.write(`:keepalive ${Date.now()}

`)}catch{clearInterval(a)}},15e3);n.on("close",()=>{clearInterval(a),Cr(o),p.info("WORKER","SSE client disconnected",{clients:ce().length})})}),r}import{Router as lo}from"express";oe();U();function $r(t){let e=lo();return e.get("/api/observations",(r,s)=>{let{offset:n,limit:o,project:i}=r.query,a=T(n,0,0,1e6),c=T(o,50,1,200);try{let u=i?"SELECT COUNT(*) as total FROM observations WHERE project = ?":"SELECT COUNT(*) as total FROM observations",d=t.db.db.query(u),{total:l}=i?d.get(i):d.get(),m=i?"SELECT * FROM observations WHERE project = ? ORDER BY created_at_epoch DESC LIMIT ? OFFSET ?":"SELECT * FROM observations ORDER BY created_at_epoch DESC LIMIT ? OFFSET ?",f=t.db.db.query(m),g=i?f.all(i,c,a):f.all(c,a);s.setHeader("X-Total-Count",l),s.json(g)}catch(u){p.error("WORKER","Observation list failed",{},u),s.status(500).json({error:"Failed to list observations"})}}),e.post("/api/observations",(r,s)=>{let{memorySessionId:n,project:o,type:i,title:a,content:c,concepts:u,files:d}=r.body;if(!v(o)){s.status(400).json({error:'Invalid or missing "project"'});return}if(!j(a,500)){s.status(400).json({error:'Invalid or missing "title" (max 500 chars)'});return}if(c&&!j(c,1e5)){s.status(400).json({error:'"content" too large (max 100KB)'});return}if(u&&!Array.isArray(u)){s.status(400).json({error:'"concepts" must be an array'});return}if(d&&!Array.isArray(d)){s.status(400).json({error:'"files" must be an array'});return}try{let l=Q(t.db.db,n||"api-"+Date.now(),o,i||"manual",a,null,c,null,null,u?.join(", ")||null,d?.join(", ")||null,null,0);t.broadcast("observation-created",{id:l,project:o,title:a}),t.invalidateProjectsCache(),t.generateEmbeddingForObservation(l,a,c,u).catch(()=>{}),s.json({id:l,success:!0})}catch(l){p.error("WORKER","Observation creation failed",{},l),s.status(500).json({error:"Failed to store observation"})}}),e.post("/api/observations/batch",(r,s)=>{let{ids:n}=r.body;if(!n||!Array.isArray(n)||n.length===0||n.length>100){s.status(400).json({error:'"ids" must be an array of 1-100 elements'});return}if(!n.every(o=>typeof o=="number"&&Number.isInteger(o)&&o>0)){s.status(400).json({error:"All IDs must be positive integers"});return}try{let o=se(t.db.db,n);s.json({observations:o})}catch(o){p.error("WORKER","Batch fetch failed",{ids:n},o),s.status(500).json({error:"Batch fetch failed"})}}),e.post("/api/knowledge",(r,s)=>{let{project:n,knowledge_type:o,title:i,content:a,concepts:c,files:u,severity:d,alternatives:l,reason:m,context:f,confidence:g}=r.body;if(!v(n)){s.status(400).json({error:'Invalid or missing "project"'});return}if(!o||!ue.includes(o)){s.status(400).json({error:`Invalid "knowledge_type". Must be one of: ${ue.join(", ")}`});return}if(!j(i,500)){s.status(400).json({error:'Invalid or missing "title" (max 500 chars)'});return}if(!j(a,1e5)){s.status(400).json({error:'Invalid or missing "content" (max 100KB)'});return}if(c&&!Array.isArray(c)){s.status(400).json({error:'"concepts" must be an array'});return}if(u&&!Array.isArray(u)){s.status(400).json({error:'"files" must be an array'});return}try{let h;switch(o){case"constraint":h={knowledgeType:"constraint",severity:d==="hard"?"hard":"soft",reason:m};break;case"decision":h={knowledgeType:"decision",alternatives:l,reason:m};break;case"heuristic":h={knowledgeType:"heuristic",context:f,confidence:["high","medium","low"].includes(g)?g:void 0};break;case"rejected":h={knowledgeType:"rejected",reason:m||"",alternatives:l};break;default:s.status(400).json({error:"Invalid knowledge_type"});return}let E=Q(t.db.db,"api-"+Date.now(),n,o,i,null,a,null,JSON.stringify(h),c?.join(", ")||null,u?.join(", ")||null,null,0);t.broadcast("observation-created",{id:E,project:n,title:i,type:o}),t.generateEmbeddingForObservation(E,i,a,c).catch(()=>{}),s.json({id:E,success:!0,knowledge_type:o})}catch(h){p.error("WORKER","Knowledge save failed",{},h),s.status(500).json({error:"Failed to store knowledge"})}}),e.post("/api/memory/save",(r,s)=>{let{project:n,title:o,content:i,type:a,concepts:c}=r.body;if(!v(n)){s.status(400).json({error:'Invalid or missing "project"'});return}if(!j(o,500)){s.status(400).json({error:'Invalid or missing "title" (max 500 chars)'});return}if(!j(i,1e5)){s.status(400).json({error:'Invalid or missing "content" (max 100KB)'});return}let u=a||"research",d=Array.isArray(c)?c.join(", "):c||null;try{let l=Q(t.db.db,"memory-save-"+Date.now(),n,u,o,null,i,i,null,d,null,null,0);t.broadcast("observation-created",{id:l,project:n,title:o}),t.invalidateProjectsCache(),t.generateEmbeddingForObservation(l,o,i,Array.isArray(c)?c:void 0).catch(()=>{}),s.json({id:l,success:!0})}catch(l){p.error("WORKER","Memory save failed",{},l),s.status(500).json({error:"Failed to save memory"})}}),e.get("/api/context/:project",(r,s)=>{let{project:n}=r.params;if(!v(n)){s.status(400).json({error:"Invalid project name"});return}try{let o={project:n,observations:Fe(t.db.db,n,20),summaries:St(t.db.db,n,5)};s.json(o)}catch(o){p.error("WORKER","Context retrieval failed",{project:n},o),s.status(500).json({error:"Failed to get context"})}}),e}import{Router as po}from"express";function Hr(t){let e=po();return e.get("/api/summaries",(r,s)=>{let{offset:n,limit:o,project:i}=r.query,a=T(n,0,0,1e6),c=T(o,20,1,200);try{let u=i?"SELECT COUNT(*) as total FROM summaries WHERE project = ?":"SELECT COUNT(*) as total FROM summaries",d=t.db.db.query(u),{total:l}=i?d.get(i):d.get(),m=i?"SELECT * FROM summaries WHERE project = ? ORDER BY created_at_epoch DESC LIMIT ? OFFSET ?":"SELECT * FROM summaries ORDER BY created_at_epoch DESC LIMIT ? OFFSET ?",f=t.db.db.query(m),g=i?f.all(i,c,a):f.all(c,a);s.setHeader("X-Total-Count",l),s.json(g)}catch(u){p.error("WORKER","Summary list failed",{},u),s.status(500).json({error:"Failed to list summaries"})}}),e.post("/api/summaries",(r,s)=>{let{sessionId:n,project:o,request:i,learned:a,completed:c,nextSteps:u}=r.body;if(!v(o)){s.status(400).json({error:'Invalid or missing "project"'});return}let d=5e4;if(i&&!j(i,d)){s.status(400).json({error:'"request" too large'});return}if(a&&!j(a,d)){s.status(400).json({error:'"learned" too large'});return}if(c&&!j(c,d)){s.status(400).json({error:'"completed" too large'});return}if(u&&!j(u,d)){s.status(400).json({error:'"nextSteps" too large'});return}try{let l=yt(t.db.db,n||"api-"+Date.now(),o,i||null,null,a||null,c||null,u||null,null);t.broadcast("summary-created",{id:l,project:o}),s.json({id:l,success:!0})}catch(l){p.error("WORKER","Summary creation failed",{},l),s.status(500).json({error:"Failed to store summary"})}}),e}import{Router as mo}from"express";U();function Ur(t){let e=mo();return e.get("/api/search",(r,s)=>{let{q:n,project:o,type:i,limit:a}=r.query;if(!n){s.status(400).json({error:'Query parameter "q" is required'});return}try{let c={project:o||void 0,type:i||void 0,limit:T(a,20,1,100)},u={observations:te(t.db.db,n,c),summaries:re(t.db.db,n,c)};s.json(u)}catch(c){p.error("WORKER","Search failed",{query:n},c),s.status(500).json({error:"Search failed"})}}),e.get("/api/hybrid-search",async(r,s)=>{let{q:n,project:o,limit:i}=r.query;if(!n){s.status(400).json({error:'Query parameter "q" is required'});return}try{let c=await ie().search(t.db.db,n,{project:o||void 0,limit:T(i,10,1,100)});s.json({results:c,count:c.length})}catch(a){p.error("WORKER","Hybrid search failed",{query:n},a),s.status(500).json({error:"Hybrid search failed"})}}),e.get("/api/timeline",(r,s)=>{let{anchor:n,depth_before:o,depth_after:i}=r.query;if(!n){s.status(400).json({error:'Query parameter "anchor" is required'});return}let a=T(n,0,1,Number.MAX_SAFE_INTEGER);if(a===0){s.status(400).json({error:'Invalid "anchor" (must be positive integer)'});return}try{let c=ne(t.db.db,a,T(o,5,1,50),T(i,5,1,50));s.json({timeline:c})}catch(c){p.error("WORKER","Timeline failed",{anchor:n},c),s.status(500).json({error:"Timeline failed"})}}),e}import{Router as fo}from"express";function qr(t,e,r=30){let s=Date.now()-r*24*60*60*1e3,n=e?`SELECT DATE(datetime(created_at_epoch / 1000, 'unixepoch')) as day, COUNT(*) as count
       FROM observations
       WHERE project = ? AND created_at_epoch >= ?
       GROUP BY day
       ORDER BY day ASC`:`SELECT DATE(datetime(created_at_epoch / 1000, 'unixepoch')) as day, COUNT(*) as count
       FROM observations
       WHERE created_at_epoch >= ?
       GROUP BY day
       ORDER BY day ASC`,o=t.query(n);return e?o.all(e,s):o.all(s)}function Wr(t,e){let r=e?`SELECT type, COUNT(*) as count
       FROM observations
       WHERE project = ?
       GROUP BY type
       ORDER BY count DESC`:`SELECT type, COUNT(*) as count
       FROM observations
       GROUP BY type
       ORDER BY count DESC`,s=t.query(r);return e?s.all(e):s.all()}function Kr(t,e){let s=`
    SELECT
      COUNT(*) as total,
      COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed,
      AVG(CASE
        WHEN status = 'completed' AND completed_at_epoch IS NOT NULL AND completed_at_epoch > started_at_epoch
        THEN (completed_at_epoch - started_at_epoch) / 1000.0 / 60.0
      END) as avg_min
    FROM sessions
    ${e?"WHERE project = ?":""}
  `,n=e?t.query(s).get(e):t.query(s).get();return{total:n?.total||0,completed:n?.completed||0,avgDurationMinutes:Math.round((n?.avg_min||0)*10)/10}}function Gr(t,e){let r=Date.now(),s=r-r%(1440*60*1e3),n=r-10080*60*1e3,o=e?"WHERE project = @project":"",a=`
    WITH
      obs_stats AS (
        SELECT
          COUNT(*) as total,
          COUNT(CASE WHEN created_at_epoch >= @todayStart THEN 1 END) as today,
          COUNT(CASE WHEN created_at_epoch >= @weekStart THEN 1 END) as this_week,
          COUNT(CASE WHEN is_stale = 1 THEN 1 END) as stale,
          COUNT(CASE WHEN type IN ('constraint', 'decision', 'heuristic', 'rejected') THEN 1 END) as knowledge,
          COALESCE(SUM(discovery_tokens), 0) as discovery_tokens,
          COALESCE(SUM(CAST((LENGTH(COALESCE(title, '')) + LENGTH(COALESCE(narrative, ''))) / 4 AS INTEGER)), 0) as read_tokens
        FROM observations
        ${e?"WHERE project = @project":""}
      ),
      sum_count AS (
        SELECT COUNT(*) as total FROM summaries ${o}
      ),
      sess_count AS (
        SELECT COUNT(*) as total FROM sessions ${o}
      ),
      prompt_count AS (
        SELECT COUNT(*) as total FROM prompts ${o}
      )
    SELECT
      obs_stats.total as observations,
      obs_stats.today as observations_today,
      obs_stats.this_week as observations_this_week,
      obs_stats.stale as stale_count,
      obs_stats.knowledge as knowledge_count,
      obs_stats.discovery_tokens,
      obs_stats.read_tokens,
      sum_count.total as summaries,
      sess_count.total as sessions,
      prompt_count.total as prompts
    FROM obs_stats, sum_count, sess_count, prompt_count
  `,c={"@todayStart":s,"@weekStart":n};e&&(c["@project"]=e);let u=t.query(a).get(c),d=u?.discovery_tokens||0,l=u?.read_tokens||0,m=Math.max(0,d-l),f=d>0?Math.round((1-l/d)*100):0;return{observations:u?.observations||0,summaries:u?.summaries||0,sessions:u?.sessions||0,prompts:u?.prompts||0,observationsToday:u?.observations_today||0,observationsThisWeek:u?.observations_this_week||0,staleCount:u?.stale_count||0,knowledgeCount:u?.knowledge_count||0,tokenEconomics:{discoveryTokens:d,readTokens:l,savings:m,reductionPct:f}}}function Xr(t){let e=fo();return e.get("/api/analytics/overview",(r,s)=>{let{project:n}=r.query;if(n&&!v(n)){s.status(400).json({error:"Invalid project name"});return}try{let o=Gr(t.db.db,n||void 0);s.json(o)}catch(o){p.error("WORKER","Analytics overview failed",{project:n},o),s.status(500).json({error:"Analytics overview failed"})}}),e.get("/api/analytics/timeline",(r,s)=>{let{project:n,days:o}=r.query;if(n&&!v(n)){s.status(400).json({error:"Invalid project name"});return}try{let i=qr(t.db.db,n||void 0,T(o,30,1,365));s.json(i)}catch(i){p.error("WORKER","Analytics timeline failed",{project:n},i),s.status(500).json({error:"Analytics timeline failed"})}}),e.get("/api/analytics/types",(r,s)=>{let{project:n}=r.query;if(n&&!v(n)){s.status(400).json({error:"Invalid project name"});return}try{let o=Wr(t.db.db,n||void 0);s.json(o)}catch(o){p.error("WORKER","Analytics types failed",{project:n},o),s.status(500).json({error:"Analytics types failed"})}}),e.get("/api/analytics/sessions",(r,s)=>{let{project:n}=r.query;if(n&&!v(n)){s.status(400).json({error:"Invalid project name"});return}try{let o=Kr(t.db.db,n||void 0);s.json(o)}catch(o){p.error("WORKER","Analytics sessions failed",{project:n},o),s.status(500).json({error:"Analytics sessions failed"})}}),e}import{Router as go}from"express";function Yr(t){let e=go();return e.get("/api/sessions",(r,s)=>{let{project:n}=r.query;if(n&&!v(n)){s.status(400).json({error:"Invalid project name"});return}try{let o=n?Mr(t.db.db,n,50):Lr(t.db.db,50);s.json(o)}catch(o){p.error("WORKER","Session list failed",{project:n},o),s.status(500).json({error:"Sessions list failed"})}}),e.get("/api/sessions/:id/checkpoint",(r,s)=>{let n=parseInt(r.params.id,10);if(isNaN(n)||n<=0){s.status(400).json({error:"Invalid session ID"});return}try{let o=_t(t.db.db,n);if(!o){s.status(404).json({error:"No checkpoint found for this session"});return}s.json(o)}catch(o){p.error("WORKER","Checkpoint fetch failed",{sessionId:n},o),s.status(500).json({error:"Checkpoint fetch failed"})}}),e.get("/api/checkpoint",(r,s)=>{let{project:n}=r.query;if(!n){s.status(400).json({error:"Project parameter is required"});return}if(!v(n)){s.status(400).json({error:"Invalid project name"});return}try{let o=Tt(t.db.db,n);if(!o){s.status(404).json({error:"No checkpoint found for this project"});return}s.json(o)}catch(o){p.error("WORKER","Project checkpoint fetch failed",{project:n},o),s.status(500).json({error:"Project checkpoint fetch failed"})}}),e.get("/api/prompts",(r,s)=>{let{offset:n,limit:o,project:i}=r.query,a=T(n,0,0,1e6),c=T(o,20,1,200);try{let u=i?"SELECT COUNT(*) as total FROM prompts WHERE project = ?":"SELECT COUNT(*) as total FROM prompts",d=t.db.db.query(u),{total:l}=i?d.get(i):d.get(),m=i?"SELECT * FROM prompts WHERE project = ? ORDER BY created_at_epoch DESC LIMIT ? OFFSET ?":"SELECT * FROM prompts ORDER BY created_at_epoch DESC LIMIT ? OFFSET ?",f=t.db.db.query(m),g=i?f.all(i,c,a):f.all(c,a);s.setHeader("X-Total-Count",l),s.json(g)}catch(u){p.error("WORKER","Prompt list failed",{},u),s.status(500).json({error:"Failed to list prompts"})}}),e}import{Router as ho}from"express";U();function Vr(t){let e=ho();return e.get("/api/projects",(r,s)=>{try{let n=Date.now();if(n-q.ts<xr&&q.data.length>0){s.json(q.data);return}let i=t.db.db.query(`SELECT DISTINCT project FROM (
          SELECT project FROM observations
          UNION
          SELECT project FROM summaries
          UNION
          SELECT project FROM prompts
        ) ORDER BY project ASC`).all();q.data=i.map(a=>a.project),q.ts=n,s.json(q.data)}catch(n){p.error("WORKER","Project list failed",{},n),s.status(500).json({error:"Failed to list projects"})}}),e.get("/api/project-aliases",(r,s)=>{try{let o=t.db.db.query("SELECT project_name, display_name FROM project_aliases").all(),i={};for(let a of o)i[a.project_name]=a.display_name;s.json(i)}catch(n){p.error("WORKER","Alias list failed",{},n),s.status(500).json({error:"Failed to list project aliases"})}}),e.put("/api/project-aliases/:project",(r,s)=>{let{project:n}=r.params,{displayName:o}=r.body;if(!v(n)){s.status(400).json({error:"Invalid project name"});return}if(!o||typeof o!="string"||o.trim().length===0||o.length>100){s.status(400).json({error:'Field "displayName" is required (string, max 100 chars)'});return}try{let i=new Date().toISOString();t.db.db.query(`
        INSERT INTO project_aliases (project_name, display_name, created_at, updated_at)
        VALUES (?, ?, ?, ?)
        ON CONFLICT(project_name) DO UPDATE SET display_name = excluded.display_name, updated_at = excluded.updated_at
      `).run(n,o.trim(),i,i),s.json({ok:!0,project_name:n,display_name:o.trim()})}catch(i){p.error("WORKER","Alias update failed",{project:n},i),s.status(500).json({error:"Failed to update project alias"})}}),e.get("/api/stats/:project",(r,s)=>{let{project:n}=r.params;if(!v(n)){s.status(400).json({error:"Invalid project name"});return}try{let o=ke(t.db.db,n);s.json(o)}catch(o){p.error("WORKER","Stats failed",{project:n},o),s.status(500).json({error:"Stats failed"})}}),e}import{Router as Eo}from"express";function zr(t){let e=[];if(e.push(`# Kiro Memory Report \u2014 ${t.period.label}`),e.push(""),e.push(`**Period**: ${t.period.start} \u2192 ${t.period.end} (${t.period.days} days)`),e.push(""),e.push("## Overview"),e.push(""),e.push("| Metric | Count |"),e.push("|--------|------:|"),e.push(`| Observations | ${t.overview.observations} |`),e.push(`| Summaries | ${t.overview.summaries} |`),e.push(`| Sessions | ${t.overview.sessions} |`),e.push(`| Prompts | ${t.overview.prompts} |`),e.push(`| Knowledge items | ${t.overview.knowledgeCount} |`),t.overview.staleCount>0&&e.push(`| Stale observations | ${t.overview.staleCount} |`),e.push(""),t.sessionStats.total>0){let r=Math.round(t.sessionStats.completed/t.sessionStats.total*100);e.push("## Sessions"),e.push(""),e.push(`- **Total**: ${t.sessionStats.total}`),e.push(`- **Completed**: ${t.sessionStats.completed} (${r}%)`),t.sessionStats.avgDurationMinutes>0&&e.push(`- **Avg duration**: ${t.sessionStats.avgDurationMinutes} min`),e.push("")}if(t.timeline.length>0){e.push("## Activity Timeline"),e.push(""),e.push("| Date | Observations |"),e.push("|------|------------:|");for(let r of t.timeline)e.push(`| ${r.day} | ${r.count} |`);e.push("")}if(t.typeDistribution.length>0){e.push("## Observation Types"),e.push("");for(let r of t.typeDistribution)e.push(`- **${r.type}**: ${r.count}`);e.push("")}if(t.topLearnings.length>0){e.push("## Key Learnings"),e.push("");for(let r of t.topLearnings)e.push(`- ${r}`);e.push("")}if(t.completedTasks.length>0){e.push("## Completed"),e.push("");for(let r of t.completedTasks)e.push(`- ${r}`);e.push("")}if(t.nextSteps.length>0){e.push("## Next Steps"),e.push("");for(let r of t.nextSteps)e.push(`- ${r}`);e.push("")}if(t.fileHotspots.length>0){e.push("## File Hotspots"),e.push(""),e.push("| File | Modifications |"),e.push("|------|-------------:|");for(let r of t.fileHotspots.slice(0,10))e.push(`| \`${r.file}\` | ${r.count} |`);e.push("")}return e.join(`
`)}function Jr(t,e){let r=Eo();function s(n,o,i){if(!e){i();return}if(n.headers["x-worker-token"]!==e){o.status(401).json({error:"Invalid or missing X-Worker-Token"});return}i()}return r.post("/api/embeddings/backfill",s,async(n,o)=>{let{batchSize:i}=n.body||{};try{let c=await H().backfillEmbeddings(t.db.db,T(String(i),50,1,500));o.json({success:!0,generated:c})}catch(a){p.error("WORKER","Backfill embeddings failed",{},a),o.status(500).json({error:"Backfill failed"})}}),r.get("/api/embeddings/stats",(n,o)=>{try{let a=H().getStats(t.db.db),c=F();o.json({...a,provider:c.getProvider(),dimensions:c.getDimensions(),available:c.isAvailable()})}catch(i){p.error("WORKER","Embedding stats failed",{},i),o.status(500).json({error:"Stats failed"})}}),r.post("/api/retention/cleanup",s,(n,o)=>{let{maxAgeDays:i,dryRun:a}=n.body||{},c=T(String(i),90,7,730),u=Date.now()-c*864e5;try{if(a){let m=t.db.db.query("SELECT COUNT(*) as c FROM observations WHERE created_at_epoch < ?").get(u).c,f=t.db.db.query("SELECT COUNT(*) as c FROM summaries WHERE created_at_epoch < ?").get(u).c,g=t.db.db.query("SELECT COUNT(*) as c FROM prompts WHERE created_at_epoch < ?").get(u).c;o.json({dryRun:!0,maxAgeDays:c,wouldDelete:{observations:m,summaries:f,prompts:g}});return}let l=t.db.db.transaction(()=>{t.db.db.run("DELETE FROM observation_embeddings WHERE observation_id IN (SELECT id FROM observations WHERE created_at_epoch < ?)",[u]);let m=t.db.db.run("DELETE FROM observations WHERE created_at_epoch < ?",[u]),f=t.db.db.run("DELETE FROM summaries WHERE created_at_epoch < ?",[u]),g=t.db.db.run("DELETE FROM prompts WHERE created_at_epoch < ?",[u]);return{observations:m.changes,summaries:f.changes,prompts:g.changes}})();t.invalidateProjectsCache(),p.info("WORKER",`Retention cleanup: deleted ${l.observations} obs, ${l.summaries} sum, ${l.prompts} prompts (> ${c}d)`),o.json({success:!0,maxAgeDays:c,deleted:l})}catch(d){p.error("WORKER","Retention cleanup failed",{maxAgeDays:c},d),o.status(500).json({error:"Retention cleanup failed"})}}),r.get("/api/export",(n,o)=>{let{project:i,format:a,type:c,days:u}=n.query;if(i&&!v(i)){o.status(400).json({error:"Invalid project name"});return}let d=T(u,30,1,365),l=Date.now()-d*864e5;try{let m="SELECT * FROM observations WHERE created_at_epoch > ?",f=[l];i&&(m+=" AND project = ?",f.push(i)),c&&(m+=" AND type = ?",f.push(c)),m+=" ORDER BY created_at_epoch DESC LIMIT 1000";let g=t.db.db.query(m).all(...f),h="SELECT * FROM summaries WHERE created_at_epoch > ?",E=[l];i&&(h+=" AND project = ?",E.push(i)),h+=" ORDER BY created_at_epoch DESC LIMIT 100";let R=t.db.db.query(h).all(...E);if(a==="markdown"||a==="md"){let y=["# Kiro Memory Export",`> Project: ${i||"All"} | Period: ${d} days | Generated: ${new Date().toISOString()}`,"",`## Observations (${g.length})`,""];for(let S of g){let K=new Date(S.created_at_epoch).toISOString().split("T")[0];y.push(`### [${S.type}] ${S.title}`),y.push(`- **Date**: ${K} | **Project**: ${S.project} | **ID**: #${S.id}`),S.narrative&&y.push(`- ${S.narrative}`),S.concepts&&y.push(`- **Concepts**: ${S.concepts}`),y.push("")}y.push(`## Summaries (${R.length})`,"");for(let S of R){let K=new Date(S.created_at_epoch).toISOString().split("T")[0];y.push(`### Session ${S.session_id} (${K})`),S.request&&y.push(`- **Request**: ${S.request}`),S.completed&&y.push(`- **Completed**: ${S.completed}`),S.next_steps&&y.push(`- **Next steps**: ${S.next_steps}`),y.push("")}o.type("text/markdown").send(y.join(`
`))}else o.json({meta:{project:i||"all",daysBack:d,exportedAt:new Date().toISOString()},observations:g,summaries:R})}catch(m){p.error("WORKER","Export failed",{project:i,fmt:a},m),o.status(500).json({error:"Export failed"})}}),r.get("/api/report",(n,o)=>{let{project:i,period:a,format:c}=n.query;if(i&&!v(i)){o.status(400).json({error:"Invalid project name"});return}let l=(["weekly","monthly"].includes(a||"")?a:"weekly")==="monthly"?30:7,m=Date.now(),f=m-l*24*60*60*1e3;try{let g=vt(t.db.db,i||void 0,f,m),h=c||"json";h==="markdown"||h==="md"?o.type("text/markdown").send(zr(g)):h==="text"?o.type("text/plain").send(JSON.stringify(g,null,2)):o.json(g)}catch(g){p.error("WORKER","Report generation failed",{project:i,period:a},g),o.status(500).json({error:"Report generation failed"})}}),r}var es=So(vo(import.meta.url)),de=process.env.KIRO_MEMORY_WORKER_PORT||process.env.CONTEXTKIT_WORKER_PORT||3001,Rt=process.env.KIRO_MEMORY_WORKER_HOST||process.env.CONTEXTKIT_WORKER_HOST||"127.0.0.1",le=It(w,"worker.pid"),Ot=It(w,"worker.token");Be(w)||_o(w,{recursive:!0});var Nt=yo.randomBytes(32).toString("hex");Qr(Ot,Nt,"utf-8");try{To(Ot,384)}catch(t){process.platform!=="win32"&&p.warn("WORKER",`chmod 600 failed on ${Ot}`,{},t)}var wt=new V;p.info("WORKER","Database initialized");ie().initialize().catch(t=>{p.warn("WORKER","Embedding initialization failed, FTS5 search only",{},t)});var W=jr(wt),C=Dt();C.use(Gt({contentSecurityPolicy:{directives:{defaultSrc:["'self'"],scriptSrc:["'self'","'unsafe-inline'"],styleSrc:["'self'","'unsafe-inline'","https://fonts.googleapis.com"],imgSrc:["'self'","data:"],connectSrc:["'self'"],fontSrc:["'self'","https://fonts.gstatic.com"],frameSrc:["'none'"]}}}));C.use(bo({origin:[`http://localhost:${de}`,`http://127.0.0.1:${de}`,`http://${Rt}:${de}`],credentials:!0,maxAge:86400}));C.use(Dt.json({limit:"1mb"}));C.use("/api/",Ce({windowMs:6e4,max:200,standardHeaders:!0,legacyHeaders:!1,message:{error:"Too many requests, retry later"}}));C.use(Br(W,Nt));C.use($r(W));C.use(Hr(W));C.use(Ur(W));C.use(Xr(W));C.use(Yr(W));C.use(Vr(W));C.use(Jr(W,Nt));C.use(Dt.static(es,{index:!1,maxAge:"1h"}));C.get("/",(t,e)=>{let r=It(es,"viewer.html");Be(r)?e.sendFile(r):e.status(404).json({error:"Viewer not found. Run npm run build first."})});var Ro=C.listen(Number(de),Rt,()=>{p.info("WORKER",`Kiro Memory worker started on http://${Rt}:${de}`),Qr(le,String(process.pid),"utf-8")});function At(t){p.info("WORKER",`Received ${t}, shutting down...`);let e=ce();for(let s of e)try{s.end()}catch{}let r=setTimeout(()=>{p.warn("WORKER","Forced shutdown after 5s timeout"),Be(le)&&Zr(le),wt.close(),process.exit(1)},5e3);Ro.close(()=>{clearTimeout(r),p.info("WORKER","Server closed"),Be(le)&&Zr(le),wt.close(),process.exit(0)})}process.on("SIGTERM",()=>At("SIGTERM"));process.on("SIGINT",()=>At("SIGINT"));process.on("uncaughtException",t=>{p.error("WORKER","Uncaught exception",{},t),At("uncaughtException")});process.on("unhandledRejection",t=>{p.error("WORKER","Unhandled promise rejection",{reason:t},t)});
//# sourceMappingURL=worker-service.js.map
